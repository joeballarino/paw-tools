<!doctype html>
<html lang="en">
<head>
  <!--
    PAW Embed Guard (required):
    These tool pages are built for Circle embedding.
    If someone opens this page directly (not in an iframe), redirect to proagentworks.com.
    Keep this lightweight; no dependencies.
  -->
  <script>
    (function () {
      try {
        if (window.top === window.self) {
          window.location.replace("https://proagentworks.com");
        }
      } catch (e) {
        // If cross-origin framing prevents access to window.top, fail closed.
        window.location.replace("https://proagentworks.com");
      }
    })();
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assistant</title>

  <!--
    NOTE: paw-ui.css is SHARED across tools.
    Keep header markup consistent:
    panel-topbar > topbar-row0 > tool-head + topbar-right (utility-pair).
    Changing shared classes affects multiple tools.
  -->
  <link rel="stylesheet" href="./paw-ui.css">
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">
          <div class="topbar-row0">
            <div class="tool-head">
                            <div class="tool-subtitle">Quick answers, rewrites, and next steps.</div>
            </div>

            <div class="topbar-right">
              <div class="utility-pair" role="group" aria-label="Tool utilities">
                <button id="reset" class="util-btn" type="button">Reset</button>
                <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
              </div>
            </div>
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="How can I assist you today?"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <img src="https://paw-tools.pages.dev/paw.png" class="send-icon" alt="">
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Resume Draft Modal (Assistant tool) -->
  <div id="pawResumeModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pawResumeTitle">
      <div class="modal-head">
        <div id="pawResumeTitle" class="modal-title">Resume draft?</div>
        <button class="modal-close" id="pawResumeClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body">
        <div id="pawResumeMeta" style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:14px;">
          We found a saved draft on this device.
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button id="pawResumeFresh" class="btn" type="button">Start fresh</button>
          <button id="pawResumeGo" class="btn primary" type="button">Resume</button>
        </div>
      </div>
    </div>
  </div>


  <script src="./tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const DISCLAIMER_TEXT =
        "Important: This assistant provides guidance intended to support your work. It is not brokerage policy guidance, legal advice, and compliance cannot be guaranteed.";

      const DISCLAIMER_TRIGGER =
        /(fair housing|mls|compliance|legal|law|attorney|contract|offer|addendum|inspection|lien|title|short sale|agency|disclosure)/i;

      const TIPS_TEXT =
`How to use this assistant
• Ask questions in plain English
• Paste an email, text, or draft and tell me what you want it to sound like
• Use it to think through next steps, messaging, objections, or client situations
• Use this as a thinking partner — final judgment always stays with you`;

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "assistant",
        inputPlaceholder: "How can I assist you today?",
        tipsText: TIPS_TEXT,

        // One-time compliance note (shown only when trigger words appear in the user message)
        complianceNoteText: DISCLAIMER_TEXT,
        complianceTrigger: DISCLAIMER_TRIGGER,

        sendHistoryItems: 10,
        maxHistoryItems: 20,
        deliverableMode: false
      });

      // ==========================================================
      // Local Save + Resume (Assistant tool)
      // ----------------------------------------------------------
      // Same contract as Listing:
      // - localStorage only, never silent restore
      // - Reset / Start fresh deletes the draft and wipes UI
      // ==========================================================

      const DRAFT_KEY = "paw:assistant:draft:v1";

      // Draft safety caps (localStorage is limited; large pastes can exceed quotas)
      const MAX_DRAFT_INPUT_CHARS = 50000;
      const MAX_DRAFT_HISTORY_ITEMS = 30;
      const MAX_DRAFT_SHELL_INPUT_CHARS = 8000;

      function trunc(s, max){
        s = (s == null) ? "" : String(s);
        if (!max || max <= 0) return "";
        return s.length > max ? s.slice(0, max) : s;
      }


      const $resumeModal = document.getElementById("pawResumeModal");
      const $resumeClose = document.getElementById("pawResumeClose");
      const $resumeMeta = document.getElementById("pawResumeMeta");
      const $resumeFresh = document.getElementById("pawResumeFresh");
      const $resumeGo = document.getElementById("pawResumeGo");

      function storageGet(key){
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (_) { return null; }
      }
      function storageSet(key, val){
        try { localStorage.setItem(key, JSON.stringify(val)); return true; } catch (_) { return false; }
      }
      function storageDel(key){
        try { localStorage.removeItem(key); return true; } catch (_) { return false; }
      }

      let __draftSaveT = null;
      let __draftSaveFailWarned = false; // prevent repeated toasts

      function scheduleDraftSave(){
        try {
          if (__draftSaveT) clearTimeout(__draftSaveT);
          __draftSaveT = setTimeout(saveDraftNow, 350);
        } catch (_) {}
      }

      function saveDraftNow(){
        try {
          const rawShellState = (shell && shell.getState) ? shell.getState() : { history: [], input: "" };
          const st = {
            history: Array.isArray(rawShellState.history) ? rawShellState.history.slice(-MAX_DRAFT_HISTORY_ITEMS) : [],
            input: trunc(rawShellState.input, MAX_DRAFT_SHELL_INPUT_CHARS)
          };
          const hasAny = (st.input && st.input.trim()) || (Array.isArray(st.history) && st.history.length);
          if (!hasAny) { storageDel(DRAFT_KEY); return; }

          const ok = storageSet(DRAFT_KEY, {
            v: 1,
            updatedAt: new Date().toISOString(),
            toolId: "assistant",
            shell: st
          });
          if (!ok && !__draftSaveFailWarned) {
            __draftSaveFailWarned = true;
            try { if (shell && shell.toast) shell.toast("Draft couldn’t be saved on this device/browser."); } catch (_) {}
          }

        } catch (_) {}
      }

      function openResumeModal(draft){
        try {
          if (!$resumeModal) return;
          const d = draft || {};
          const ts = d.updatedAt ? new Date(d.updatedAt) : null;
          const when = ts && !isNaN(ts.getTime()) ? ts.toLocaleString() : "";
          $resumeMeta.textContent = `We found a saved draft on this device.` + (when ? ` Last saved: ${when}.` : "");

          $resumeModal.classList.add("show");
          $resumeModal.setAttribute("aria-hidden", "false");
        } catch (_) {}
      }
      function closeResumeModal(){
        try {
          if (!$resumeModal) return;
          $resumeModal.classList.remove("show");
          $resumeModal.setAttribute("aria-hidden", "true");
        } catch (_) {}
      }

      function fullReset(){
        try { storageDel(DRAFT_KEY); } catch (_) {}
        closeResumeModal();
        try { if (shell && shell.reset) shell.reset(); } catch (_) {}
      }

      // Intercept Reset so we can guarantee draft deletion.
      try {
        const $reset = document.getElementById("reset");
        if ($reset) {
          $reset.addEventListener("click", (e) => {
            try { e.preventDefault(); e.stopImmediatePropagation(); } catch (_) {}
            try {
              const rawShellState = (shell && shell.getState) ? shell.getState() : { history: [], input: "" };
              const hasAny =
                (rawShellState && Array.isArray(rawShellState.history) && rawShellState.history.length) ||
                (rawShellState && typeof rawShellState.input === "string" && rawShellState.input.trim().length);
              if (hasAny) {
                const ok = window.confirm("Reset will clear this session and start fresh. Continue?");
                if (!ok) return;
              }
            } catch (_) {}
            fullReset();
          }, true);
        }
      } catch (_) {}

      // Autosave on composer input changes
      try {
        const $input = document.getElementById("input") || document.getElementById("prompt");
        if ($input) {
          $input.addEventListener("input", scheduleDraftSave);
          $input.addEventListener("change", scheduleDraftSave);
        }
      } catch (_) {}

      window.addEventListener("beforeunload", () => { try { saveDraftNow(); } catch (_) {} });

      // Resume controls
      try { if ($resumeClose) $resumeClose.addEventListener("click", () => closeResumeModal()); } catch (_) {}
      try {
        if ($resumeModal) $resumeModal.addEventListener("click", (e) => { if (e.target === $resumeModal) closeResumeModal(); });
      } catch (_) {}
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") { closeResumeModal(); } });

      try {
        if ($resumeFresh) $resumeFresh.addEventListener("click", () => {
          closeResumeModal();
          fullReset();
        });
      } catch (_) {}

      try {
        if ($resumeGo) $resumeGo.addEventListener("click", () => {
          const d = storageGet(DRAFT_KEY);
          closeResumeModal();
          if (d && d.shell && shell && shell.setState) shell.setState(d.shell);
        });
      } catch (_) {}

      // On load: show resume prompt (never silent restore)
      const existingDraft = storageGet(DRAFT_KEY);
      if (existingDraft) openResumeModal(existingDraft);

    })();
  </script>
</body>
</html>
