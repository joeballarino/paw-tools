<!doctype html>
<html lang="en">
<head>
  <!--
    PAW Embed Guard (required):
    These tool pages are built for Circle embedding.
    If someone opens this page directly (not in an iframe), redirect to proagentworks.com.
    Keep this lightweight; no dependencies.
  -->
  <script>
    (function () {
      try {
        if (window.top === window.self) {
          window.location.replace("https://proagentworks.com");
        }
      } catch (e) {
        // If cross-origin framing prevents access to window.top, fail closed.
        window.location.replace("https://proagentworks.com");
      }
    })();
  </script>

  <script>
    // PAW Embed Mode Guard
    // -------------------
    // Circle provides the outer card. The embedded tool must render "flat".
    // We rely on paw-ui.css rules that activate when html[data-embed="1"] is present.
    // tool-shell.js will set this when initialized, but Contracts UI should not
    // depend on shell init (or any later script) to render correctly.
    (function(){
      try{
        var params = new URLSearchParams(window.location.search);
        var isEmbedParam = params.get('embed') === '1';
        var isInIframe = (function(){ try{ return window.self !== window.top; } catch(e){ return true; } })();
        if(isEmbedParam || isInIframe){
          document.documentElement.setAttribute('data-embed','1');
        }
      }catch(e){}
    })();
  </script>


  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contracts</title>

  <!--
    NOTE: paw-ui.css is SHARED across tools.

    DOUBLE CONTAINER FIX (important):
    - Embed mode styling is activated by tool-shell.js (sets html[data-embed="1"]).
    - If this page forgets to include tool-shell.js, the panel gets its own border/shadow inside Circle,
      which looks like a “double container”. Keep tool-shell.js included for consistent embed rendering.
    Keep header markup consistent:
    panel-topbar > topbar-row0 > tool-subtitle + topbar-right (utility-pair).
    Changing shared classes affects multiple tools.
  -->
  <link rel="stylesheet" href="./paw-ui.css">

  <style>
    /* ==========================================================
       PAW — Contracts (Circle-embedded tool page)
       ----------------------------------------------------------
       DESIGN GOALS (v1):
       - Chat-first (works with or without a document)
       - Optional contract upload (PDF) for more precise analysis
       - Contract review selector (Blank / Draft / Executed) sets tone and output style
       - Scanned PDFs are NOT supported (we reject and ask for a digital PDF)

       IMPORTANT PRODUCT RULES:
       - No AI logic lives here. All "secret sauce" prompting is in the Worker.
       - Do NOT store uploaded contracts in localStorage.
         We only store chat history + contract type selection as a local draft (optional).
       ========================================================== */

    body.paw-contracts .contracts-controls{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:10px 14px 12px;
      border-bottom:none; /* removed: line between upload + chat */
      background:transparent;
    }


    /* Contracts-only: When there are no messages yet, collapse the empty message area
       so the composer (input box) sits directly under the upload controls. */
    body.paw-contracts #messages:empty{
      display:none;
    }

    body.paw-contracts .contracts-row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:12px;
    }

    body.paw-contracts .contracts-row--meta{
      min-height:18px; /* reserved blank row for file details */
    }


    body.paw-contracts .contracts-block{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 220px;
    }

    body.paw-contracts .contracts-label{
      font-size:12px;
      font-weight:800;
      color:rgba(15,23,42,.72);
      letter-spacing:-0.01em;
    }

    /* Stage segmented control (scoped to Contracts only) */
    body.paw-contracts .stage-seg,
    body.paw-contracts .type-seg{
      display:flex;
      align-items:center;
      gap:0;
      border:1px solid rgba(15,23,42,.12);
      background:rgba(255,255,255,.86);
      border-radius:999px;
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      width: fit-content;
    }
    body.paw-contracts .stage-btn,
    body.paw-contracts .type-btn{
      height:32px;
      padding:0 14px;
      border:0;
      background:transparent;
      color:rgba(15,23,42,.78);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: background .15s ease, color .15s ease;
    }
    body.paw-contracts .stage-btn:hover{ background:rgba(15,23,42,.05); }
    body.paw-contracts .stage-btn + .stage-btn{ border-left:1px solid rgba(15,23,42,.10); }
    body.paw-contracts .type-btn + .type-btn{ border-left:1px solid rgba(15,23,42,.10); }
    body.paw-contracts .stage-btn.primary,
    body.paw-contracts .type-btn.primary{
      background: rgba(5,195,249,.18);
      color: rgba(15,23,42,.92);
    }

    /* Upload row */
    body.paw-contracts .upload-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    body.paw-contracts .file-pill{
      position:relative;
      display:inline-flex;
      align-items:center;
      gap:10px;
      height:34px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid var(--field-border);
      background:rgba(255,255,255,.92);
      font-weight:800;
      font-size:13px;
      color:var(--text-strong);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
    }
    body.paw-contracts .file-pill input[type="file"]{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
      width:100%;
      height:100%;
    }
    body.paw-contracts .file-name{
      font-size:13px;
      font-weight:750;
      color:rgba(15,23,42,.82);
      max-width: 360px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    body.paw-contracts .file-sub{
      font-size:12px;
      color:rgba(15,23,42,.60);
      line-height:1.2;
    }

    body.paw-contracts .file-hint{
      font-size:12px;
      color:rgba(15,23,42,.65);
      white-space:nowrap;
    }

    body.paw-contracts .mini-btn{
      height:34px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      background:rgba(255,255,255,.92);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .06s ease;
    }
    body.paw-contracts .mini-btn:hover{ background:#fff; border-color: rgba(15,23,42,.18); }
    body.paw-contracts .mini-btn:active{ transform: translateY(1px); }
    body.paw-contracts .mini-btn.primary{
      border-color: rgba(5,195,249,.55);
      background: rgba(5,195,249,.16);
      color: rgba(15,23,42,.92);
    }

    /* Mobile: stack nicely */
    @media (max-width: 560px){
      body.paw-contracts .contracts-controls{
        flex-direction:column;
        align-items:stretch;
      }
      body.paw-contracts .contracts-block{ min-width: 0; width:100%; }
      body.paw-contracts .stage-seg,
    body.paw-contracts .type-seg{ width:100%; }
      body.paw-contracts .stage-btn,
    body.paw-contracts .type-btn{ flex:1 1 0; }
      body.paw-contracts .upload-row{ width:100%; }
      body.paw-contracts .file-pill{ width:100%; justify-content:center; }
      body.paw-contracts .mini-btn{ width:100%; }
      body.paw-contracts .file-name{ max-width: 100%; }
    }
  
    /* Extra breathing room between Contract Review and Contract Upload */
    body.paw-contracts .contracts-controls > .contracts-row:first-of-type{
      margin-bottom: 18px;
    }

  </style>
</head>

<body class="paw-contracts">
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">
          <div class="topbar-row0">
            <div class="tool-subtitle">Understand contracts, summarize key terms, and talk through negotiation scenarios.</div>

            <div class="topbar-right">
              <div class="utility-pair paw-seg" role="group" aria-label="Tool utilities">
                <button id="reset" class="util-btn paw-seg__btn" type="button">Reset</button>
                <button id="tips" class="util-btn paw-seg__btn" type="button">Tips &amp; How To</button>
              </div>
            </div>
          </div>

                    <!-- Controls: Contract Review + Upload (optional) -->
          <div class="contracts-controls" aria-label="Contracts controls">

            <!-- Row A: Contract Review -->
            <div class="contracts-row" aria-label="Contract review row">
              <div class="contracts-label">Contract Review:</div>
              <div class="type-seg" role="group" aria-label="Contract review">
                <button class="type-btn" type="button" data-review="blank" aria-pressed="false">Blank</button>
                <button class="type-btn" type="button" data-review="draft" aria-pressed="false">Draft</button>
                <button class="type-btn primary" type="button" data-review="executed" aria-pressed="true">Executed</button>
              </div>
            </div>

            <!-- Row B: Contract Upload -->
            <div class="contracts-row" aria-label="Contract upload row">
              <div class="contracts-label">Contract Upload:</div>
              <div class="upload-row" style="flex:1 1 420px;">
                <div class="file-pill" title="Choose a PDF file">
                  <label class="file-pill__label" for="file">Choose PDF…</label>
                  <input id="file" type="file" accept="application/pdf" />
                </div>
                <div class="file-hint">Digitally generated PDFs only</div>
              </div>
            </div>

            <!-- Row C: Reserved space for upload details (populates after file selection) -->
            <div id="fileMetaRow" class="contracts-row contracts-row--meta" aria-label="Upload details row">
              <div id="fileName" class="file-name" aria-live="polite"></div>
            </div>

          </div>

        <div id="messages" class="messages" aria-live="polite"></div>

        <div class="composer">
          <textarea id="input" placeholder="Ask a question about a contract or talk through a negotiation scenario…"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <img src="https://paw-tools.pages.dev/paw.png" class="send-icon" alt="">
          </button>
        </div>

      </div>
    </div>
  </div>

  <script src="./tool-shell.js"></script>

  <script>
    /**
     * PAW Contracts (Circle-embedded tool page)
     * ------------------------------------------------------------
     * This file provides:
     *  - Chat UI (always available)
     *  - Optional PDF upload + Analyze action (sends file to Worker)
     *  - Contract review selector (Blank/Draft/Executed) that labels the user's intent
     *
     * IMPORTANT:
     *  - This page DOES NOT attempt OCR or PDF text extraction.
     *    The Worker will validate whether the PDF is digitally generated.
     *    If the Worker indicates "scanned", this UI rejects the file and asks the
     *    user to upload a digital PDF (DocuSign/Dotloop/SkySlope, etc.).
     *
     * PRIVACY / STORAGE (locked):
     *  - We do NOT store uploaded contract bytes in localStorage.
     *  - We only store chat history + the selected contract review mode as a local draft.
     */
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      // Upload constraints (v1)
      const MAX_FILE_MB = 10;              // hard cap to prevent accidental giant files
      const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

      // NOTE: Page limits are enforced in the Worker (it can reliably count pages after parsing).
      // We keep the UI copy minimal and let the Worker return a friendly message if the page
      // count is too high.

      const TIPS_TEXT =
`What you can do here
• Upload a contract to get a clear summary, key terms, and important dates
• Ask questions about specific clauses or timelines
• Talk through negotiation scenarios with or without a document

Contract review modes
• Blank: Learn what the form does and what fields matter
• Draft: Confirm what’s filled in before sharing with a client
• Executed: Create a client-ready summary and timeline from what’s signed

File uploads
• Use digitally generated PDFs (DocuSign, Dotloop, SkySlope, etc.)
• Scanned or photographed documents aren’t supported
• Files are processed and discarded after analysis

Good to know
• PAW explains what’s written — it doesn’t provide legal advice
• Always confirm final decisions with your broker or attorney`;


      // ------------------------------------------------------------
      // Local draft (chat only) — same "never silent restore" pattern
      // ------------------------------------------------------------
      const DRAFT_KEY = "paw:contracts:draft:v1";
      const MAX_DRAFT_HISTORY_ITEMS = 30;
      const MAX_DRAFT_SHELL_INPUT_CHARS = 8000;

      function trunc(s, max){
        s = (s == null) ? "" : String(s);
        if (!max || max <= 0) return "";
        return s.length > max ? s.slice(0, max) : s;
      }
      function storageGet(key){
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (_) { return null; }
      }
      function storageSet(key, val){
        try { localStorage.setItem(key, JSON.stringify(val)); return true; } catch (_) { return false; }
      }
      function storageDel(key){
        try { localStorage.removeItem(key); return true; } catch (_) { return false; }
      }

      // Contract Review state (default Executed)
      const reviewState = { mode: "executed" }; // blank | draft | executed

      const $file = document.getElementById("file");
      const $fileName = document.getElementById("fileName");
      const reviewBtns = Array.from(document.querySelectorAll(".type-btn"));

      let currentFile = null;

      // Optional session handle returned by the Worker after Analyze
      // (Worker can use this to keep contract context without resending the file.)
      let contractSessionId = "";

      function setContractReview(next){
        reviewState.mode = next;
        reviewBtns.forEach(btn => {
          const on = btn.dataset.review === next;
          btn.classList.toggle("primary", on);
          btn.setAttribute("aria-pressed", on ? "true" : "false");
        });
      }

      reviewBtns.forEach(btn => {
        btn.addEventListener("click", () => setContractReview(btn.dataset.review || "executed"));
      });

      function setFileUI(file, status){
        // status: "", "analyzing", "ready"
        // NOTE: Row C ("Upload details") stays blank until a file is selected.
        if (!file) {
          $fileName.textContent = "";
          $fileName.style.opacity = "1";
          return;
        }

        const kb = Math.ceil(file.size / 1024);
        const base = file.name + " (" + kb + " KB)";
        if (status === "analyzing") {
          $fileName.textContent = "Analyzing… " + base;
        } else {
          $fileName.textContent = base;
        }
        $fileName.style.opacity = "1";
      }


function clearFile(){
        currentFile = null;
        contractSessionId = ""; // new upload resets context
        try { if ($file) $file.value = ""; } catch (_) {}
        setFileUI(null);
      }

      // File selection
      if ($file) {
        $file.addEventListener("change", () => {
          const f = ($file.files && $file.files[0]) ? $file.files[0] : null;
          if (!f) { clearFile(); return; }

          if (f.type !== "application/pdf") {
            clearFile();
            try { if (shell && shell.toast) shell.toast("Please upload a PDF."); } catch (_) {}
            return;
          }

          if (f.size > MAX_FILE_BYTES) {
            clearFile();
            try { if (shell && shell.toast) shell.toast("File is too large. Please upload a smaller PDF (max " + MAX_FILE_MB + "MB)."); } catch (_) {}
            return;
          }

          currentFile = f;
          setFileUI(f, "analyzing");
          void analyzeSelectedFile();
        });
      }

      // Helper: read file as base64 (without data: prefix)
      function readFileAsBase64(file){
        return new Promise((resolve, reject) => {
          try{
            const reader = new FileReader();
            reader.onload = () => {
              try{
                const result = String(reader.result || "");
                // result is a data URL: "data:application/pdf;base64,...."
                const comma = result.indexOf(",");
                resolve(comma >= 0 ? result.slice(comma + 1) : result);
              }catch(e){ reject(e); }
            };
            reader.onerror = () => reject(reader.error || new Error("File read failed"));
            reader.readAsDataURL(file);
          }catch(e){ reject(e); }
        });
      }


// Auto-analyze on upload (single-file workflow)
async function analyzeSelectedFile(){
  if (!currentFile) return;
  try{
    // UI: show progress
    setFileUI(currentFile, "analyzing");
    try { if (shell && shell.toast) shell.toast("Analyzing contract…"); } catch (_) {}

    const b64 = await readFileAsBase64(currentFile);

    // NOTE: The Worker must:
    // - validate PDF is not scanned (reject if scanned)
    // - enforce page limits
    // - create/return contract_session_id for ongoing chat context
    //
    // We send file bytes ONLY for the initial analysis. Follow-up chat should use session_id.
    await shell.sendExtra(
      "Analyze this contract.",
      {
        action: "contract_upload",
        contract_review: reviewState.mode,
        file: {
          name: currentFile.name,
          type: currentFile.type,
          size: currentFile.size,
          base64: b64
        },
        contract_session_id: contractSessionId || ""
      },
      { echoUser: false }
    );

    setFileUI(currentFile, "ready");
  }catch(e){
    // Keep this generic so we don't leak backend details in UI.
    try { if (shell && shell.toast) shell.toast("Couldn’t analyze that file. Please upload a digitally generated PDF."); } catch (_) {}
    clearFile();
  }
}


      // Init tool shell
      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "contracts",
        inputPlaceholder: "Ask a question about a contract or talk through a negotiation scenario…",
        tipsText: TIPS_TEXT,

        // Contracts behaves like Assistant (chat-first), not a deliverable modal.
        deliverableMode: false,

        // Preferences always sent (Worker decides how to use them)
        getPrefs: () => ({
          contract_review: reviewState.mode,
          contract_session_id: contractSessionId ? contractSessionId : "",
          has_contract_context: !!contractSessionId
        }),

        // Extra payload included on each user message (lightweight)
        getExtraPayload: () => ({
          contract_session_id: contractSessionId ? contractSessionId : ""
        }),

        // Interpret special Worker responses for contract uploads:
        // - Worker may return:
        //   { reply: "...", contract: { session_id:"...", scanned:true/false, pages:12 } }
        onResponse: (data) => {
          try{
            const c = data && data.contract ? data.contract : null;
            if (c && typeof c === "object") {
              // If Worker flags scanned, reject and clear the selected file.
              if (c.scanned === true) {
                clearFile();
                try { if (shell && shell.toast) shell.toast("Scanned PDF detected. Please upload a digitally generated PDF (DocuSign/Dotloop/SkySlope)."); } catch (_) {}
              }

              // Capture session id if provided.
              if (c.session_id) {
                contractSessionId = String(c.session_id || "");
                // Nudge the chat placeholder after analysis so it feels contextual.
                try{
                  const $input = document.getElementById("input");
                  if ($input) $input.placeholder = "Ask about timelines, contingencies, or next steps…";
                }catch(_){}
              }
            }
          }catch(_){}
        }
      });
      // Reset should clear file + local draft (but keep shell reset behavior)
      function fullReset(){
        try { storageDel(DRAFT_KEY); } catch (_) {}
        clearFile();
        setContractReview("executed");
        try { if (shell && shell.reset) shell.reset(); } catch (_) {}
        try{
          const $input = document.getElementById("input");
          if ($input) $input.placeholder = "Ask a question about a contract or talk through a negotiation scenario…";
        }catch(_){}
      }

      // Intercept Reset so we can confirm and clear draft+file.
      try {
        const $reset = document.getElementById("reset");
        if ($reset) {
          $reset.addEventListener("click", (e) => {
            try { e.preventDefault(); e.stopImmediatePropagation(); } catch (_) {}
            try {
              const rawShellState = (shell && shell.getState) ? shell.getState() : { history: [], input: "" };
              const hasAny =
                (rawShellState && Array.isArray(rawShellState.history) && rawShellState.history.length) ||
                (rawShellState && typeof rawShellState.input === "string" && rawShellState.input.trim().length) ||
                !!currentFile ||
                !!contractSessionId;

              if (hasAny) {
                const ok = window.confirm("Reset will clear this session and start fresh. Continue?");
                if (!ok) return;
              }
            } catch (_) {}
            fullReset();
          }, true);
        }
      } catch (_) {}

      // -------------------------
      // Draft autosave (chat only)
      // -------------------------
      let __draftSaveT = null;
      function scheduleDraftSave(){
        try {
          if (__draftSaveT) clearTimeout(__draftSaveT);
          __draftSaveT = setTimeout(saveDraftNow, 350);
        } catch (_) {}
      }

      function saveDraftNow(){
        try {
          const rawShellState = (shell && shell.getState) ? shell.getState() : { history: [], input: "" };
          const st = {
            history: Array.isArray(rawShellState.history) ? rawShellState.history.slice(-MAX_DRAFT_HISTORY_ITEMS) : [],
            input: trunc(rawShellState.input, MAX_DRAFT_SHELL_INPUT_CHARS)
          };

          const hasAny = (st.input && st.input.trim()) || (Array.isArray(st.history) && st.history.length);
          if (!hasAny) { storageDel(DRAFT_KEY); return; }

          storageSet(DRAFT_KEY, {
            v: 1,
            updatedAt: new Date().toISOString(),
            toolId: "contracts",
            contract_review: reviewState.mode,
            shell: st
          });
        } catch (_) {}
      }

      // Autosave on composer input
      try {
        const $input = document.getElementById("input");
        if ($input) {
          $input.addEventListener("input", scheduleDraftSave);
          $input.addEventListener("change", scheduleDraftSave);
        }
      } catch (_) {}
      window.addEventListener("beforeunload", () => { try { saveDraftNow(); } catch (_) {} });

      // Resume prompt (simple confirm, no modal)
      const existing = storageGet(DRAFT_KEY);
      if (existing && existing.shell) {
        const ok = window.confirm("Resume your previous Contracts session on this device?");
        if (ok) {
          try {
            // Restore contract type + chat draft (never restore uploaded files)
            setContractReview(existing.contract_review || "executed");
            if (shell && shell.setState) shell.setState(existing.shell);
          } catch (_) {}
        } else {
          try { storageDel(DRAFT_KEY); } catch (_) {}
        }
      }

    })();
  </script>
</body>
</html>
