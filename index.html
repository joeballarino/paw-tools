<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="/paw-ui.css">
  <!--
    HEADER CONTRACT (LOCKED):
    - The panel top bar (.topbar-row0) MUST NEVER include a title.
    - It only contains: subtitle (left) + Reset/Tips buttons (right).
  -->
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">

          <div class="topbar-row0">
            <div class="tool-subtitle">MLS-ready listing remarks with built-in real estate expertise.</div>

            <div class="topbar-right">
              <button id="reset" class="util-btn" type="button">Reset</button>
              <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
            </div>
          </div>

          <div class="controls-row">
            <div class="ctl">
              <label for="typeSel">Type</label>
              <span class="select-wrap">
                <select id="typeSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="starter">Starter</option>
                  <option value="moveup">Move-Up</option>
                  <option value="luxury">Luxury</option>
                  <option value="investor">Investor</option>
                  <option value="relocation">Relocation</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="toneSel">Tone</label>
              <span class="select-wrap">
                <select id="toneSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="professional">Professional</option>
                  <option value="warm">Warm</option>
                  <option value="elevated">Elevated</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="lenSel">Length</label>
              <span class="select-wrap">
                <select id="lenSel">
                  <option value="" selected>Choose…</option>
                  <option value="standard">Standard</option>
                  <option value="short">Short</option>
                  <option value="long">Long</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="cityInp">City</label>
              <span class="input-wrap md">
                <input id="cityInp" type="text" placeholder="City" autocomplete="address-level2" />
              </span>
            </div>

            <div class="ctl">
              <label for="stateSel">State</label>
              <span class="select-wrap sm">
                <select id="stateSel" autocomplete="address-level1">
                  <option value="" selected>ST</option>
                  <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option><option value="CA">CA</option>
                  <option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option><option value="DC">DC</option><option value="FL">FL</option>
                  <option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option>
                  <option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option>
                  <option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                  <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option>
                  <option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option>
                  <option value="OH">OH</option><option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
                  <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                  <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option><option value="WI">WI</option>
                  <option value="WY">WY</option>
                </select>
              </span>
            </div>
          </div>

          <div class="topbar-row2">

            <div class="lock-grid">
              <div class="field">
                <label for="bedsSel">Beds</label>
                <select id="bedsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">5+</option>
                </select>
              </div>

              <div class="field">
                <label for="bathsSel">Baths</label>
                <select id="bathsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option><option value="2.5">2.5</option><option value="3+">3+</option>
                </select>
              </div>

              <div class="field">
                <label for="sqftInp">Sqft</label>
                <input id="sqftInp" type="text" inputmode="numeric" placeholder="e.g. 1800" />
              </div>

              <div class="field">
                <label for="priceInp">Price</label>
                <input id="priceInp" type="text" placeholder="for context only" />
              </div>

              <div class="field">
                <label for="poolSel">Pool</label>
                <select id="poolSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="field">
                <label for="porchSel">Porch</label>
                <select id="porchSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div class="lock-row2">
              <label class="field" style="width:100%;">
                <div class="field-label" style="font-size:12px; font-weight:700; color:rgba(15,23,42,.82); margin-bottom:8px; letter-spacing:-0.01em;">Most Compelling Feature</div>
                <input id="compellingInp" class="big-input" type="text" placeholder="Location, design, lifestyle, value, etc." />
              </label>
            </div>

          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="Add upgrades, finishes, neighborhood notes, disclosures, HOA details, or paste listing data here"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Local Highlights Modal -->
  <div id="localModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="localModalTitle">
      <div class="modal-head">
        <div id="localModalTitle" class="modal-title">Possible nearby highlights (optional)</div>
        <button class="modal-close" id="localModalClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body">
        <div style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:10px;">
          We found nearby places that <b>may or may not apply</b> to this listing. Select only what you know is accurate.
          <b>Nothing is added unless you choose it.</b>
        </div>
        <div id="localModalListWrap"></div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <button id="localModalSkip" class="btn" type="button">Keep as-is</button>
          <button id="localModalApply" class="btn primary" type="button">Update description</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const TIPS_TEXT =
`What this tool does
• Generates MLS-ready listing remarks that are accurate, motivating, and Fair Housing–safe.

How to use it
• Add any details above and/or paste notes/MLS data — messy is fine
• Include city & state when you can (helps local context)
• If something is unknown, leave it blank (or type “unknown”) and the tool will write conservatively
• You can always refine the output after it generates`;

      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $len  = document.getElementById("lenSel");
      const $city = document.getElementById("cityInp");
      const $state = document.getElementById("stateSel");

      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");
      const $input = document.getElementById("input");

      // Local highlights modal elements
      const $localModal = document.getElementById("localModal");
      const $localModalClose = document.getElementById("localModalClose");
      const $localModalSkip = document.getElementById("localModalSkip");
      const $localModalApply = document.getElementById("localModalApply");
      const $localModalListWrap = document.getElementById("localModalListWrap");

      const HIGHLIGHTS_TOKEN = "__PAW_HIGHLIGHTS__";

      let pendingHighlightsOffer = false;
      let cachedHighlights = []; // {id,label}
      // Prevent repeat highlights modal for same location unless city/state meaningfully changes
      let highlightsOfferedKey = "";
      let highlightsAppliedKey = "";
      let suppressHighlightsOfferOnce = false;

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ const t = normText(v); return t ? t : ""; }

      function mapType(v){ return normText(v) || "general"; }
      function mapTone(v){ return normText(v) || "general"; }
      function mapLen(v){ return normText(v) || "standard"; }

      function cityVal(){ return normText($city.value); }
      function stateVal(){ return normText($state.value).toUpperCase(); }
      function locKey(){
        const c = cityVal().toLowerCase();
        const s = stateVal().toLowerCase();
        if (!c || !s) return "";
        return `${c}|${s}`;
      }
      function locationVal(){
        const c = cityVal(), s = stateVal();
        if (c && s) return `${c}, ${s}`;
        if (s) return s;
        return c;
      }

      function escapeHtml(str){
        return String(str || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      function coerceHighlightLabel(item){
        if (item == null) return "";
        if (typeof item === "string") return item.trim();
        if (typeof item === "number") return String(item);
        if (typeof item === "object") {
          return String(item.label || item.name || item.title || item.text || item.value || "").trim();
        }
        return String(item).trim();
      }

      function isBadHighlightLabel(label){
        const t = String(label || "").toLowerCase();
        return (
          !t ||
          t.includes("please provide") ||
          t.includes("city/state") ||
          t.includes("zip code") ||
          (t.includes("zip") && t.includes("provide"))
        );
      }

      function looksLikeDeliverableText(reply){
        const r = String(reply || "").trim();
        if (!r) return false;
        if ((r.match(/\?/g) || []).length >= 1) return false;
        if (/^(one|a couple|a few)\s+quick\s+(question|questions|clarifiers)\b/i.test(r)) return false;
        return r.length >= 240;
      }

      function openLocalModal(highlights){
        cachedHighlights = highlights.slice(0, 5);

        // None selected by default
        let html = '<div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">';
        cachedHighlights.forEach((h, idx) => {
          const id = `lh_pick_${idx}`;
          html += `
            <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
              <input id="${id}" type="checkbox" style="margin-top:2px;" />
              <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">${escapeHtml(h.label)}</span>
            </label>
          `;
        });

        // 6th option: custom highlight the agent can type in
        html += `
          <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
            <input id="lh_custom_check" type="checkbox" style="margin-top:2px;" />
            <span style="display:flex; flex-direction:column; gap:6px; width:100%;">
              <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">Custom highlight</span>
              <input id="lh_custom_text" type="text" placeholder="Type your own (e.g., 'Walk to Riverside Park')" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.12); border-radius:10px; font-size:14px;" />
            </span>
          </label>
        `;

        html += '</div>';
        $localModalListWrap.innerHTML = html;

        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }

      function closeLocalModal(){
        $localModal.classList.remove("show");
        $localModal.setAttribute("aria-hidden", "true");
        $localModalListWrap.innerHTML = "";
      }

      function getModalSelections(){
        const selected = [];
        cachedHighlights.forEach((h, idx) => {
          const cb = document.getElementById(`lh_pick_${idx}`);
          if (cb && cb.checked) selected.push(h.label);
        });

        // Custom highlight (optional)
        const customCheck = document.getElementById("lh_custom_check");
        const customTextEl = document.getElementById("lh_custom_text");
        const customText = customTextEl ? normText(customTextEl.value) : "";
        if (customCheck && customCheck.checked && customText) {
          selected.push(customText);
        }

        return selected;
      }

      async function fetchHighlightsInBackground(){
        const c = cityVal();
        const s = stateVal();
        if (!c || !s) return;
        await shell.sendExtra(HIGHLIGHTS_TOKEN, {}, { echoUser: false });
      }

      // Modal controls
      $localModalClose.addEventListener("click", closeLocalModal);
      $localModal.addEventListener("click", (e) => { if (e.target === $localModal) closeLocalModal(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLocalModal(); });
      $localModalSkip.addEventListener("click", closeLocalModal);

      $localModalApply.addEventListener("click", async () => {
        const picked = getModalSelections();
        closeLocalModal();
        if (!picked.length) return;
        // Agent has applied highlights for this location; do not re-offer.
        highlightsAppliedKey = locKey();
        suppressHighlightsOfferOnce = true;

        const instruction =
`Update the MLS description above.
Only incorporate the selected nearby highlights if the agent confirms they are accurate and if they improve specificity.
Replace generic filler lines first. Do not add fluff. Keep the overall length similar.

Selected highlights:
- ${picked.join("\n- ")}`;

        await shell.sendExtra(instruction, { phase: "write", selected_highlights: picked }, { echoUser: true });
      });

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        tipsText: TIPS_TEXT,
        deliverableTitle: "Your MLS Description",

        getPrefs: () => ({
          listing_type: mapType($type.value),
          output_use: "MLS",
          tone: mapTone($tone.value),
          length: mapLen($len.value),
          safe_mode: true,
          ask_followups: false,

          city: cityVal(),
          state: stateVal(),
          location: locationVal(),

          // allow worker to know local context exists
          local_highlights: (!!cityVal() && !!stateVal()),

          compelling_feature: normText($compelling.value),

          locked: {
            beds: normEnum($beds.value),
            baths: normEnum($baths.value),
            sqft: digitsOnly($sqft.value),
            price: normText($price.value),
            pool: normEnum($pool.value),
            porch: normEnum($porch.value)
          }
        }),

        // ✅ KEY FIX: this runs on every submit, so we can arm the offer reliably.
        getExtraPayload: (text) => {
          const base = { city: cityVal(), state: stateVal(), location: locationVal() };
          const key = locKey();

          // Background highlights fetch token
          if (String(text).trim() === HIGHLIGHTS_TOKEN) {
            if (!base.city || !base.state) return base;
            return Object.assign({}, base, { phase: "highlights" });
          }

          // Normal user submit: arm the offer if we have city/state.
          // The modal is never blocking the initial generation.
          pendingHighlightsOffer = !!(key && key !== highlightsOfferedKey && key !== highlightsAppliedKey && !suppressHighlightsOfferOnce);
          suppressHighlightsOfferOnce = false;

          return base;
        },

        onResponse: (data) => {
          const reply = data && typeof data.reply === "string" ? data.reply : "";

          // After the deliverable is produced, kick off background highlights fetch
          if (pendingHighlightsOffer && looksLikeDeliverableText(reply)) {
            pendingHighlightsOffer = false;
            highlightsOfferedKey = locKey();
            fetchHighlightsInBackground(); // async, no block
            return; // allow shell to render deliverable
          }

          // Handle highlights response
          const highlightsRaw = data && data.local && Array.isArray(data.local.highlights) ? data.local.highlights : null;
          if (highlightsRaw && highlightsRaw.length) {
            const normalized = highlightsRaw
              .map((it, i) => ({ id: String((it && typeof it === "object" && (it.id || it.key)) ? (it.id || it.key) : (i+1)), label: coerceHighlightLabel(it) }))
              .filter(x => x.label && !isBadHighlightLabel(x.label));

            const key = locKey();
            if (normalized.length && key && key === highlightsOfferedKey && key !== highlightsAppliedKey) {
              openLocalModal(normalized);
            }
            return { skipDefault: true };
          }

          // Ignore any “provide city/state or zip” prompt silently
          const lower = reply.toLowerCase();
          if (lower.includes("provide") && (lower.includes("city/state") || lower.includes("zip"))) {
            return { skipDefault: true };
          }
        }
      });

      // Reset
      document.getElementById("reset").addEventListener("click", () => {
        pendingHighlightsOffer = false;
        cachedHighlights = [];
        highlightsOfferedKey = "";
        highlightsAppliedKey = "";
        suppressHighlightsOfferOnce = false;
        closeLocalModal();
        try { $city.value = ""; $state.value = ""; } catch {}
        try { if (shell && shell.reset) shell.reset(); } catch {}
      });

    })();
  </script>
</body>
</html>
