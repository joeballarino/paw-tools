<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connect</title>

  <!--
    ProAgent Works — Connect (Circle Embed Tool)
    -------------------------------------------
    PURPOSE:
    - UI scaffold for the Connect communication tool (Email/Text + reusable templates).
    - This file intentionally ships UI first so it can be reviewed inside Circle before
      wiring requests to the Cloudflare Worker.

    CRITICAL PRODUCT RULES:
    - Circle owns the tool title (H1). This embedded tool MUST NOT render its own title.
    - The top bar row (.topbar-row0) contains:
        * a single short description (left)
        * Reset + Tips & How To buttons (right)
      ...and NOTHING ELSE.
    - Embed mode / “no double container” rule:
        * When ?embed=1 is present OR the page is inside an iframe,
          we set html[data-embed="1"].
        * paw-ui.css flattens .panel in embed mode so Circle provides the outer card.

    NOTE FOR FUTURE WIRING:
    - NO AI logic lives in this file. All prompting + generation lives in the Worker.
    - Once wiring begins, we can either:
        A) Use PAWToolShell.init(...) like listing.html/ask.html, OR
        B) Keep custom handlers but still reuse shell helpers (draft, reset, toast).
      For now, Generate is a harmless local stub message.
  -->

  <script>
    // Embed flattening MUST happen even if we don't call PAWToolShell.init yet.
    // This prevents the “too many containers / nested cards” look inside Circle.
    (function(){
      try{
        const qp = new URLSearchParams(location.search);
        const embed = qp.get("embed");
        const inFrame = window.self !== window.top;
        if(embed === "1" || inFrame){
          document.documentElement.setAttribute("data-embed","1");
        }
      }catch(_){}
    })();
  </script>

  <link rel="stylesheet" href="./paw-ui.css">
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">
          <div class="topbar-row0">
            <div class="tool-subtitle">Clear, confident messages for email and text conversations.</div>

            <div class="topbar-right">
              <button id="reset" class="util-btn" type="button">Reset</button>
              <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
            </div>
          </div>

          <!--
            Connect controls
            - Two compact rows (no questions, no dropdowns)
            - Inline labels (left of buttons)
            - Defaults are highlighted
            - Uses the same layout primitives as listing.html (.controls-row, .ctl, .btn)
          -->
          <div class="controls-row" aria-label="Connect settings">
            <div class="ctl" aria-label="Choose one">
              <label>Choose one</label>
              <div class="btn-row" role="group" aria-label="Type">
                <button class="btn" type="button" data-group="type" data-value="first_contact">First contact</button>
                <button class="btn" type="button" data-group="type" data-value="continue">Continue conversation</button>
              </div>
            </div>

            <div class="ctl" aria-label="Send via">
              <label>Send via</label>
              <div class="btn-row" role="group" aria-label="Channel">
                <button class="btn" type="button" data-group="channel" data-value="email">Email</button>
                <button class="btn" type="button" data-group="channel" data-value="text">Text</button>
              </div>
            </div>

            <div class="ctl" aria-label="Use as">
              <label>Use as</label>
              <div class="btn-row" role="group" aria-label="Usage">
                <button class="btn" type="button" data-group="use" data-value="once">Send once</button>
                <button class="btn" type="button" data-group="use" data-value="template">Reusable template</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Message feed (reserved for future chat-style output) -->
        <div id="messages" class="messages" aria-live="polite"></div>

        <!-- Composer -->
        <div class="composer">
          <textarea id="prompt" class="prompt" rows="3"
            placeholder="Add any context here, or paste a message if you’re replying"></textarea>

          <!-- Use the SAME up-arrow icon as the Listing tool for consistency -->
          <button id="send" class="send" aria-label="Generate message" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <script src="./tool-shell.js"></script>
  <script>
    (function(){
      // UI-only scaffold. No Worker calls yet.

      const state = {
        type: "continue",
        channel: "email",
        use: "once",
      };

      const messagesEl = document.getElementById("messages");
      const promptEl = document.getElementById("prompt");

      function setSelected(group, value){
        state[group] = value;
        document.querySelectorAll('[data-group="'+group+'"]').forEach(btn=>{
          const on = btn.getAttribute("data-value") === value;
          btn.classList.toggle("primary", on);
        });
      }

      // Defaults highlighted so users immediately see what's selected.
      setSelected("type", state.type);
      setSelected("channel", state.channel);
      setSelected("use", state.use);

      document.addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-group]");
        if(!btn) return;
        setSelected(btn.getAttribute("data-group"), btn.getAttribute("data-value"));
      });

      function addLocalNote(text){
        const div = document.createElement("div");
        div.className = "msg reminder";
        div.textContent = text;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      // Reset: straightforward UI clear.
      // When we wire full behavior, this must also clear drafts and any stored state.
      document.getElementById("reset").addEventListener("click", ()=>{
        promptEl.value = "";
        messagesEl.innerHTML = "";
        setSelected("type", "continue");
        setSelected("channel", "email");
        setSelected("use", "once");
      });

      document.getElementById("tips").addEventListener("click", ()=>{
        alert("Tips & How To\n\nComing next: examples for First contact vs Continue conversation, plus best practices for Email vs Text and Template mode.");
      });

      document.getElementById("send").addEventListener("click", ()=>{
        const hasText = (promptEl.value || "").trim().length > 0;

        addLocalNote(
          "Connect UI scaffold is live. Wiring to the Worker comes next.\n\n" +
          "Current settings: " +
          (state.type === "first_contact" ? "First contact" : "Continue conversation") + " • " +
          (state.channel === "email" ? "Email" : "Text") + " • " +
          (state.use === "template" ? "Reusable template" : "Send once") +
          (hasText ? "" : "\n\nTip: add context or paste a message in the box below.")
        );
      });
    })();
  </script>
</body>
</html>
