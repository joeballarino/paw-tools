<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connect</title>
  <link rel="stylesheet" href="./paw-ui.css">

  <script>
    // PAW Embed Mode Guard
    // -------------------
    // Circle provides the outer card. The embedded tool must render "flat".
    // We rely on paw-ui.css rules that activate when html[data-embed="1"] is present.
    // tool-shell.js will set this when initialized, but this UI scaffold does not
    // depend on shell init yet, so we set it here as well.
    (function(){
      try{
        var params = new URLSearchParams(window.location.search);
        var isEmbedParam = params.get('embed') === '1';
        var isInIframe = (function(){ try{ return window.self !== window.top; } catch(e){ return true; } })();
        if(isEmbedParam || isInIframe){
          document.documentElement.setAttribute('data-embed','1');
        }
      }catch(e){}
    })();
  </script>

  <!--
    ProAgent Works — Connect (EMBED TOOL)
    ------------------------------------
    PURPOSE (v1 UI scaffold):
    - This file is the Circle-embedded UI for the Connect communication tool.
    - In this step we are intentionally shipping the UI skeleton first so it can be reviewed
      inside Circle before wiring to the Cloudflare Worker.

    IMPORTANT PRODUCT RULES (locked for PAW tools):
    - Circle owns the tool title. The embedded tool MUST NOT render its own title.
    - The panel top bar (.topbar-row0) contains:
        subtitle/description (left) + Reset/Tips buttons (right)
      ...and NOTHING ELSE.
    - Embed mode:
        tool-shell.js sets html[data-embed="1"] when ?embed=1 is present or when inside an iframe.
        paw-ui.css flattens the panel in embed mode so Circle provides the outer card.

    WIRING NOTE:
    - NO AI logic lives here. All model prompting + output generation will be done by the Worker.
    - This UI currently provides:
        * button-state controls (Type / Send via / Use as)
        * message/context textarea + Generate button
        * message feed area (same shell structure as other tools)
      The Generate button is stubbed for now (it adds a local placeholder message).

    FUTURE ASSISTANTS:
    - When wiring begins, reuse the proven patterns from listing.html and ask.html:
        * shell state (tool-shell.js)
        * reset contract (full reset clears UI + deletes draft)
        * resume modal + autosave (if we decide to keep it consistent with Listing)
  -->
  <style>
    /* Connect-only UI helpers.
       Keep minimal to avoid impacting other tools. */
    .connect-controls{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding: 12px 14px 12px;
      border-bottom:1px solid var(--border-soft);
    }
    .connect-block{display:flex; align-items:center; gap:10px; padding-right:18px; margin-right:18px; border-right:1px solid var(--border-soft);}
    .connect-block:last-child{padding-right:0; margin-right:0; border-right:0;}
    .connect-row{
      display:flex;
      align-items:center;
      flex-wrap:nowrap;
      gap:0;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    .connect-label{
      font-size:12px;
      font-weight:700;
      color:var(--text-muted);
      white-space:nowrap;
      letter-spacing:-0.01em;
      margin-right:2px;
    }
    .connect-group{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    /* Slightly tighter pills than the default .btn for compactness */
    .connect-pill.btn{
      height:32px;
      padding:0 12px;
      font-weight:800;
    }
    @media (max-width: 540px){
      .connect-controls{ padding: 10px 12px; }
      .connect-row{ align-items:flex-start; flex-wrap:wrap; overflow-x:visible; }
      .connect-block{padding-right:0; margin-right:0; border-right:0; width:100%;}
      .connect-group{ flex-wrap:wrap; }
      .connect-label{ width:100%; }
    }
</style>
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">
          <div class="topbar-row0">
            <!-- Circle owns the tool title; embed only shows a short description. -->
            <div class="tool-subtitle">Clear, confident messages for email and text conversations.</div>

            <div class="topbar-right">
              <div class="utility-pair" role="group" aria-label="Tool utilities">
                <button id="reset" class="util-btn" type="button">Reset</button>
                <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
              </div>
            </div>
          </div>

          <!-- Settings (2 rows compressed into 1 row; labels inline) -->
<div class="connect-controls" aria-label="Connect settings">
  <div class="connect-row" aria-label="Connect settings">
    <div class="connect-block">
      <div class="connect-label">Choose one</div>
      <div class="connect-group" role="group" aria-label="Type">
        <button class="btn connect-pill" type="button" data-group="type" data-value="first_contact">First contact</button>
        <button class="btn connect-pill" type="button" data-group="type" data-value="continue">Continue</button>
      </div>
    </div>

    <div class="connect-block">
      <div class="connect-label">Send via</div>
      <div class="connect-group" role="group" aria-label="Send via">
        <button class="btn connect-pill" type="button" data-group="channel" data-value="email">Email</button>
        <button class="btn connect-pill" type="button" data-group="channel" data-value="text">Text</button>
      </div>
    </div>

    <div class="connect-block">
      <div class="connect-label">Use as</div>
      <div class="connect-group" role="group" aria-label="Use as">
        <button class="btn connect-pill" type="button" data-group="use" data-value="once">Send once</button>
        <button class="btn connect-pill" type="button" data-group="use" data-value="template">Template</button>
      </div>
    </div>
  </div>
</div>
<!-- Message feed (same structure as Listing/Ask so tool-shell can manage it later) -->
        <div id="messages" class="messages" aria-live="polite"></div>

        <!-- Composer -->
        <div class="composer">
          <textarea id="prompt" class="prompt" rows="3"
            placeholder="Add any context here, or paste a message if you’re replying"></textarea>

          <button id="send" class="send" aria-label="Generate message" type="button">
            <img src="https://paw-tools.pages.dev/paw.png" class="send-icon" alt="">
          </button>
        </div>

      </div>
    </div>
  </div>

  <script src="./tool-shell.js"></script>
  
  <script>
    /**
     * PAW Connect (Circle-embedded tool page)
     * ------------------------------------------------------------
     * This file is intentionally "thin": all AI logic lives in the Cloudflare Worker.
     * The frontend only:
     *  - collects UI preferences (first_contact/continue, email/text, once/template)
     *  - sends the user's text to the Worker via tool-shell.js
     *  - shows the result in the standard PAW deliverable modal (Copy / Revise)
     *
     * IMPORTANT:
     * - Do not move prompt logic into this file.
     * - Keep IDs consistent with tool-shell.js expectations: #messages, #prompt, #send, #reset, #tips
     */
    (function () {
      const state = {
        type: "first_contact",  // first_contact | continue
        channel: "email",       // email | text
        use: "once",            // once | template
      };

      const $ = (sel) => document.querySelector(sel);
      const pills = Array.from(document.querySelectorAll(".connect-pill"));

      function setActive(group, value) {
        pills.forEach((btn) => {
          if (btn.dataset.group !== group) return;
          const isOn = btn.dataset.value === value;
          btn.classList.toggle("is-active", isOn);
          btn.setAttribute("aria-pressed", isOn ? "true" : "false");
        });
      }

      function syncUIFromState() {
        setActive("type", state.type);
        setActive("channel", state.channel);
        setActive("use", state.use);
      }

      // Attach pill handlers
      pills.forEach((btn) => {
        btn.addEventListener("click", () => {
          const group = btn.dataset.group;
          const value = btn.dataset.value;
          if (!group || !value) return;

          if (group === "type") state.type = value;
          if (group === "channel") state.channel = value;
          if (group === "use") state.use = value;

          syncUIFromState();
        });
      });

      // Reset should restore the toggle defaults AND let tool-shell clear thread/input.
      const resetBtn = $("#reset");
      if (resetBtn) {
        resetBtn.addEventListener(
          "click",
          () => {
            state.type = "first_contact";
            state.channel = "email";
            state.use = "once";
            syncUIFromState();
          },
          true // capture so we run before tool-shell reset, but we do NOT prevent it
        );
      }

      // Dynamic deliverable title (Suggestion #1)
      function getDeliverableTitle() {
        const isTemplate = state.use === "template";
        const isText = state.channel === "text";
        const isFirst = state.type === "first_contact";

        if (isTemplate && isText) return "Reusable Text Template";
        if (isTemplate && !isText) return "Reusable Email Template";

        if (!isTemplate && isText && isFirst) return "Your First Text Message";
        if (!isTemplate && isText && !isFirst) return "Your Follow-Up Text";
        if (!isTemplate && !isText && isFirst) return "Your Intro Email";
        return "Your Reply Email";
      }

      // Tips modal content (light, action-oriented)
      const tipsText =
        "What to paste here:\\n" +
        "• The last message they sent (if you’re replying)\\n" +
        "• A quick note about who they are + what you want\\n" +
        "• Any relevant detail (property address, timeline, question)\\n\\n" +
        "Best results when you include:\\n" +
        "• The relationship (lead, past client, friend, vendor)\\n" +
        "• The goal (book a showing, set a call, re-engage, confirm next step)\\n" +
        "• Any tone preference (shorter, warmer, more direct)";

      // Initialize tool-shell wiring
      if (!window.PAWToolShell || typeof window.PAWToolShell.init !== "function") {
        console.error("PAWToolShell not found. Ensure tool-shell.js is loaded.");
        return;
      }

      window.PAWToolShell.init({
        toolId: "connect",
        deliverableMode: true,                 // Listing-style modal w/ Copy + Revise
        deliverableTitle: getDeliverableTitle, // tool-shell now supports a function
        tipsText,

        // These prefs are sent to the Worker and drive the “secret sauce” behavior.
        getPrefs: function () {
          return {
            connect_type: state.type,
            connect_channel: state.channel,
            connect_use: state.use,
          };
        },
      });

      // Set initial UI state
      syncUIFromState();
    })();
  </script>

</body>
</html>
