<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="https://paw-tools.pages.dev/paw-ui.css">
  <!--
    HEADER CONTRACT (LOCKED):
    - The panel top bar (.topbar-row0) MUST NEVER include a title.
    - It only contains: subtitle (left) + Reset/Tips buttons (right).
  -->
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">

          <div class="topbar-row0">
            <div class="tool-subtitle">MLS-ready listing remarks with built-in real estate expertise.</div>

            <div class="topbar-right">
              <button id="reset" class="util-btn" type="button">Reset</button>
              <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
            </div>
          </div>

          <div class="topbar-row1">
            <div class="controls-row controls-row-compact">

              <div class="control">
                <label>Type</label>
                <select id="type">
                  <option value="">Choose...</option>
                  <option value="General">General</option>
                  <option value="Starter">Starter</option>
                  <option value="Move-Up">Move-Up</option>
                  <option value="Luxury">Luxury</option>
                  <option value="Investor">Investor</option>
                  <option value="New Construction">New Construction</option>
                  <option value="Land">Land</option>
                  <option value="Multi-Family">Multi-Family</option>
                  <option value="Rental">Rental</option>
                </select>
              </div>

              <div class="control">
                <label>Tone</label>
                <select id="tone">
                  <option value="">Choose...</option>
                  <option value="General">General</option>
                  <option value="Warm">Warm</option>
                  <option value="Modern">Modern</option>
                  <option value="Luxury">Luxury</option>
                  <option value="Concise">Concise</option>
                </select>
              </div>

              <div class="control">
                <label>Length</label>
                <select id="length">
                  <option value="">Choose...</option>
                  <option value="Short">Short</option>
                  <option value="Standard">Standard</option>
                  <option value="Long">Long</option>
                </select>
              </div>

              <div class="control control-wide">
                <label>City</label>
                <input id="city" placeholder="City" />
              </div>

              <div class="control">
                <label>State</label>
                <select id="state">
                  <option value="">ST</option>
                  <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option>
                  <option>CO</option><option>CT</option><option>DE</option><option>FL</option><option>GA</option>
                  <option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option>
                  <option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option>
                  <option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option>
                  <option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
                  <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option>
                  <option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option>
                  <option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option>
                  <option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
                </select>
              </div>

            </div>

            <div class="controls-row controls-row-compact">
              <div class="control">
                <label>Beds</label>
                <select id="beds">
                  <option value="">—</option>
                  <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                  <option>6</option><option>7</option><option>8+</option>
                </select>
              </div>

              <div class="control">
                <label>Baths</label>
                <select id="baths">
                  <option value="">—</option>
                  <option>1</option><option>1.5</option><option>2</option><option>2.5</option>
                  <option>3</option><option>3.5</option><option>4+</option>
                </select>
              </div>

              <div class="control">
                <label>Sqft</label>
                <input id="sqft" placeholder="e.g. 1800" />
              </div>

              <div class="control">
                <label>Price</label>
                <input id="price" placeholder="for context only" />
              </div>

              <div class="control">
                <label>Pool</label>
                <select id="pool">
                  <option value="">—</option>
                  <option value="No">No</option>
                  <option value="Yes">Yes</option>
                </select>
              </div>

              <div class="control">
                <label>Porch</label>
                <select id="porch">
                  <option value="">—</option>
                  <option value="No">No</option>
                  <option value="Yes">Yes</option>
                </select>
              </div>
            </div>

            <div class="controls-row">
              <div class="control control-full">
                <label>Most Compelling Feature</label>
                <input id="compelling" placeholder="Location, design, lifestyle, value, etc." />
              </div>
            </div>

          </div>
        </div>

        <div class="panel-body">
          <div id="toolMount"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Local highlights modal -->
  <div id="localModal" class="paw-local-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="paw-local-modal-card">
      <div class="paw-local-modal-head">
        <div class="paw-local-modal-title">Possible nearby highlights (optional)</div>
        <button id="localModalClose" class="paw-local-modal-x" type="button" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="rgba(15,23,42,.8)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="paw-local-modal-body">
        <div class="paw-local-modal-sub">
          We found nearby places that <b>may or may not apply</b> to this listing. Select only what you know is accurate.
          <b>Nothing is added unless you choose it.</b>
        </div>

        <div id="localModalListWrap"></div>

        <div class="paw-local-modal-actions">
          <button id="localModalSkip" class="paw-btn paw-btn-ghost" type="button">Keep as-is</button>
          <button id="localModalApply" class="paw-btn" type="button">Update description</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Local modal styling (kept minimal; main styles in paw-ui.css) */
    .paw-local-modal {
      position: fixed; inset: 0;
      background: rgba(15, 23, 42, .45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .paw-local-modal.show { display: flex; }
    .paw-local-modal-card {
      width: min(840px, 96vw);
      max-height: min(720px, 86vh);
      overflow: auto;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(15,23,42,.22);
      padding: 18px;
    }
    .paw-local-modal-head {
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 4px 6px 10px 6px;
      border-bottom: 1px solid rgba(15,23,42,.08);
      margin-bottom: 12px;
    }
    .paw-local-modal-title { font-size: 16px; font-weight: 800; color: rgba(15,23,42,.92); }
    .paw-local-modal-x {
      border: none; background: transparent; cursor: pointer;
      width: 36px; height: 36px; border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
    }
    .paw-local-modal-x:hover { background: rgba(15,23,42,.06); }
    .paw-local-modal-body { padding: 8px 6px 4px 6px; }
    .paw-local-modal-sub {
      font-size: 14px;
      color: rgba(15,23,42,.78);
      line-height: 1.4;
      margin-bottom: 12px;
    }
    .paw-local-modal-actions {
      display:flex; justify-content:flex-end; gap:10px;
      padding: 12px 6px 2px 6px;
      border-top: 1px solid rgba(15,23,42,.08);
      margin-top: 12px;
      position: sticky; bottom: 0;
      background: rgba(255,255,255,.96);
    }
  </style>

  <script src="https://paw-tools.pages.dev/tool-shell.js"></script>

  <script>
    (function(){
      const TIPS_TEXT = `Use this to generate MLS-ready listing remarks. Add upgrades, finishes, neighborhood notes, HOA details, and any disclosures in the notes box for best results.`;

      const $type = document.getElementById("type");
      const $tone = document.getElementById("tone");
      const $length = document.getElementById("length");
      const $city = document.getElementById("city");
      const $state = document.getElementById("state");
      const $beds = document.getElementById("beds");
      const $baths = document.getElementById("baths");
      const $sqft = document.getElementById("sqft");
      const $price = document.getElementById("price");
      const $pool = document.getElementById("pool");
      const $porch = document.getElementById("porch");
      const $compelling = document.getElementById("compelling");

      const $localModal = document.getElementById("localModal");
      const $localModalClose = document.getElementById("localModalClose");
      const $localModalSkip = document.getElementById("localModalSkip");
      const $localModalApply = document.getElementById("localModalApply");
      const $localModalListWrap = document.getElementById("localModalListWrap");

      const HIGHLIGHTS_TOKEN = "__PAW_HIGHLIGHTS__";

      let pendingHighlightsOffer = false;
      let cachedHighlights = []; // {id,label}

      // Prevent re-prompt loops: remember the last highlight list we showed for the current city/state.
      let lastHighlightsKey = "";
      let lastCityStateKey = "";

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ const t = normText(v); return t ? t : ""; }

      function mapType(v){ return normText(v) || "general"; }
      function mapTone(v){ return normText(v) || "general"; }
      function mapLen(v){ return normText(v) || "standard"; }

      function cityVal(){ return normText($city.value); }
      function stateVal(){ return normText($state.value).toUpperCase(); }
      function locationVal(){
        const c = cityVal(), s = stateVal();
        if (c && s) return `${c}, ${s}`;
        return "";
      }

      function escapeHtml(str){
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function coerceHighlightLabel(it){
        if (!it) return "";
        if (typeof it === "string") return it.trim();
        if (typeof it === "object") return String(it.label || it.name || it.title || "").trim();
        return "";
      }

      function isBadHighlightLabel(label){
        const t = String(label || "").toLowerCase();
        if (!t) return true;
        if (/\b(minutes?|mins?|mi|miles?|km)\b/i.test(t)) return true;
        if (t.includes("json") || t.includes("{") || t.includes("}")) return true;
        return false;
      }

      function looksLikeDeliverableText(reply){
        const r = String(reply || "").trim();
        if (!r) return false;
        if ((r.match(/\?/g) || []).length >= 1) return false;
        if (/^(one|a couple|a few)\s+quick\s+(question|questions|clarifiers)\b/i.test(r)) return false;
        return r.length >= 240;
      }

      function openLocalModal(highlights){
        cachedHighlights = highlights.slice(0, 6);

        // Remember what we showed so we don’t re-open the modal with the same list repeatedly.
        lastHighlightsKey = cachedHighlights.map(h => String(h.label || "").trim().toLowerCase()).join("|");
        lastCityStateKey = `${cityVal().toLowerCase()}|${stateVal().toLowerCase()}`;

        // None selected by default
        let html = '<div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">';
        cachedHighlights.forEach((h, idx) => {
          const id = `lh_pick_${idx}`;
          html += `
            <label style="display:flex; align-items:flex-start; gap:10px; padding:12px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
              <input id="${id}" type="checkbox" style="margin-top:2px;" />
              <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">${escapeHtml(h.label)}</span>
            </label>
          `;
        });
        html += '</div>';
        $localModalListWrap.innerHTML = html;

        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }

      function closeLocalModal(){
        $localModal.classList.remove("show");
        $localModal.setAttribute("aria-hidden", "true");
        $localModalListWrap.innerHTML = "";
      }

      function getModalSelections(){
        const selected = [];
        cachedHighlights.forEach((h, idx) => {
          const cb = document.getElementById(`lh_pick_${idx}`);
          if (cb && cb.checked) selected.push(h.label);
        });
        return selected;
      }

      async function fetchHighlightsInBackground(){
        const c = cityVal();
        const s = stateVal();
        if (!c || !s) return;
        await shell.sendExtra(HIGHLIGHTS_TOKEN, {}, { echoUser: false });
      }

      // Modal controls
      $localModalClose.addEventListener("click", closeLocalModal);
      $localModal.addEventListener("click", (e) => { if (e.target === $localModal) closeLocalModal(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLocalModal(); });
      $localModalSkip.addEventListener("click", closeLocalModal);

      $localModalApply.addEventListener("click", async () => {
        const picked = getModalSelections();
        closeLocalModal();
        if (!picked.length) return;

        const instruction =
`Update the MLS description above.
Only incorporate the selected nearby highlights if the agent confirms they are accurate and if they improve specificity.
Replace generic filler lines first. Do not add fluff. Keep the overall length similar.

Selected highlights:
- ${picked.join("\n- ")}`;

        // IMPORTANT: this call should NOT re-arm the modal offer.
        await shell.sendExtra(instruction, { phase: "write", selected_highlights: picked }, { echoUser: true });
      });

      const shell = window.PAWToolShell.init({
        toolId: "listing_description_writer",
        tipsText: TIPS_TEXT,
        mountId: "toolMount",

        getPrefs: () => {
          return {
            listing_type: mapType($type.value),
            tone: mapTone($tone.value),
            length: mapLen($length.value),
            city: cityVal(),
            state: stateVal(),
            location: locationVal(),
            compelling_feature: normText($compelling.value),
            locked: {
              beds: normEnum($beds.value),
              baths: normEnum($baths.value),
              sqft: digitsOnly($sqft.value),
              price: digitsOnly($price.value),
              pool: normEnum($pool.value),
              porch: normEnum($porch.value),
            }
          };
        },

        // Runs on every submit
        getExtraPayload: (text) => {
          const base = { city: cityVal(), state: stateVal(), location: locationVal() };

          // Background highlights fetch token
          if (String(text).trim() === HIGHLIGHTS_TOKEN) {
            if (!base.city || !base.state) return base;
            return Object.assign({}, base, { phase: "highlights" });
          }

          // Normal user submit: arm the offer if we have city/state.
          // The modal is never blocking the initial generation.
          // IMPORTANT: If this submit is the "apply selected highlights" instruction, do NOT arm again.
          const t = String(text || "").trim();
          if (/^Update the MLS description above\./i.test(t) || /\bSelected highlights:\b/i.test(t)) {
            pendingHighlightsOffer = false;
            return base;
          }

          pendingHighlightsOffer = !!(base.city && base.state);

          return base;
        },

        onResponse: (data) => {
          const reply = data && typeof data.reply === "string" ? data.reply : "";

          // After the deliverable is produced, kick off background highlights fetch
          if (pendingHighlightsOffer && looksLikeDeliverableText(reply)) {
            pendingHighlightsOffer = false;
            fetchHighlightsInBackground(); // async, no block
            return; // allow shell to render deliverable
          }

          // Handle highlights response
          const highlightsRaw = data && data.local && Array.isArray(data.local.highlights) ? data.local.highlights : null;
          if (highlightsRaw && highlightsRaw.length) {
            const currentCityStateKey = `${cityVal().toLowerCase()}|${stateVal().toLowerCase()}`;

            const normalized = highlightsRaw
              .map((it, i) => ({ id: String((it && typeof it === "object" && (it.id || it.key)) ? (it.id || it.key) : (i+1)), label: coerceHighlightLabel(it) }))
              .filter(x => x.label && !isBadHighlightLabel(x.label));

            const newKey = normalized.map(h => String(h.label || "").trim().toLowerCase()).join("|");

            // If we've already shown this exact list for this city/state, don't prompt again.
            if (newKey && newKey === lastHighlightsKey && currentCityStateKey === lastCityStateKey) {
              return { skipDefault: true };
            }

            if (normalized.length && cityVal() && stateVal()) {
              openLocalModal(normalized);
            }
            return { skipDefault: true };
          }

          // Ignore any “provide city/state or zip” prompt silently
          const lower = reply.toLowerCase();
          if (lower.includes("provide") && (lower.includes("city/state") || lower.includes("zip"))) {
            return { skipDefault: true };
          }
        }
      });

      // Tips
      document.getElementById("tips").addEventListener("click", () => {
        try { shell.showTips(); } catch {}
      });

      // Reset
      document.getElementById("reset").addEventListener("click", () => {
        pendingHighlightsOffer = false;
        cachedHighlights = [];
        lastHighlightsKey = "";
        lastCityStateKey = "";
        closeLocalModal();
        try { $city.value = ""; $state.value = ""; } catch {}
        try { if (shell && shell.reset) shell.reset(); } catch {}
      });

    })();
  </script>
</body>
</html>
