<!-- listing.html (FULL REPLACEMENT) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="/paw-ui.css">

  <!--
    HEADER CONTRACT (LOCKED):
    The panel top bar (.topbar-row0) MUST NEVER include a title.
    It only contains:
      - .tool-subtitle (left)
      - Reset / Tips buttons (right)
    Titles belong ABOVE the panel in the outer shell, not inside this bar.
  -->
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <!-- TOP BAR -->
        <div class="panel-topbar">
          <div class="topbar-row0">
            <div class="tool-subtitle">MLS-ready listing remarks with built-in real estate expertise.</div>

            <div class="topbar-right">
              <button class="util-btn" id="reset" type="button">Reset</button>
              <button class="util-btn" id="tipsBtn" type="button">Tips &amp; How To</button>
            </div>
          </div>

          <!-- Controls row -->
          <div class="controls-row">
            <div class="ctl">
              <label for="typeSel">Type</label>
              <span class="select-wrap">
                <select id="typeSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="starter">Starter</option>
                  <option value="moveup">Move-Up</option>
                  <option value="luxury">Luxury</option>
                  <option value="investor">Investor</option>
                  <option value="relocation">Relocation</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="toneSel">Tone</label>
              <span class="select-wrap">
                <select id="toneSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="professional">Professional</option>
                  <option value="warm">Warm</option>
                  <option value="elevated">Elevated</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="lenSel">Length</label>
              <span class="select-wrap">
                <select id="lenSel">
                  <option value="" selected>Choose…</option>
                  <option value="standard">Standard</option>
                  <option value="short">Short</option>
                  <option value="long">Long</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="cityInp">City</label>
              <span class="input-wrap md">
                <input id="cityInp" type="text" placeholder="City" autocomplete="address-level2" />
              </span>
            </div>

            <div class="ctl">
              <label for="stateSel">State</label>
              <span class="select-wrap sm">
                <select id="stateSel" autocomplete="address-level1">
                  <option value="" selected>ST</option>
                  <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option><option value="CA">CA</option>
                  <option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option><option value="DC">DC</option><option value="FL">FL</option>
                  <option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option>
                  <option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option>
                  <option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                  <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option>
                  <option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option>
                  <option value="OH">OH</option><option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
                  <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                  <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option><option value="WI">WI</option>
                  <option value="WY">WY</option>
                </select>
              </span>
            </div>
          </div>

          <!-- Key facts -->
          <div class="topbar-row2">
            <div class="lock-head">
              <div class="lock-title">Lock key facts (optional)</div>

              <label class="check check-plain" for="localChk" title="Generate a shortlist of local highlights before writing">
                <input id="localChk" type="checkbox" />
                <span>Add Local Highlights</span>
              </label>
            </div>

            <div id="localHint" class="hint error" style="display:none;">Add city and state above to generate local highlights.</div>

            <div class="lock-grid">
              <div class="field">
                <label for="bedsSel">Beds</label>
                <select id="bedsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5+">5+</option>
                </select>
              </div>

              <div class="field">
                <label for="bathsSel">Baths</label>
                <select id="bathsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option>
                  <option value="1.5">1.5</option>
                  <option value="2">2</option>
                  <option value="2.5">2.5</option>
                  <option value="3+">3+</option>
                </select>
              </div>

              <div class="field">
                <label for="sqftInp">Sqft</label>
                <input id="sqftInp" type="text" inputmode="numeric" placeholder="e.g. 1800" />
              </div>

              <div class="field">
                <label for="priceInp">Price</label>
                <input id="priceInp" type="text" placeholder="for context only" />
              </div>

              <div class="field">
                <label for="poolSel">Pool</label>
                <select id="poolSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="field">
                <label for="porchSel">Porch</label>
                <select id="porchSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div class="lock-row2">
              <label class="field" style="width:100%;">
                <div class="field-label" style="font-size:12px; font-weight:700; color:rgba(15,23,42,.82); margin-bottom:6px; letter-spacing:-0.01em;">Most Compelling Feature</div>
                <input id="compellingInp" class="big-input" type="text" placeholder="Location, design, lifestyle, value, etc." />
              </label>
            </div>

            <!-- Local highlights panel -->
            <div id="localPanel" class="local-panel" style="display:none;">
              <div class="local-head">
                <div>
                  <div class="local-title">Local highlights</div>
                  <div class="local-sub">Select the ones you want included, then write the description.</div>
                </div>
                <div class="local-actions">
                  <button id="localSkip" class="btn" type="button">Skip</button>
                  <button id="localWrite" class="btn primary" type="button">Write description</button>
                </div>
              </div>
              <ul id="localList" class="local-list"></ul>
            </div>

          </div><!-- /topbar-row2 -->
        </div><!-- /panel-topbar -->

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="Add upgrades, finishes, neighborhood notes, disclosures, HOA details, or paste listing data here"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Tips modal -->
  <div id="tipsModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="tipsTitle">
      <div class="modal-head">
        <div id="tipsTitle" class="modal-title">Tips &amp; How To</div>
        <button class="modal-close" id="tipsClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body" id="tipsBody"></div>
    </div>
  </div>

  <script src="/tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const TIPS_TEXT =
`What this tool does
• Writes MLS-ready listing remarks with real estate best practices baked in.

Best inputs
• Paste features and upgrades (renovations, finishes, systems, appliances).
• Add anything that must be included or avoided.
• Include HOA details if relevant.

Local highlights
• Add City + State above for accurate local highlights.

Compliance
• Avoid protected-class language. This tool is designed to stay fair-housing safe.`;

      // Tips modal
      const $tipsBtn = document.getElementById("tipsBtn");
      const $tipsModal = document.getElementById("tipsModal");
      const $tipsClose = document.getElementById("tipsClose");
      const $tipsBody = document.getElementById("tipsBody");
      $tipsBody.textContent = TIPS_TEXT;

      function openTips(){ $tipsModal.classList.add("show"); $tipsModal.setAttribute("aria-hidden", "false"); }
      function closeTips(){ $tipsModal.classList.remove("show"); $tipsModal.setAttribute("aria-hidden", "true"); }

      $tipsBtn.addEventListener("click", openTips);
      $tipsClose.addEventListener("click", closeTips);
      $tipsModal.addEventListener("click", (e) => { if (e.target === $tipsModal) closeTips(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeTips(); });

      // Controls
      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $len  = document.getElementById("lenSel");
      const $city = document.getElementById("cityInp");
      const $state = document.getElementById("stateSel");

      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");

      const $local = document.getElementById("localChk");
      const $localHint = document.getElementById("localHint");
      const $localPanel = document.getElementById("localPanel");
      const $localList = document.getElementById("localList");
      const $localSkip = document.getElementById("localSkip");
      const $localWrite = document.getElementById("localWrite");
      const $input = document.getElementById("input");

      let lastNotesForLocal = "";

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ const t = normText(v); return t ? t : ""; }

      function mapType(v){ return normText(v) || "general"; }
      function mapTone(v){ return normText(v) || "general"; }
      function mapLen(v){ return normText(v) || "standard"; }

      function cityVal(){ return normText($city.value); }
      function stateVal(){ return normText($state.value).toUpperCase(); }
      function locationVal(){
        const c = cityVal(), s = stateVal();
        if (c && s) return `${c}, ${s}`;
        if (s) return s;
        return c;
      }

      function validateLocalHint(){
        if (!$localHint) return;
        if (!$local.checked){ $localHint.style.display = "none"; return; }
        const ok = !!cityVal() && !!stateVal();
        $localHint.style.display = ok ? "none" : "block";
      }

      function showLocalPanel(highlights){
        $localList.innerHTML = "";
        (highlights || []).forEach((h, idx) => {
          const li = document.createElement("li");
          li.className = "local-item";
          const id = "hl_" + idx;
          li.innerHTML = `<input id="${id}" type="checkbox" checked /><label for="${id}" class="txt"></label>`;
          li.querySelector("label").textContent = h;
          $localList.appendChild(li);
        });
        $localPanel.style.display = "block";
      }
      function hideLocalPanel(){
        $localPanel.style.display = "none";
        $localList.innerHTML = "";
      }

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        inputPlaceholder: "Add upgrades, finishes, neighborhood notes, disclosures, HOA details, or paste listing data here",
        tipsText: TIPS_TEXT,
        sendHistoryItems: 8,
        maxHistoryItems: 16,

        getPrefs: () => ({
          listing_type: mapType($type.value),
          output_use: "MLS",
          tone: mapTone($tone.value),
          length: mapLen($len.value),

          safe_mode: true,

          // LOCKED PRODUCT DECISION: do not ask questions in this tool
          ask_followups: false,

          // Pass location strongly so Worker never needs to ask
          city: cityVal(),
          state: stateVal(),
          location: locationVal(),

          local_highlights: !!$local.checked && !!cityVal() && !!stateVal(),

          compelling_feature: normText($compelling.value),

          locked: {
            beds: normEnum($beds.value),
            baths: normEnum($baths.value),
            sqft: digitsOnly($sqft.value),
            price: normText($price.value),
            pool: normEnum($pool.value),
            porch: normEnum($porch.value)
          }
        }),

        // IMPORTANT: tool-shell merges this into TOP-LEVEL payload too
        // so the Worker can read city/state/location even if it ignores prefs.
        getExtraPayload: (text, ctx) => {
          const c = cityVal();
          const s = stateVal();
          const loc = locationVal();

          // If Local Highlights is checked but missing location, just hint and continue normally.
          if ($local.checked && (!c || !s)) {
            validateLocalHint();
            return { city: c, state: s, location: loc };
          }

          // If local highlights is enabled & we have location, request highlights phase.
          if ($local.checked && c && s) {
            lastNotesForLocal = text;
            return { phase: "highlights", city: c, state: s, location: loc };
          }

          lastNotesForLocal = "";
          return { city: c, state: s, location: loc };
        },

        onResponse: (data, ctx) => {
          const prefs = (ctx && ctx.prefs) ? ctx.prefs : {};
          if (!prefs.local_highlights) return;

          const highlights = data && data.local && Array.isArray(data.local.highlights) ? data.local.highlights : null;
          if (highlights && highlights.length) {
            showLocalPanel(highlights);
          }
        }
      });

      // Local highlight actions
      $localSkip.addEventListener("click", () => {
        hideLocalPanel();
        shell.sendExtra(lastNotesForLocal, { phase: "write", selected_highlights: [] }, { echoUser: false });
      });

      $localWrite.addEventListener("click", () => {
        const selected = [];
        $localList.querySelectorAll("li").forEach(li => {
          const cb = li.querySelector("input[type=checkbox]");
          const label = li.querySelector("label");
          if (cb && cb.checked && label) selected.push(label.textContent.trim());
        });
        hideLocalPanel();
        shell.sendExtra(lastNotesForLocal, { phase: "write", selected_highlights: selected }, { echoUser: false });
      });

      // If user toggles local highlights after entering city/state, fetch immediately (no extra prompt)
      $local.addEventListener("change", () => {
        validateLocalHint();
        if ($local.checked && cityVal() && stateVal()) {
          shell.sendExtra(normText($input.value) || "Generate local highlights.", { phase: "highlights" }, { echoUser: false });
        }
      });

      $city.addEventListener("input", validateLocalHint);
      $state.addEventListener("change", validateLocalHint);

      // Reset
      document.getElementById("reset").addEventListener("click", () => {
        hideLocalPanel();
        lastNotesForLocal = "";
        try { $city.value = ""; $state.value = ""; } catch {}
        try { if ($localHint) $localHint.style.display = "none"; } catch {}
      });

      hideLocalPanel();
      validateLocalHint();
    })();
  </script>
</body>
</html>
