<!doctype html>
<html lang="en">
<head>
  <!--
    PAW Embed Guard (required):
    These tool pages are built for Circle embedding.
    If someone opens this page directly (not in an iframe), redirect to proagentworks.com.
    Keep this lightweight; no dependencies.
  -->
  <script>
    (function () {
      try {
        if (window.top === window.self) {
          window.location.replace("https://proagentworks.com");
        }
      } catch (e) {
        // If cross-origin framing prevents access to window.top, fail closed.
        window.location.replace("https://proagentworks.com");
      }
    })();
  </script>
  <script>
    // PAW Embed Mode Guard
    // -------------------
    // Circle provides the outer card. The embedded tool must render "flat".
    // We rely on paw-ui.css rules that activate when html[data-embed="1"] is present.
    // tool-shell.js will set this when initialized, but this UI scaffold does not
    // depend on shell init yet, so we set it here as well.
    (function(){
      try{
        var params = new URLSearchParams(window.location.search);
        var isEmbedParam = params.get('embed') === '1';
        var isInIframe = (function(){ try{ return window.self !== window.top; } catch(e){ return true; } })();
        if(isEmbedParam || isInIframe){
          document.documentElement.setAttribute('data-embed','1');
        }
      }catch(e){}
    })();
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="./paw-ui.css">
  <!--
    HEADER CONTRACT (LOCKED):
    - The panel top bar (.topbar-row0) MUST NEVER include a title.
    - It only contains: subtitle (left) + Reset/Tips buttons (right).
  -->
</head>

<body class="paw-listing">
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">

          <div class="topbar-row0">
            <div class="tool-head">
              <button id="pawMyStuffBtn" class="paw-mystuff-btn paw-works-btn" type="button" aria-label="Work context">
                <img class="works-paw" src="https://paw-tools.pages.dev/paw.png" alt="" aria-hidden="true">
                <span class="works-label">Work</span>
                <span class="works-chevron" aria-hidden="true">▾</span>
              </button>
            </div>

            

            <div class="topbar-right paw-seg">
              <button id="reset" class="util-btn paw-seg__btn" type="button">Reset</button>
              <button id="tips" class="util-btn paw-seg__btn" type="button">Tips &amp; How To</button>
            </div>
          </div>

          <div class="controls-row">
            <div class="ctl">
              <label for="typeSel">Type</label>
              <span class="select-wrap">
                <select id="typeSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="starter">Starter</option>
                  <option value="moveup">Move-Up</option>
                  <option value="luxury">Luxury</option>
                  <option value="investor">Investor</option>
                  <option value="relocation">Relocation</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="toneSel">Tone</label>
              <span class="select-wrap">
                <select id="toneSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="professional">Professional</option>
                  <option value="warm">Warm</option>
                  <option value="elevated">Elevated</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="lenSel">Length</label>
              <span class="select-wrap">
                <select id="lenSel">
                  <option value="" selected>Choose…</option>
                  <option value="standard">Standard</option>
                  <option value="short">Short</option>
                  <option value="long">Long</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="cityInp">City</label>
              <span class="input-wrap md">
                <input id="cityInp" type="text" placeholder="Example: 2023 roof, quartz counters, walkable to shops" autocomplete="address-level2" />
              </span>
            </div>

            <div class="ctl">
              <label for="stateSel">State</label>
              <span class="select-wrap sm">
                <select id="stateSel" autocomplete="address-level1">
                  <option value="" selected>ST</option>
                  <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option><option value="CA">CA</option>
                  <option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option><option value="DC">DC</option><option value="FL">FL</option>
                  <option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option>
                  <option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option>
                  <option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                  <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option>
                  <option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option>
                  <option value="OH">OH</option><option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
                  <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                  <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option><option value="WI">WI</option>
                  <option value="WY">WY</option>
                </select>
              </span>
            </div>
          </div>

          <div class="topbar-row2">

            <div class="lock-grid">
              <div class="field">
                <label for="bedsSel">Beds</label>
                <select id="bedsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">5+</option>
                </select>
              </div>

              <div class="field">
                <label for="bathsSel">Baths</label>
                <select id="bathsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option><option value="2.5">2.5</option><option value="3+">3+</option>
                </select>
              </div>

              <div class="field">
                <label for="sqftInp">Sqft</label>
                <input id="sqftInp" type="text" inputmode="numeric" placeholder="Example: 2023 roof, quartz counters, walkable to shops" />
              </div>

              <div class="field">
                <label for="priceInp">Price</label>
                <input id="priceInp" type="text" placeholder="Example: 2023 roof, quartz counters, walkable to shops" />
              </div>

              <div class="field">
                <label for="poolSel">Pool</label>
                <select id="poolSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="field">
                <label for="porchSel">Porch</label>
                <select id="porchSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div class="lock-row2">
              <label class="field" style="width:100%;">
                <div class="field-label" style="font-size:12px; font-weight:700; color:rgba(15,23,42,.82); margin-bottom:8px; letter-spacing:-0.01em;">Most Compelling Feature</div>
                <input id="compellingInp" class="big-input" type="text" placeholder="Example: 2023 roof, quartz counters, walkable to shops" />
              </label>
            </div>

          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          
          <div class="composer-main">
            <div class="composer-help">Paste MLS data or notes. Include upgrades + what buyers will feel.</div>
            <textarea id="input" placeholder="Example: 2023 roof, quartz counters, walkable to shops"></textarea>
          </div>
          <button id="send" class="send" aria-label="Send" type="button">
            <img src="https://paw-tools.pages.dev/paw.png" class="send-icon" alt="">
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Local Highlights Modal -->
  <div id="localModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="localModalTitle">
      <div class="modal-head">
        <div id="localModalTitle" class="modal-title">Neighborhood Highlights</div>
        <button class="modal-close" id="localModalClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body">
        <div style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:10px;">
          Here are some common neighborhood highlights. Choose what fits this listing, or add your own.
          <b>Nothing is added unless you choose it.</b>
        </div>
        <div id="localModalListWrap" class="poi-listwrap"></div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <button id="localModalSkip" class="btn" type="button">Keep as-is</button>
          <button id="localModalApply" class="btn primary" type="button">Update description</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Resume Draft Modal (Listing tool) -->
  <div id="pawResumeModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pawResumeTitle">
      <div class="modal-head">
        <div id="pawResumeTitle" class="modal-title">Resume draft?</div>
        <button class="modal-close" id="pawResumeClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body">
        <div id="pawResumeMeta" style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:14px;">
          We found a saved draft on this device.
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button id="pawResumeFresh" class="btn" type="button">Start fresh</button>
          <button id="pawResumeGo" class="btn primary" type="button">Resume</button>
        </div>
      </div>
    </div>
  </div>


  <script src="/tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const TIPS_TEXT =
`What this tool does
• Generates MLS-ready listing remarks that are accurate, motivating, and Fair Housing–safe.

What to paste
• MLS data, property notes, upgrades, neighborhood highlights, HOA details
• What’s new, what’s rare, and what a buyer will notice first

Best results when you include
• City & state (helps local context)
• Anything sensitive as facts only (HOA/fees, known restrictions, disclosures)
• If something is unknown, leave it blank (or type “unknown”) and PAW will write conservatively

Examples
• “Write this as a modern, upbeat MLS description: …”
• “Make it shorter and more luxury-coded, but still accurate: …”`;

      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $len  = document.getElementById("lenSel");
      const $city = document.getElementById("cityInp");
      const $state = document.getElementById("stateSel");

      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");
      const $input = document.getElementById("input");

      // Local highlights modal elements
      const $localModal = document.getElementById("localModal");
      const $localModalClose = document.getElementById("localModalClose");
      const $localModalSkip = document.getElementById("localModalSkip");
      const $localModalApply = document.getElementById("localModalApply");
      const $localModalListWrap = document.getElementById("localModalListWrap");

      // Resume draft modal elements (Listing tool)
      const $resumeModal = document.getElementById("pawResumeModal");
      const $resumeClose = document.getElementById("pawResumeClose");
      const $resumeMeta = document.getElementById("pawResumeMeta");
      const $resumeFresh = document.getElementById("pawResumeFresh");
      const $resumeGo = document.getElementById("pawResumeGo");


      const HIGHLIGHTS_TOKEN = "__PAW_HIGHLIGHTS__";

      // ==========================================================
      // POI (Nearby Highlights) workflow — BEFORE first deliverable
      // ----------------------------------------------------------
      // Product contract (LOCKED):
      // - If we can determine City+State (from fields OR pasted input), we offer POIs BEFORE generating.
      // - The POI modal is shown at most once per session, and never again after the first deliverable is generated.
      // - Reset returns the tool to "first time" state (POI can appear again).
      // - Even if no POIs are found, the modal still provides a write-in option and can be skipped.
      // - POIs never block output: user can bypass with "Keep as-is".
      // ==========================================================

      // State for the one-time POI gate (per session)
      let poiGateCompleted = false;     // true after user clicks Skip or Apply (not merely opening)
      let poiFirstDeliverableDone = false; // true after the first listing description is generated
      let poiPendingUserText = "";      // the user prompt we will send after POI step
      let poiCtx = { city: "", state: "" }; // effective location for POI lookup + payload

      let cachedHighlights = []; // {id,label}
      let poiLoading = false;

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ const t = normText(v); return t ? t : ""; }

      function mapType(v){ return normText(v) || "general"; }
      function mapTone(v){ return normText(v) || "general"; }
      function mapLen(v){ return normText(v) || "standard"; }

      function cityVal(){ return normText($city.value); }
      function stateVal(){ return normText($state.value).toUpperCase(); }

      // ==========================================================
      // Local Save + Resume (Listing tool)
      // ----------------------------------------------------------
      // Product contract (LOCKED):
      // - Draft is stored ONLY on this device (localStorage).
      // - We NEVER silently restore.
      // - On load, if a draft exists, we show Resume vs Start fresh.
      // - Reset and "Start fresh" both perform a full wipe AND delete the draft.
      // - Draft does not auto-expire; it stays until user starts fresh or resets.
      // ==========================================================

      const DRAFT_KEY = "paw:listing_description_writer:draft:v1";
      let __activeWorkLoadSeq = 0;
      let __worksSaving = false;

      // Draft safety caps (localStorage is limited; large MLS pastes can exceed quotas)
      const MAX_DRAFT_INPUT_CHARS = 50000;   // ~50k chars of pasted listing/context
      const MAX_DRAFT_FIELD_CHARS = 5000;    // single-line fields (ex: compelling feature)
      const MAX_DRAFT_HISTORY_ITEMS = 30;    // last N chat turns (user+assistant)
      const MAX_DRAFT_SHELL_INPUT_CHARS = 8000;

      function trunc(s, max){
        s = (s == null) ? "" : String(s);
        if (!max || max <= 0) return "";
        return s.length > max ? s.slice(0, max) : s;
      }


      function storageGet(key){
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (_) { return null; }
      }
      function storageSet(key, val){
        try { localStorage.setItem(key, JSON.stringify(val)); return true; } catch (_) { return false; }
      }
      function storageDel(key){
        try { localStorage.removeItem(key); return true; } catch (_) { return false; }
      }

      let __draftSaveT = null;
      let __draftSaveFailWarned = false; // prevent repeated toasts

      function scheduleDraftSave(){
        try {
          if (__draftSaveT) clearTimeout(__draftSaveT);
          __draftSaveT = setTimeout(saveDraftNow, 350);
        } catch (_) {}
      }

      function buildDraft(){
        const rawShellState = (shell && shell.getState) ? shell.getState() : { history: [], input: "" };
        // Cap draft size to reduce storage failures on huge pastes/conversations.
        const shellState = {
          history: Array.isArray(rawShellState.history) ? rawShellState.history.slice(-MAX_DRAFT_HISTORY_ITEMS) : [],
          input: trunc(rawShellState.input, MAX_DRAFT_SHELL_INPUT_CHARS)
        };

        return {
          v: 1,
          updatedAt: new Date().toISOString(),
          toolId: "listing_description_writer",
          form: {
            type: $type ? $type.value : "",
            tone: $tone ? $tone.value : "",
            len:  $len ? $len.value : "",
            city: $city ? $city.value : "",
            state: $state ? $state.value : "",
            beds: $beds ? $beds.value : "",
            baths: $baths ? $baths.value : "",
            sqft: $sqft ? $sqft.value : "",
            price: $price ? $price.value : "",
            pool: $pool ? $pool.value : "",
            porch: $porch ? $porch.value : "",
            compelling: trunc($compelling ? $compelling.value : "", MAX_DRAFT_FIELD_CHARS),
            input: trunc($input ? $input.value : "", MAX_DRAFT_INPUT_CHARS)
          },
          poi: {
            poiGateCompleted,
            poiFirstDeliverableDone,
            poiPendingUserText,
            poiCtx,
            cachedHighlights,
            poiLoading
          },
          shell: shellState
        };
      }

      function saveDraftNow(){
        try {
          const d = buildDraft();
          // If the session is completely blank, do not keep a draft around.
          const hasAny =
            (d.form && Object.values(d.form).some(v => normText(v))) ||
            (d.shell && Array.isArray(d.shell.history) && d.shell.history.length);

          if (!hasAny) {
            storageDel(DRAFT_KEY);
            return;
          }
          const ok = storageSet(DRAFT_KEY, d);
          if (!ok && !__draftSaveFailWarned) {
            __draftSaveFailWarned = true;
            try { if (shell && shell.toast) shell.toast("Draft couldn’t be saved on this device/browser."); } catch (_) {}
          }
        } catch (_) {}
      }

      function openResumeModal(draft){
        try {
          if (!$resumeModal) return;
          const d = draft || {};
          const ts = d.updatedAt ? new Date(d.updatedAt) : null;
          const when = ts && !isNaN(ts.getTime()) ? ts.toLocaleString() : "";
          const c = d.form && d.form.city ? String(d.form.city || "").trim() : "";
          const s = d.form && d.form.state ? String(d.form.state || "").trim().toUpperCase() : "";
          const loc = (c && s) ? ` (${c}, ${s})` : (c ? ` (${c})` : "");

          $resumeMeta.textContent = `We found a saved draft on this device${loc}.` + (when ? ` Last saved: ${when}.` : "");

          $resumeModal.classList.add("show");
          $resumeModal.setAttribute("aria-hidden", "false");
        } catch (_) {}
      }

      function closeResumeModal(){
        try {
          if (!$resumeModal) return;
          $resumeModal.classList.remove("show");
          $resumeModal.setAttribute("aria-hidden", "true");
        } catch (_) {}
      }

      function applyDraft(draft){
        const d = draft && typeof draft === "object" ? draft : null;
        if (!d) return false;

        try {
          // Restore form fields
          const f = d.form || {};
          if ($type) $type.value = f.type || "";
          if ($tone) $tone.value = f.tone || "";
          if ($len)  $len.value  = f.len || "";
          if ($city) $city.value = f.city || "";
          if ($state) $state.value = f.state || "";
          if ($beds) $beds.value = f.beds || "";
          if ($baths) $baths.value = f.baths || "";
          if ($sqft) $sqft.value = f.sqft || "";
          if ($price) $price.value = f.price || "";
          if ($pool) $pool.value = f.pool || "";
          if ($porch) $porch.value = f.porch || "";
          if ($compelling) $compelling.value = f.compelling || "";
          if ($input) $input.value = f.input || "";

          // Restore POI flags/state
          const p = d.poi || {};
          poiGateCompleted = !!p.poiGateCompleted;
          poiFirstDeliverableDone = !!p.poiFirstDeliverableDone;
          poiPendingUserText = String(p.poiPendingUserText || "");
          poiCtx = p.poiCtx && typeof p.poiCtx === "object" ? p.poiCtx : { city: "", state: "" };
          cachedHighlights = Array.isArray(p.cachedHighlights) ? p.cachedHighlights : [];
          poiLoading = !!p.poiLoading;

          // Never restore an open modal. Start from a clean UI surface.
          closeLocalModal();
          closeResumeModal();

          // Restore chat history
          if (shell && shell.setState && d.shell) shell.setState(d.shell);

          return true;
        } catch (_) {
          return false;
        }
      }

      function fullReset(){
        // FULL reset = guaranteed fresh session for a new property.
        // Clears: tool fields, composer, chat, POI workflow, modals, and local draft.
        try { storageDel(DRAFT_KEY); } catch (_) {}

        // POI workflow state
        poiGateCompleted = false;
        poiFirstDeliverableDone = false;
        poiPendingUserText = "";
        poiCtx = { city: "", state: "" };
        cachedHighlights = [];
        poiLoading = false;

        // Close modals
        closeLocalModal();
        closeResumeModal();

        // Clear fields
        try {
          if ($type) $type.value = "";
          if ($tone) $tone.value = "";
          if ($len)  $len.value = "";
          if ($city) $city.value = "";
          if ($state) $state.value = "";
          if ($beds) $beds.value = "";
          if ($baths) $baths.value = "";
          if ($sqft) $sqft.value = "";
          if ($price) $price.value = "";
          if ($pool) $pool.value = "";
          if ($porch) $porch.value = "";
          if ($compelling) $compelling.value = "";
          if ($input) $input.value = "";
        } catch (_) {}

        // Clear shell thread
        try { if (shell && shell.reset) shell.reset(); } catch (_) {}
      }


      // Conservative extraction: only accept "City, ST" style signals.
      // We avoid guessing; if we cannot determine it confidently, we don't gate.
      function inferCityStateFromText(text){
        const t = String(text || "");
        // Match: City, ST (e.g., "Austin, TX"). City must be 3+ letters to reduce false positives.
        const re = /\b([A-Za-z][A-Za-z .'-]{2,})\s*,\s*([A-Z]{2})\b/g;
        let m;
        while ((m = re.exec(t)) !== null){
          const city = normText(m[1]);
          const st = normText(m[2]).toUpperCase();
          if (city && st && st.length === 2) return { city, state: st };
        }
        return { city:"", state:"" };
      }

      function effectiveCityState(userText){
        const c = cityVal();
        const s = stateVal();
        if (c && s) return { city: c, state: s };

        const inferred = inferCityStateFromText(userText);
        if (inferred.city && inferred.state) return inferred;

        return { city:"", state:"" };
      }

      function locationVal(city, state){
        const c = normText(city), s = normText(state).toUpperCase();
        if (c && s) return `${c}, ${s}`;
        if (s) return s;
        return c;
      }

      function escapeHtml(str){
        return String(str || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      function coerceHighlightLabel(item){
        if (item == null) return "";
        if (typeof item === "string") return item.trim();
        if (typeof item === "number") return String(item);
        if (typeof item === "object") {
          return String(item.label || item.name || item.title || item.text || item.value || "").trim();
        }
        return String(item).trim();
      }

      function isBadHighlightLabel(label){
        const t = String(label || "").toLowerCase();
        return (
          !t ||
          t.includes("please provide") ||
          t.includes("city/state") ||
          t.includes("zip code") ||
          (t.includes("zip") && t.includes("provide"))
        );
      }

      function pickHighlightsForModal(allHighlights){
        // Goal: 3 larger-area / widely recognizable POIs + 2 hyper-local POIs
        const c = (poiCtx.city || "").toLowerCase();

        const majorKeywords = [
          "downtown","airport","university","college","hospital","medical","mall","museum","stadium",
          "national","state park","lake","river","historic","convention","zoo","botanical",
          "resort","ski","mountain","trail","greenway"
        ];
        const localKeywords = [
          "elementary","middle","high school","school","community","neighborhood","greenway","trail",
          "park","playground","library","rec center","recreation","shopping","grocery","farmers"
        ];

        function score(label, keywords, base){
          const t = String(label||"").toLowerCase();
          let s = base || 0;
          for (const k of keywords){
            if (t.includes(k)) s += 3;
          }
          // Prefer recognizable names (slightly longer) but avoid overly wordy
          if (t.length >= 18) s += 1;
          if (t.length >= 40) s -= 1;
          return s;
        }

        const items = (Array.isArray(allHighlights) ? allHighlights : []).map(h => ({
          id: h.id,
          label: h.label,
          majorScore: score(h.label, majorKeywords, 0) + (c && String(h.label||"").toLowerCase().includes(c) ? -2 : 0),
          localScore: score(h.label, localKeywords, 0) + (c && String(h.label||"").toLowerCase().includes(c) ? 2 : 0)
        }));

        // Dedup by label
        const seen = new Set();
        const deduped = [];
        for (const it of items){
          const key = String(it.label||"").trim().toLowerCase();
          if (!key || seen.has(key)) continue;
          seen.add(key);
          deduped.push(it);
        }

        // Pick top 3 major
        const major = deduped
          .slice()
          .sort((a,b) => (b.majorScore - a.majorScore) || a.label.localeCompare(b.label))
          .slice(0,3);

        const majorSet = new Set(major.map(x => x.label.toLowerCase()));

        // Pick top 2 local from remaining
        const locals = deduped
          .filter(x => !majorSet.has(x.label.toLowerCase()))
          .slice()
          .sort((a,b) => (b.localScore - a.localScore) || a.label.localeCompare(b.label))
          .slice(0,2);

        // Fill if we didn't have enough
        const picked = [...major, ...locals];
        if (picked.length < 5){
          for (const it of deduped){
            if (picked.length >= 5) break;
            if (picked.some(p => p.label.toLowerCase() === it.label.toLowerCase())) continue;
            picked.push(it);
          }
        }
        return picked.slice(0,5).map(x => ({ id: x.id, label: x.label }));
      }

      function renderPoiModalContent(highlights){
        cachedHighlights = pickHighlightsForModal(highlights);

        let html = '<div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">';

        // Suggested picks (optional)
        if (cachedHighlights.length) {
          cachedHighlights.forEach((h, idx) => {
            const id = `lh_pick_${idx}`;
            html += `
              <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
                <input id="${id}" type="checkbox" style="margin-top:2px;" />
                <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">${escapeHtml(h.label)}</span>
              </label>
            `;
          });
        }

        // Custom highlight (always available)
        html += `
          <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
            <input id="lh_custom_check" type="checkbox" style="margin-top:2px;" />
            <span style="display:flex; flex-direction:column; gap:6px; width:100%;">
              <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">Add your own highlight</span>
              <input id="lh_custom_text" type="text" placeholder="Example: 2023 roof, quartz counters, walkable to shops" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.12); border-radius:10px; font-size:14px;" />
            </span>
          </label>
        `;

        html += '</div>';
        $localModalListWrap.innerHTML = `<div class="poi-body" style="min-height:220px;">${html}</div>`;

        // If agent types a custom highlight, ensure it will be included
        const _ct = document.getElementById("lh_custom_text");
        const _cc = document.getElementById("lh_custom_check");
        if (_ct && _cc) {
          _ct.addEventListener("input", () => { if (normText(_ct.value)) _cc.checked = true; });
        }

        // Enable apply now that we have rendered options
        try { $localModalApply.disabled = false; } catch {}
      }

      function openPoiModalLoading(){
        cachedHighlights = [];
        poiLoading = true;

        // Disable apply while loading
        try { $localModalApply.disabled = true; } catch {}

        $localModalListWrap.innerHTML = `
  <div class="poi-body" style="min-height:220px;">
    <div class="poi-loading">
      <div class="paw-thinking" style="font-size:14px; color:rgba(15,23,42,.72);">Finding nearby highlights<span class="paw-dots"><span class="paw-dot"></span><span class="paw-dot"></span><span class="paw-dot"></span></span></div>
    </div>
  </div>
`;

        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }

      function openPoiModalWithHighlights(highlights){
        poiLoading = false;
        renderPoiModalContent(highlights);
        // Modal might already be open; ensure visible anyway.
        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }

      function closeLocalModal(){
        poiLoading = false;
        $localModal.classList.remove("show");
        $localModal.setAttribute("aria-hidden", "true");
        $localModalListWrap.innerHTML = "";
        try { $localModalApply.disabled = false; } catch {}
      }

      function getModalSelections(){
        const selected = [];
        cachedHighlights.forEach((h, idx) => {
          const cb = document.getElementById(`lh_pick_${idx}`);
          if (cb && cb.checked) selected.push(h.label);
        });

        const customTextEl = document.getElementById("lh_custom_text");
        const customText = customTextEl ? normText(customTextEl.value) : "";
        if (customText) selected.push(customText);

        return selected;
      }
const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        tipsText: TIPS_TEXT,
        deliverableTitle: "Your MLS Description",

        getPrefs: () => ({
          listing_type: mapType($type.value),
          output_use: "MLS",
          tone: mapTone($tone.value),
          length: mapLen($len.value),
          safe_mode: true,
          ask_followups: false,

          city: cityVal(),
          state: stateVal(),
          location: locationVal(cityVal(), stateVal()),

          // allow worker to know local context exists
          local_highlights: (!!cityVal() && !!stateVal()),

          compelling_feature: normText($compelling.value),

          locked: {
            beds: normEnum($beds.value),
            baths: normEnum($baths.value),
            sqft: digitsOnly($sqft.value),
            price: normText($price.value),
            pool: normEnum($pool.value),
            porch: normEnum($porch.value)
          }
        }),

        // This runs on every submit, so we can arm the offer reliably.
        getExtraPayload: (text) => {
          // Extra payload is derived from whatever location context we can determine.
          // IMPORTANT: We do not guess. If we can't confidently extract City+State, we omit it.
          const msg = String(text || "").trim();

          // Highlights lookup uses the POI context captured at gate time.
          if (msg === HIGHLIGHTS_TOKEN) {
            if (!poiCtx.city || !poiCtx.state) return {};
            return {
              phase: "highlights",
              city: poiCtx.city,
              state: poiCtx.state,
              location: locationVal(poiCtx.city, poiCtx.state)
            };
          }

          const loc = effectiveCityState(msg);
          return {
            city: loc.city,
            state: loc.state,
            location: locationVal(loc.city, loc.state),
            local_highlights: !!(loc.city && loc.state)
          };
        },

        // Gate sending BEFORE the first deliverable when City+State is available.
        // This prevents "POIs after output" regressions and keeps flow predictable.
        beforeSend: async (userText, helpers) => {
          try {
            // Only gate before the first description is generated.
            if (poiFirstDeliverableDone) return;

            // Only gate once per session, unless user closes the modal without choosing.
            if (poiGateCompleted) return;

            const loc = effectiveCityState(userText);
            if (!loc.city || !loc.state) return;

            // Capture state for this run
            poiPendingUserText = String(userText || "");
            poiCtx = { city: loc.city, state: loc.state };

            // Open modal immediately (loading), then fetch POIs in the background.
            openPoiModalLoading();

            // Clear composer since the send will happen after POI selection/skip.
            if (helpers && helpers.clearComposer) helpers.clearComposer({ keepPlaceholder: true });

            // Ask the Worker for nearby highlights (no user echo).
            if (helpers && helpers.sendExtra) {
              await helpers.sendExtra(HIGHLIGHTS_TOKEN, { phase: "highlights" }, { echoUser: false });

              // Fallback: if the Worker doesn't return structured POIs (data.local.highlights),
              // don't leave the user stuck on the loading state. Show write-in-only choices.
              if (poiLoading) {
                openPoiModalWithHighlights([]);
              }
            }

            // Cancel the default sendMessage flow.
            return { cancel: true };
          } catch (_) {
            // If anything goes wrong, fail open (do not block generation).
            closeLocalModal();
            return;
          }
        },

        onResponse: (data) => {
          const reply = data && typeof data.reply === "string" ? data.reply : "";

          // Highlights response: render the POI options (or write-in only).
          const isHighlightsResponse = !!(data && data.local && Array.isArray(data.local.highlights));
          if (isHighlightsResponse) {
            const highlightsRaw = data.local.highlights || [];
            const normalized = highlightsRaw
              .map((it, i) => ({
                id: String((it && typeof it === "object" && (it.id || it.key)) ? (it.id || it.key) : (i + 1)),
                label: coerceHighlightLabel(it)
              }))
              .filter(x => x.label && !isBadHighlightLabel(x.label));

            // Even if empty, we still show the modal (write-in option is always present).
            openPoiModalWithHighlights(normalized);
            return { skipDefault: true };
          }

          
          // Fallback: if we are currently waiting on POIs but the Worker did not return structured highlights,
          // finish the loading state by showing write-in-only options. This keeps the UX responsive without
          // surfacing any error text to the user.
          if (poiLoading) {
            openPoiModalWithHighlights([]);
            return { skipDefault: true };
          }

// Mark the first deliverable as done after any normal reply.
          if (reply) {
            poiFirstDeliverableDone = true;
          }

          // Ignore any “provide city/state or zip” prompt silently (fail-safe).
          const lower = String(reply || "").toLowerCase();
          if (lower.includes("provide") && (lower.includes("city/state") || lower.includes("zip"))) {
            return { skipDefault: true };
          }
        }
      });

      // ==========================================================
      // POI modal controls
      // ==========================================================
      $localModalClose.addEventListener("click", () => closeLocalModal());
      $localModal.addEventListener("click", (e) => { if (e.target === $localModal) closeLocalModal(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLocalModal(); });

      // Skip / Keep as-is: proceed to generate WITHOUT forcing POIs.
      $localModalSkip.addEventListener("click", async () => {
        closeLocalModal();
        poiGateCompleted = true;

        const msg = poiPendingUserText;
        poiPendingUserText = "";

        if (!msg) return;
        await shell.sendExtra(msg, { city: poiCtx.city, state: poiCtx.state, location: locationVal(poiCtx.city, poiCtx.state) }, { echoUser: true });
      });

      // Apply: proceed to generate WITH selected POIs as context.
      $localModalApply.addEventListener("click", async () => {
        const picked = getModalSelections();
        closeLocalModal();
        poiGateCompleted = true;

        const baseMsg = poiPendingUserText;
        poiPendingUserText = "";

        if (!baseMsg) return;

        let msg = baseMsg;
        if (picked && picked.length) {
          msg += `\n\nNearby highlights to consider (include only if accurate and relevant):\n- ${picked.join("\n- ")}`;
        }

        await shell.sendExtra(
          msg,
          {
            city: poiCtx.city,
            state: poiCtx.state,
            location: locationVal(poiCtx.city, poiCtx.state),
            selected_highlights: picked || []
          },
          { echoUser: true }
        );
      });

      // Reset
// Reset
      document.getElementById("reset").addEventListener("click", (e) => {
        try { e.preventDefault(); e.stopImmediatePropagation(); } catch (_) {}
        try {
          const d = buildDraft();
          const hasAny =
            (d.form && Object.values(d.form).some(v => normText(v))) ||
            (d.shell && Array.isArray(d.shell.history) && d.shell.history.length);
          if (hasAny) {
            const ok = window.confirm("Reset will clear this session and start fresh for a new listing. Continue?");
            if (!ok) return;
          }
        } catch (_) {}
        fullReset();
      }, true);

      // ==========================================================
      // Autosave wiring (Listing tool)
      // ==========================================================
      [
        $type,$tone,$len,$city,$state,$beds,$baths,$sqft,$price,$pool,$porch,$compelling,$input
      ].forEach((el) => {
        try {
          if (!el) return;
          el.addEventListener("input", scheduleDraftSave);
          el.addEventListener("change", scheduleDraftSave);
        } catch (_) {}
      });

      // Best-effort save when the user leaves the page/tab.
      window.addEventListener("beforeunload", () => { try { saveDraftNow(); } catch (_) {} });

      // ==========================================================
      // Resume modal controls (Listing tool)
      // ==========================================================
      try { if ($resumeClose) $resumeClose.addEventListener("click", () => closeResumeModal()); } catch (_) {}
      try {
        if ($resumeModal) $resumeModal.addEventListener("click", (e) => { if (e.target === $resumeModal) closeResumeModal(); });
      } catch (_) {}
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") { closeResumeModal(); } });

      try {
        if ($resumeFresh) $resumeFresh.addEventListener("click", () => {
          closeResumeModal();
          fullReset();
        });
      } catch (_) {}

      try {
        if ($resumeGo) $resumeGo.addEventListener("click", () => {
          const d = storageGet(DRAFT_KEY);
          closeResumeModal();
          if (d) applyDraft(d);
        });
      } catch (_) {}

      // On load: if a draft exists, ask user what to do (NEVER silent restore)
      const existingDraft = storageGet(DRAFT_KEY);
      if (existingDraft) {
        openResumeModal(existingDraft);
      }

      // ==========================================================
      // Works -> Listing restore hook
      // ----------------------------------------------------------
      // When active work changes, load listing payload for listings bucket.
      // ==========================================================
      window.addEventListener("paw:works:active_changed", async (e) => {
        const seq = ++__activeWorkLoadSeq;
        try {
          const aw = e && e.detail ? e.detail.active_work : null;
          if (!aw) return;

          const bucket = String(aw.bucket || "").trim();
          if (bucket !== "listings") return;

          const workId = String(aw.id || aw.work_id || "").trim();
          if (!workId) return;

          let token = "";
          try { token = (window.PAWAuth && window.PAWAuth.getToken) ? String(window.PAWAuth.getToken() || "") : ""; } catch (_) {}
          if (!token) {
            try {
              if (window.PAWAuth && window.PAWAuth.whenReady) {
                await window.PAWAuth.whenReady().catch(() => {});
                token = (window.PAWAuth && window.PAWAuth.getToken) ? String(window.PAWAuth.getToken() || "") : "";
              }
            } catch (_) {}
          }
          if (!token) {
            try { if (shell && shell.toast) shell.toast("Not signed in yet. Please try again."); } catch (_) {}
            return;
          }

          const url = String(API_ENDPOINT).replace(/\/+$/, "") + "/myworks/" + encodeURIComponent(workId);

          let res = await fetch(url, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            }
          });

          let data = await res.json().catch(() => ({}));
          if (seq !== __activeWorkLoadSeq) return;

          if ((res.status === 401 || res.status === 403)) {
            try {
              if (window.PAWAuth && window.PAWAuth.whenReady) {
                await window.PAWAuth.whenReady().catch(() => {});
              }
              token = (window.PAWAuth && window.PAWAuth.getToken) ? String(window.PAWAuth.getToken() || "") : "";
            } catch (_) {}

            if (token) {
              res = await fetch(url, {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer " + token
                }
              });
              data = await res.json().catch(() => ({}));
              if (seq !== __activeWorkLoadSeq) return;
            }
          }

          if (!res.ok) {
            try {
              if (res.status === 401 || res.status === 403) {
                if (shell && shell.toast) shell.toast("Session expired. Please try again.");
              } else {
                const msg = (data && (data.error || data.message)) ? String(data.error || data.message) : "Couldn’t load this work right now.";
                if (shell && shell.toast) shell.toast(msg);
              }
            } catch (_) {}
            return;
          }

          const payload = data && data.data && data.data.work ? data.data.work.payload : null;
          const newToolState = (payload && typeof payload === "object" && payload.tool_state && typeof payload.tool_state === "object")
            ? payload.tool_state
            : null;
          const legacyDraft = (payload && typeof payload === "object" && payload.form && payload.shell)
            ? payload
            : null;
          const draftToApply = newToolState || legacyDraft;

          if (!draftToApply) {
            try { if (shell && shell.toast) shell.toast("This work doesn’t have saved content yet."); } catch (_) {}
            return;
          }

          applyDraft(draftToApply);
        } catch (_) {
          if (seq !== __activeWorkLoadSeq) return;
          try { if (shell && shell.toast) shell.toast("Couldn’t load this work right now."); } catch (_) {}
        }
      });

      window.addEventListener("paw:works:save_current_output", async (e) => {
        if (__worksSaving) return;

        const detail = e && e.detail ? e.detail : {};
        const intent = String(detail.intent || "").trim();
        if (intent !== "save_updates") return;

        const aw = detail.active_work || null;
        if (!aw) return;

        const bucket = String(aw.bucket || "").trim();
        if (bucket !== "listings") return;

        const workId = String(aw.id || aw.work_id || "").trim();
        if (!workId) return;

        let token = "";
        try { token = (window.PAWAuth && window.PAWAuth.getToken) ? String(window.PAWAuth.getToken() || "") : ""; } catch (_) {}
        if (!token) {
          try {
            if (window.PAWAuth && window.PAWAuth.whenReady) {
              await window.PAWAuth.whenReady().catch(() => {});
              token = (window.PAWAuth && window.PAWAuth.getToken) ? String(window.PAWAuth.getToken() || "") : "";
            }
          } catch (_) {}
        }
        if (!token) {
          try { if (shell && shell.toast) shell.toast("Not signed in yet. Please try again."); } catch (_) {}
          return;
        }

        __worksSaving = true;
        try {
          const draft = buildDraft();
          const form = (draft && draft.form && typeof draft.form === "object") ? draft.form : {};
          const title = String((aw && aw.label) ? aw.label : "Untitled");
          let finalOutput = "";
          try {
            const bubbles = document.querySelectorAll("#messages .msg.ai .bubble");
            if (bubbles && bubbles.length) {
              finalOutput = String((bubbles[bubbles.length - 1] && bubbles[bubbles.length - 1].textContent) || "").trim();
            }
          } catch (_) {}

          const tone = String(form.tone || "").trim();
          const len = String(form.len || "").trim();
          const poi = (draft && draft.poi && typeof draft.poi === "object") ? draft.poi : {};
          const poiCtx = (poi && poi.poiCtx && typeof poi.poiCtx === "object") ? poi.poiCtx : {};
          const city = String(form.city || poiCtx.city || "").trim();
          const state = String(form.state || poiCtx.state || "").trim();
          const location = city && state
            ? (city + ", " + state)
            : (city || state || "the selected location");
          const toneLabel = tone || "default";
          const lenLabel = len || "default";

          const portable = {
            title,
            facts: {
              type: String(form.type || ""),
              tone: String(form.tone || ""),
              len: String(form.len || ""),
              city: city,
              state: state,
              beds: String(form.beds || ""),
              baths: String(form.baths || ""),
              sqft: String(form.sqft || ""),
              price: String(form.price || ""),
              pool: String(form.pool || ""),
              porch: String(form.porch || ""),
              compelling: String(form.compelling || "")
            },
            final_output: finalOutput,
            intent_text: "Create a listing description (Tone: " + toneLabel + ", Length: " + lenLabel + ") for a property in " + location + "."
          };

          const payloadToSave = {
            v: 1,
            origin_tool: "listing",
            content_kind: "listing_description",
            tool_state: draft,
            portable
          };
          const url = String(API_ENDPOINT).replace(/\/+$/, "") + "/myworks/" + encodeURIComponent(workId);

          let res = await fetch(url, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ payload: payloadToSave })
          });

          let data = await res.json().catch(() => ({}));

          if ((res.status === 401 || res.status === 403)) {
            try {
              if (window.PAWAuth && window.PAWAuth.whenReady) {
                await window.PAWAuth.whenReady().catch(() => {});
              }
              token = (window.PAWAuth && window.PAWAuth.getToken) ? String(window.PAWAuth.getToken() || "") : "";
            } catch (_) {}

            if (token) {
              res = await fetch(url, {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ payload: payloadToSave })
              });
              data = await res.json().catch(() => ({}));
            }
          }

          if (!res.ok) {
            try {
              const msg = (data && (data.error || data.message)) ? String(data.error || data.message) : "Couldn’t save right now.";
              if (shell && shell.toast) shell.toast(msg);
            } catch (_) {}
            return;
          }

          try { if (shell && shell.toast) shell.toast("Saved."); } catch (_) {}
        } catch (_) {
          try { if (shell && shell.toast) shell.toast("Couldn’t save right now."); } catch (_) {}
        } finally {
          __worksSaving = false;
        }
      });

})();
</script>

  <!-- ==========================================================
       PAW Iframe Height Reporter (v1.1 - loop-safe, STANDARD)
       ----------------------------------------------------------
       PURPOSE:
       - Reports the tool's visible panel height to the Circle parent page.
       - Enables "grow-to-fit" embeds with no internal scrollbars.
       - STANDARDIZED across all tools so Work: Ready behaves identically everywhere.
       CONTRACT:
       - Sends: { type: "paw_iframe_height_request_v1", height: <number> }
       ========================================================== -->
  <script>
    (function () {
      if (window.__PAW_HEIGHT_REPORTER_V11__) return;
      window.__PAW_HEIGHT_REPORTER_V11__ = true;

      var lastSent = 0;
      var rafPending = false;
      var IGNORE_DELTA_PX = 8;

      function px(n){ n = Number(n); return isFinite(n) ? n : 0; }

      function measureContentHeight() {
        try {
          // Prefer the visible "panel" container (consistent across PAW tools)
          var panel = document.querySelector(".panel");
          if (panel && panel.getBoundingClientRect) {
            var r = panel.getBoundingClientRect();
            return Math.ceil(px(r.height));
          }

          // Fallback: sum key areas if present
          var topbar = document.querySelector(".panel-topbar");
          var messages = document.getElementById("messages") || document.querySelector(".messages");
          var composer = document.querySelector(".composer");

          var h = 0;
          if (topbar && topbar.getBoundingClientRect) h += px(topbar.getBoundingClientRect().height);
          if (messages && messages.getBoundingClientRect) h += px(messages.getBoundingClientRect().height);
          if (composer && composer.getBoundingClientRect) h += px(composer.getBoundingClientRect().height);

          if (h > 0) return Math.ceil(h);

          // Last-resort fallback (for simpler layouts)
          var d = document.documentElement;
          return Math.ceil(Math.max(px(d.scrollHeight), px(d.offsetHeight)));
        } catch (_) {
          return 0;
        }
      }

      function postHeight(force) {
        var h = measureContentHeight();
        if (!h) return;

        if (!force && Math.abs(h - lastSent) < IGNORE_DELTA_PX) return;
        lastSent = h;

        try {
          window.parent.postMessage(
            { type: "paw_iframe_height_request_v1", height: h },
            "*"
          );
        } catch (_) {}
      }

      function schedule(force) {
        if (rafPending) return;
        rafPending = true;
        requestAnimationFrame(function () {
          rafPending = false;
          postHeight(!!force);
        });
      }

      // Initial + settle passes (fonts/images/layout settle)
      schedule(true);
      setTimeout(function(){ schedule(true); }, 120);
      setTimeout(function(){ schedule(true); }, 400);

      // DOM changes (chat streaming, Work mode swap, modal open/close, etc.)
      try {
        var mo = new MutationObserver(function(){ schedule(false); });
        mo.observe(document.body, { childList:true, subtree:true, characterData:true });
      } catch (_) {}

      // Images loading after insertion
      document.addEventListener("load", function(e){
        try { if (e.target && e.target.tagName === "IMG") schedule(false); } catch (_) {}
      }, true);

      // Resize/orientation/keyboard changes
      window.addEventListener("resize", function(){ schedule(true); });
    })();
  </script>

</body>
</html>
