<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="/paw-ui.css">
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <!-- TOP BAR (Row 1) -->
        <div class="panel-topbar">
          <div class="topbar-row1">
            <div class="topbar-left">
              <div class="ctl">
                <label for="typeSel">Type</label>
                <span class="select-wrap">
                  <select id="typeSel">
                    <option value="" selected>Choose…</option>
                    <option value="general">General</option>
                    <option value="starter">Starter</option>
                    <option value="moveup">Move-Up</option>
                    <option value="luxury">Luxury</option>
                    <option value="investor">Investor</option>
                    <option value="relocation">Relocation</option>
                  </select>
                </span>
              </div>

              <div class="ctl">
                <label for="toneSel">Tone</label>
                <span class="select-wrap">
                  <select id="toneSel">
                    <option value="" selected>Choose…</option>
                    <option value="general">General</option>
                    <option value="professional">Professional</option>
                    <option value="warm">Warm</option>
                    <option value="elevated">Elevated</option>
                  </select>
                </span>
              </div>

              <div class="ctl">
                <label for="lenSel">Length</label>
                <span class="select-wrap">
                  <select id="lenSel">
                    <option value="" selected>Choose…</option>
                    <option value="standard">Standard</option>
                    <option value="short">Short</option>
                    <option value="long">Long</option>
                  </select>
                </span>
              </div>
            </div>

            <div class="topbar-right">
              <!-- standardized utility pair: Reset + Tips -->
              <div class="utility-pair" role="group" aria-label="Tool utilities">
                <button id="reset" class="util-btn" type="button">Reset</button>
                <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
              </div>
            </div>
          </div>

          <!-- LOCK KEY FACTS (Row 2) -->
          <div class="topbar-row2">
            <div class="lock-head">
              <div class="lock-title">Lock key facts (optional)</div>

              <label class="check check-plain" for="localChk" title="Generate a shortlist of local highlights before writing">
                <input id="localChk" type="checkbox" />
                <span>Add Local Highlights</span>
              </label>
            </div>

            <!-- one-line grid when room -->
            <div class="lock-grid">
              <div class="field">
                <label for="bedsSel">Beds</label>
                <select id="bedsSel">
                  <option value="" selected>—</option>
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8+</option>
                </select>
              </div>

              <div class="field">
                <label for="bathsSel">Baths</label>
                <select id="bathsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option>
                  <option value="1.5">1.5</option>
                  <option value="2">2</option>
                  <option value="2.5">2.5</option>
                  <option value="3">3</option>
                  <option value="3.5">3.5</option>
                  <option value="4">4</option>
                  <option value="4.5">4.5</option>
                  <option value="5">5+</option>
                </select>
              </div>

              <div class="field field-wide">
                <label for="sqftInp">Sqft</label>
                <input id="sqftInp" type="text" inputmode="numeric" placeholder="e.g. 1800" />
              </div>

              <div class="field">
                <label for="priceInp">Price</label>
                <input id="priceInp" type="text" placeholder="for context only" />
              </div>

              <div class="field">
                <label for="poolSel">Pool</label>
                <select id="poolSel">
                  <option value="" selected>—</option>
                  <option value="None">None</option>
                  <option value="Community">Community</option>
                  <option value="Private">Private</option>
                  <option value="Both">Both</option>
                  <option value="Unknown">Unknown</option>
                </select>
              </div>

              <div class="field">
                <label for="porchSel">Porch</label>
                <select id="porchSel">
                  <option value="" selected>—</option>
                  <option value="None">None</option>
                  <option value="Screened">Screened</option>
                  <option value="Enclosed">Enclosed</option>
                  <option value="Covered">Covered</option>
                  <option value="Unknown">Unknown</option>
                </select>
              </div>
            </div>

            <!-- second line: most compelling feature -->
            <div class="lock-row2">
              <div class="field field-wide">
                <label for="compellingInp">Most Compelling Feature</label>
                <input id="compellingInp" type="text" placeholder="Location, design, price advantage, lifestyle, etc" />
              </div>
            </div>
          </div>
        </div>

        <!-- optional local highlights selector panel (used when worker returns the list) -->
        <div id="localPanel" class="local-panel" aria-live="polite">
          <div class="local-head">
            <div>
              <div class="local-title">Suggested local highlights</div>
              <div class="local-sub">Select any that apply, then click “Write description.”</div>
            </div>
            <div class="local-actions">
              <button id="localSkip" class="btn" type="button">Skip</button>
              <button id="localWrite" class="btn primary" type="button">Write description</button>
            </div>
          </div>
          <ul id="localList" class="local-list"></ul>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="Provide additional information, city & state, thoughts, or paste listing data here"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <script src="/tool-shell.js"></script>

  <script>
    (function () {
      // IMPORTANT: Enable embed styling when loaded with ?embed=1
      try {
        const p = new URLSearchParams(location.search);
        if (p.get("embed") === "1") document.documentElement.dataset.embed = "1";
      } catch {}

      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $len  = document.getElementById("lenSel");

      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");
      const $local = document.getElementById("localChk");

      const $localPanel = document.getElementById("localPanel");
      const $localList = document.getElementById("localList");
      const $localWrite = document.getElementById("localWrite");
      const $localSkip = document.getElementById("localSkip");

      let lastNotesForLocal = "";
      let lastHighlights = []; // [{id,label}]

      const TIPS_TEXT =
`What this tool does
Generates MLS-ready listing remarks that are accurate, motivating, and Fair Housing–safe.

How to use it
• Fill in the key details above and/or paste notes/MLS data — messy is fine
• Include city & state when you can (helps local context)
• If something is unknown, leave it blank (or type “unknown”) and the tool will write conservatively
• Goal: create desire to tour without hype or risky claims

Your result
• When the description is ready, it appears in the “Your MLS Description” box
• Use the Copy button to paste it into MLS, email, or your marketing

Optional: Lock key facts
Use this when pasted notes/MLS fields may be wrong or incomplete. Locked facts override pasted content.

Most Compelling Feature
Add a quick angle (location, design, lifestyle, value). The tool will use it when it helps drive showings, but it won’t force it if it doesn’t fit.

Optional: Add Local Highlights (2-step)
1) Turn it on, then send your notes
2) Select highlights, then click “Write description”

Tip: If location isn’t clear, the tool may ask for city & state first.`;


      const mapType = (v) => ({
        general: "General",
        starter: "Starter",
        moveup: "Move-Up",
        luxury: "Luxury",
        investor: "Investor",
        relocation: "Relocation"
      }[v] || "Default");

      const mapTone = (v) => ({
        general: "General",
        professional: "Professional",
        warm: "Warm",
        elevated: "Elevated"
      }[v] || "Professional");

      const mapLen = (v) => ({
        standard: "Standard",
        short: "Short",
        long: "Long"
      }[v] || "Standard");

      const digitsOnly = (v) => String(v || "").replace(/[^\d]/g, "");
      const normEnum = (v) => {
        const s = String(v || "").trim();
        return (!s || /^unknown$/i.test(s) || s === "—") ? "" : s;
      };
      const normText = (v) => {
        const s = String(v || "").trim();
        return (!s || /^unknown$/i.test(s)) ? "" : s;
      };

      function hideLocalPanel(){
        $localPanel.style.display = "none";
        $localList.innerHTML = "";
        lastHighlights = [];
      }

      function showLocalPanel(highlights){
        lastHighlights = (Array.isArray(highlights) ? highlights : []);
        $localList.innerHTML = "";
        for (const h of lastHighlights){
          const li = document.createElement("li");
          li.className = "local-item";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = "lh_" + String(h.id);
          const lab = document.createElement("label");
          lab.setAttribute("for", cb.id);
          lab.textContent = String(h.label || "");
          li.appendChild(cb);
          li.appendChild(lab);
          $localList.appendChild(li);
        }
        $localPanel.style.display = lastHighlights.length ? "block" : "none";
      }

      function getSelectedHighlightLabels(){
        const selected = [];
        for (const h of lastHighlights){
          const cb = document.getElementById("lh_" + String(h.id));
          if (cb && cb.checked) selected.push(String(h.label || ""));
        }
        return selected;
      }

      $local.addEventListener("change", () => {
        if (!$local.checked) hideLocalPanel();
      });

      $localSkip.addEventListener("click", async () => {
        hideLocalPanel();
        if (!lastNotesForLocal) return;
        await shell.sendMessage(lastNotesForLocal, { phase: "write", selected_highlights: [] }, { echoUser: false });
      });

      $localWrite.addEventListener("click", async () => {
        hideLocalPanel();
        if (!lastNotesForLocal) return;
        const selected = getSelectedHighlightLabels();
        await shell.sendMessage(lastNotesForLocal, { phase: "write", selected_highlights: selected }, { echoUser: false });
      });

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        inputPlaceholder: "Provide additional information, city & state, thoughts, or paste listing data here",
        tipsText: TIPS_TEXT,
        sendHistoryItems: 8,
        maxHistoryItems: 16,

        getPrefs: () => ({
          listing_type: mapType($type.value),
          output_use: "MLS",
          tone: mapTone($tone.value),
          length: mapLen($len.value),
          safe_mode: true,
          ask_followups: true,
          local_highlights: !!$local.checked,
          compelling_feature: normText($compelling.value),
          locked: {
            beds: normEnum($beds.value),
            baths: normEnum($baths.value),
            sqft: digitsOnly($sqft.value),
            price: normText($price.value),
            pool: normEnum($pool.value),
            porch: normEnum($porch.value)
          }
        }),

        getExtraPayload: (text, ctx) => {
          const prefs = ctx.prefs || {};
          if (prefs.local_highlights){
            lastNotesForLocal = text;
            return { phase: "highlights" };
          }
          lastNotesForLocal = "";
          return {};
        },

        onResponse: (data, ctx) => {
          const prefs = (ctx && ctx.prefs) ? ctx.prefs : {};
          if (!prefs.local_highlights) return;

          const highlights = data && data.local && Array.isArray(data.local.highlights) ? data.local.highlights : null;
          if (highlights && highlights.length){
            showLocalPanel(highlights);
            return { skipDefault: true };
          }
        }
      });

      document.getElementById("reset").addEventListener("click", () => {
        hideLocalPanel();
        lastNotesForLocal = "";
      });

      hideLocalPanel();
    })();
  </script>
</body>
</html>
