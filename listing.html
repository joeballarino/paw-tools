<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>

  <!-- IMPORTANT: fully-qualified so embeds on proagentworks.com still load tool assets -->
  <link rel="stylesheet" href="https://paw-tools.pages.dev/paw-ui.css">

  <!--
    HEADER CONTRACT (LOCKED):
    - The panel top bar (.topbar-row0) MUST NEVER include a title.
    - It only contains: subtitle (left) + Reset/Tips buttons (right).
  -->
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">

          <div class="topbar-row0">
            <div class="tool-subtitle">MLS-ready listing remarks with built-in real estate expertise.</div>

            <div class="topbar-right">
              <button id="reset" class="util-btn" type="button">Reset</button>
              <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
            </div>
          </div>

          <div class="topbar-row1">
            <div class="controls-row controls-row-compact">

              <div class="control">
                <div class="field-label">Type</div>
                <select id="typeSel">
                  <option value="" selected>Choose…</option>
                  <option value="Starter">Starter</option>
                  <option value="Move-Up">Move-Up</option>
                  <option value="Luxury">Luxury</option>
                  <option value="Investor">Investor</option>
                  <option value="New Construction">New Construction</option>
                  <option value="Land">Land</option>
                  <option value="Multi-Family">Multi-Family</option>
                  <option value="Rental">Rental</option>
                </select>
              </div>

              <div class="control">
                <div class="field-label">Tone</div>
                <select id="toneSel">
                  <option value="" selected>Choose…</option>
                  <option value="General">General</option>
                  <option value="Warm">Warm</option>
                  <option value="Modern">Modern</option>
                  <option value="Luxury">Luxury</option>
                  <option value="Concise">Concise</option>
                </select>
              </div>

              <div class="control">
                <div class="field-label">Length</div>
                <select id="lenSel">
                  <option value="" selected>Choose…</option>
                  <option value="Short">Short</option>
                  <option value="Standard">Standard</option>
                  <option value="Long">Long</option>
                </select>
              </div>

              <div class="control">
                <div class="field-label">City</div>
                <input id="cityInp" type="text" placeholder="City" />
              </div>

              <div class="control">
                <div class="field-label">State</div>
                <select id="stateSel">
                  <option value="" selected>ST</option>
                  <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option>
                  <option>CO</option><option>CT</option><option>DE</option><option>FL</option><option>GA</option>
                  <option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option>
                  <option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option>
                  <option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option>
                  <option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option>
                  <option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option>
                  <option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option>
                  <option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option>
                  <option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
                </select>
              </div>

            </div>

            <div class="controls-row controls-row-compact">
              <div class="control">
                <div class="field-label">Beds</div>
                <select id="bedsSel">
                  <option value="" selected>—</option>
                  <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                  <option>6</option><option>7</option><option>8+</option>
                </select>
              </div>

              <div class="control">
                <div class="field-label">Baths</div>
                <select id="bathsSel">
                  <option value="" selected>—</option>
                  <option>1</option><option>1.5</option><option>2</option><option>2.5</option>
                  <option>3</option><option>3.5</option><option>4+</option>
                </select>
              </div>

              <div class="control">
                <div class="field-label">Sqft</div>
                <input id="sqftInp" type="text" placeholder="e.g. 1800" />
              </div>

              <div class="control">
                <div class="field-label">Price</div>
                <input id="priceInp" type="text" placeholder="for context only" />
              </div>

              <div class="control">
                <div class="field-label">Pool</div>
                <select id="poolSel">
                  <option value="" selected>—</option>
                  <option value="No">No</option>
                  <option value="Yes">Yes</option>
                </select>
              </div>

              <div class="control">
                <div class="field-label">Porch</div>
                <select id="porchSel">
                  <option value="" selected>—</option>
                  <option value="No">No</option>
                  <option value="Yes">Yes</option>
                </select>
              </div>
            </div>

            <div class="controls-row">
              <label class="control control-full">
                <div class="field-label" style="font-size:12px; font-weight:700; color:rgba(15,23,42,.85); margin-bottom:8px; letter-spacing:-0.01em;">Most Compelling Feature</div>
                <input id="compellingInp" class="big-input" type="text" placeholder="Location, design, lifestyle, value, etc." />
              </label>
            </div>

          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="Add upgrades, finishes, neighborhood notes, disclosures, HOA details, or paste listing data here"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Local Highlights Modal -->
  <div id="localModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="localModalTitle">
      <div class="modal-head">
        <div id="localModalTitle" class="modal-title">Possible nearby highlights (optional)</div>
        <button id="localModalClose" class="modal-x" type="button" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="rgba(15,23,42,.8)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-sub">
          We found nearby places that <b>may or may not apply</b> to this listing. Select only what you know is accurate.
          <b>Nothing is added unless you choose it.</b>
        </div>

        <div id="localModalListWrap"></div>

        <div class="modal-actions">
          <button id="localModalSkip" class="btn" type="button">Keep as-is</button>
          <button id="localModalApply" class="btn primary" type="button">Update description</button>
        </div>
      </div>
    </div>
  </div>

  <!-- IMPORTANT: fully-qualified so embeds on proagentworks.com still load tool assets -->
  <script src="https://paw-tools.pages.dev/tool-shell.js"></script>

  <script>
    (function(){
      const TIPS_TEXT = `Use this to generate MLS-ready listing remarks. Add upgrades, finishes, neighborhood notes, HOA details, and any disclosures in the notes box for best results.`;

      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $length = document.getElementById("lenSel");
      const $city = document.getElementById("cityInp");
      const $state = document.getElementById("stateSel");
      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");

      const $localModal = document.getElementById("localModal");
      const $localModalTitle = document.getElementById("localModalTitle");
      const $localModalClose = document.getElementById("localModalClose");
      const $localModalSkip = document.getElementById("localModalSkip");
      const $localModalApply = document.getElementById("localModalApply");
      const $localModalListWrap = document.getElementById("localModalListWrap");

      const HIGHLIGHTS_TOKEN = "__PAW_HIGHLIGHTS__";

      let pendingHighlightsOffer = false;
      let cachedHighlights = []; // {id,label}

      // Prevent re-prompt loops: remember the last highlight list shown for the current city/state.
      let lastHighlightsKey = "";
      let lastCityStateKey = "";

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ const t = normText(v); return t ? t : ""; }

      function mapType(v){ return normText(v) || "general"; }
      function mapTone(v){ return normText(v) || "general"; }
      function mapLen(v){ return normText(v) || "standard"; }

      function cityVal(){ return normText($city.value); }
      function stateVal(){ return normText($state.value).toUpperCase(); }
      function locationVal(){
        const c = cityVal(), s = stateVal();
        if (c && s) return `${c}, ${s}`;
        return "";
      }

      function escapeHtml(str){
        return String(str || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function looksLikeDeliverableText(reply){
        const r = String(reply || "").trim();
        if (!r) return false;
        if ((r.match(/\?/g) || []).length >= 1) return false;
        if (/^(one|a couple|a few)\s+quick\s+(question|questions|clarifiers)\b/i.test(r)) return false;
        return r.length >= 240;
      }

      function coerceHighlightLabel(item){
        if (item == null) return "";
        if (typeof item === "string") return item.trim();
        if (typeof item === "number") return String(item);
        if (typeof item === "object") {
          return String(item.label || item.name || item.title || item.text || item.value || "").trim();
        }
        return String(item).trim();
      }

      function isBadHighlightLabel(label){
        const t = String(label || "").toLowerCase();
        return (
          !t ||
          /\b(minutes?|mins?|mi|miles?|km)\b/i.test(t) ||
          t.includes("json") ||
          t.includes("{") ||
          t.includes("}")
        );
      }

      function openLocalModal(highlights){
        cachedHighlights = highlights.slice(0, 6);

        // Remember what we showed so we don’t re-open the modal with the same list repeatedly.
        lastHighlightsKey = cachedHighlights.map(h => String(h.label || "").trim().toLowerCase()).join("|");
        lastCityStateKey = `${cityVal().toLowerCase()}|${stateVal().toLowerCase()}`;

        $localModalTitle.textContent = "Possible nearby highlights (optional)";

        let html = '<div class="modal-list">';
        cachedHighlights.forEach((h, idx) => {
          const id = `lh_pick_${idx}`;
          html += `
            <label class="modal-item">
              <input id="${id}" type="checkbox" />
              <span>${escapeHtml(h.label)}</span>
            </label>
          `;
        });
        html += "</div>";
        $localModalListWrap.innerHTML = html;

        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }

      function closeLocalModal(){
        $localModal.classList.remove("show");
        $localModal.setAttribute("aria-hidden", "true");
        $localModalListWrap.innerHTML = "";
      }

      function getModalSelections(){
        const selected = [];
        cachedHighlights.forEach((h, idx) => {
          const cb = document.getElementById(`lh_pick_${idx}`);
          if (cb && cb.checked) selected.push(h.label);
        });
        return selected;
      }

      async function fetchHighlightsInBackground(){
        const c = cityVal();
        const s = stateVal();
        if (!c || !s) return;
        await shell.sendExtra(HIGHLIGHTS_TOKEN, {}, { echoUser: false });
      }

      // Modal controls
      $localModalClose.addEventListener("click", closeLocalModal);
      $localModal.addEventListener("click", (e) => { if (e.target === $localModal) closeLocalModal(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLocalModal(); });
      $localModalSkip.addEventListener("click", closeLocalModal);

      // Shared tool shell
      const shell = window.PAWToolShell.init({
        toolId: "listing_description_writer",
        deliverableTitle: "Your MLS Description",
        messagesId: "messages",
        inputId: "input",
        sendId: "send",
        tipsId: "tips",
        resetId: "reset",
        tipsText: TIPS_TEXT,

        getPrefs: () => {
          return {
            listing_type: mapType($type.value),
            tone: mapTone($tone.value),
            length: mapLen($length.value),
            city: cityVal(),
            state: stateVal(),
            location: locationVal(),
            compelling_feature: normText($compelling.value),
            locked: {
              beds: normEnum($beds.value),
              baths: normEnum($baths.value),
              sqft: digitsOnly($sqft.value),
              price: digitsOnly($price.value),
              pool: normEnum($pool.value),
              porch: normEnum($porch.value),
            }
          };
        },

        getExtraPayload: (text) => {
          const base = { city: cityVal(), state: stateVal(), location: locationVal() };

          // Background highlights fetch token
          if (String(text).trim() === HIGHLIGHTS_TOKEN) {
            if (!base.city || !base.state) return base;
            return Object.assign({}, base, { phase: "highlights" });
          }

          // Normal user submit: arm the offer if we have city/state.
          // The modal is never blocking the initial generation.
          // IMPORTANT: if this submit is the “apply selected highlights” instruction, do NOT arm again.
          const t = String(text || "").trim();
          if (/^Update the MLS description above\./i.test(t) || /\bSelected highlights:\b/i.test(t)) {
            pendingHighlightsOffer = false;
            return base;
          }
          pendingHighlightsOffer = !!(base.city && base.state);

          return base;
        },

        onResponse: (data) => {
          const reply = data && typeof data.reply === "string" ? data.reply : "";

          // After the deliverable is produced, kick off background highlights fetch
          if (pendingHighlightsOffer && looksLikeDeliverableText(reply)) {
            pendingHighlightsOffer = false;
            fetchHighlightsInBackground(); // async, no block
            return; // allow shell to render deliverable
          }

          // Handle highlights response
          const highlightsRaw = data && data.local && Array.isArray(data.local.highlights) ? data.local.highlights : null;
          if (highlightsRaw && highlightsRaw.length) {
            const normalized = highlightsRaw
              .map((it, i) => ({ id: String((it && typeof it === "object" && (it.id || it.key)) ? (it.id || it.key) : (i + 1)), label: coerceHighlightLabel(it) }))
              .filter(x => x.label && !isBadHighlightLabel(x.label));

            const currentCityStateKey = `${cityVal().toLowerCase()}|${stateVal().toLowerCase()}`;
            const newKey = normalized.map(h => String(h.label || "").trim().toLowerCase()).join("|");

            // If we've already shown this exact list for this city/state, don't prompt again.
            if (newKey && newKey === lastHighlightsKey && currentCityStateKey === lastCityStateKey) {
              return { skipDefault: true };
            }

            if (normalized.length && cityVal() && stateVal()) {
              openLocalModal(normalized);
            }
            return { skipDefault: true };
          }

          // Ignore any “provide city/state or zip” prompt silently
          const lower = reply.toLowerCase();
          if (lower.includes("provide") && (lower.includes("city/state") || lower.includes("zip"))) {
            return { skipDefault: true };
          }
        }
      });

      // Apply selected highlights: send rewrite without re-triggering modal
      $localModalApply.addEventListener("click", async () => {
        const picked = getModalSelections();
        closeLocalModal();
        if (!picked.length) return;

        const instruction =
`Update the MLS description above.
Only incorporate the selected nearby highlights if the agent confirms they are accurate and if they improve specificity.
Replace generic filler lines first. Do not add fluff. Keep the overall length similar.

Selected highlights:
- ${picked.join("\n- ")}`;

        await shell.sendExtra(instruction, { phase: "write", selected_highlights: picked }, { echoUser: true });
      });

      // Reset: clear modal state memory
      document.getElementById("reset").addEventListener("click", () => {
        pendingHighlightsOffer = false;
        cachedHighlights = [];
        lastHighlightsKey = "";
        lastCityStateKey = "";
        closeLocalModal();
        try { $city.value = ""; $state.value = ""; } catch {}
        try { if (shell && shell.reset) shell.reset(); } catch {}
      });

    })();
  </script>
</body>
</html>
