<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Writer</title>

  <!--
    PAW Tool Page: Listing Writer (MLS Remarks)

    Goal:
    - Produce MLS-ready remarks quickly, with optional revision and neighborhood highlights (POIs).

    Architecture:
    - UI only (this file + paw-ui.css)
    - Shared chat + API wiring (tool-shell.js)
    - Prompting + compliance logic lives ONLY in the private Worker.

    Required IDs (tool-shell.js):
      #messages, #input, #send, #reset, #tips

    Listing-specific behaviors implemented here (frontend-only):
    - Copy last generated remarks
    - Revise last generated remarks (calls sendExtra with a revision instruction)
    - Neighborhood Highlights modal (structured POIs) that can be applied to regenerate remarks
  -->
  <link rel="stylesheet" href="/paw-ui.css">
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">
          <div class="topbar-row0">
            <div class="tool-head">
              <div class="tool-title">Listing Writer</div>
              <div class="tool-subtitle">MLS-ready remarks that sound professional and stay accurate.</div>
            </div>

            <div class="topbar-right">
              <div class="utility-pair" role="group" aria-label="Tool utilities">
                <button id="reset" class="util-btn" type="button">Reset</button>
                <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Listing inputs (kept simple; structured data improves output without “prompting”) -->
        <div class="form-grid" aria-label="Listing details">
          <div class="field span-6">
            <div class="label">City</div>
            <input id="cityInp" type="text" inputmode="text" autocomplete="address-level2" placeholder="e.g., Tampa" />
          </div>
          <div class="field span-6">
            <div class="label">State</div>
            <select id="stateSel" aria-label="State">
              <option value="">Select…</option>
              <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
              <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
              <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
              <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
              <option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
              <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
              <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
              <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
              <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
              <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
              <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
              <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
              <option value="WI">WI</option><option value="WY">WY</option>
            </select>
          </div>

          <div class="field span-4">
            <div class="label">Price</div>
            <input id="priceInp" type="text" inputmode="numeric" placeholder="e.g., 525000" />
          </div>
          <div class="field span-4">
            <div class="label">Beds</div>
            <select id="bedsSel">
              <option value="">—</option>
              <option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option>
            </select>
          </div>
          <div class="field span-4">
            <div class="label">Baths</div>
            <select id="bathsSel">
              <option value="">—</option>
              <option>1</option><option>1.5</option><option>2</option><option>2.5</option><option>3+</option>
            </select>
          </div>

          <div class="field span-4">
            <div class="label">Sq Ft</div>
            <input id="sqftInp" type="text" inputmode="numeric" placeholder="e.g., 2140" />
          </div>
          <div class="field span-4">
            <div class="label">Property Type</div>
            <select id="typeSel">
              <option value="">Select…</option>
              <option value="Single Family">Single Family</option>
              <option value="Condo">Condo</option>
              <option value="Townhome">Townhome</option>
              <option value="Multi-Family">Multi-Family</option>
              <option value="Land">Land</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="field span-4">
            <div class="label">Tone</div>
            <select id="toneSel">
              <option value="Professional">Professional</option>
              <option value="Warm">Warm</option>
              <option value="Luxury">Luxury</option>
              <option value="Punchy">Punchy</option>
            </select>
          </div>

          <div class="field span-6">
            <div class="label">Length</div>
            <select id="lenSel">
              <option value="Standard">Standard</option>
              <option value="Short">Short</option>
              <option value="Long">Long</option>
            </select>
            <div class="small-note">If your MLS has strict character limits, choose Short.</div>
          </div>

          <div class="field span-6">
            <div class="label">What makes this listing compelling?</div>
            <input id="compellingInp" type="text" placeholder="e.g., updated kitchen, big backyard, walkable to dining" />
            <div class="small-note">Optional — helps the tool lead with the strongest hooks.</div>
          </div>
        </div>

        <!-- Primary actions that make this tool feel like a tool (not generic chat) -->
        <div class="actions-row" aria-label="Listing actions">
          <div class="actions-left">
            <button id="openPoisBtn" class="btn" type="button">Neighborhood highlights</button>
            <span class="pill" id="poisPill" style="display:none;"></span>
          </div>
          <div class="actions-right">
            <button id="copyBtn" class="btn" type="button" disabled>Copy remarks</button>
            <button id="reviseBtn" class="btn" type="button" disabled>Revise</button>
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="Paste notes/MLS data or add upgrades, finishes, and must-mention details… messy is fine."></textarea>
          <button id="send" class="send" aria-label="Generate remarks" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Neighborhood Highlights (POIs) Modal -->
  <div id="localModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="localModalTitle">
      <div class="modal-head">
        <div id="localModalTitle" class="modal-title">Neighborhood Highlights</div>
        <button class="modal-close" id="localModalClose" aria-label="Close" type="button">✕</button>
      </div>

      <div class="modal-body">
        <div style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:10px;">
          Choose what fits this listing. We’ll only include what you select.
        </div>

        <div id="localModalListWrap"></div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <button id="localModalSkip" class="btn" type="button">Keep as-is</button>
          <button id="localModalApply" class="btn primary" type="button">Update remarks</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const TIPS_TEXT =
`What this tool does
• Generates MLS-ready listing remarks that are accurate, motivating, and Fair Housing–safe.

How to use it
• Fill what you can above (city/state helps)
• Paste any notes/MLS data into the big box — messy is fine
• Click “Neighborhood highlights” to add POIs without rewriting everything

Pro tip
• After generating, use Revise to tighten, shorten, or shift tone.`;

      const el = (id) => document.getElementById(id);

      const cityInp = el("cityInp");
      const stateSel = el("stateSel");
      const priceInp = el("priceInp");
      const bedsSel = el("bedsSel");
      const bathsSel = el("bathsSel");
      const sqftInp = el("sqftInp");
      const typeSel = el("typeSel");
      const toneSel = el("toneSel");
      const lenSel = el("lenSel");
      const compellingInp = el("compellingInp");

      const copyBtn = el("copyBtn");
      const reviseBtn = el("reviseBtn");
      const openPoisBtn = el("openPoisBtn");
      const poisPill = el("poisPill");

      const localModal = el("localModal");
      const localModalClose = el("localModalClose");
      const localModalSkip = el("localModalSkip");
      const localModalApply = el("localModalApply");
      const localModalListWrap = el("localModalListWrap");

      let lastRemarks = "";
      let selectedPois = [];

      const POI_OPTIONS = [
        "Top-rated schools nearby",
        "Minutes to parks & trails",
        "Easy access to dining & shopping",
        "Close to beaches / waterfront",
        "Near major commuter routes",
        "Near downtown / entertainment",
        "Near medical centers",
        "Golf & recreation nearby",
        "Nearby marinas / boating",
        "Close to airport access",
      ];

      function openModal() { localModal.setAttribute("aria-hidden", "false"); }
      function closeModal() { localModal.setAttribute("aria-hidden", "true"); }

      function renderPoiList() {
        let html = '<div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">';
        POI_OPTIONS.forEach((label, idx) => {
          const id = "poi_" + idx;
          const checked = selectedPois.includes(label);
          html += `
            <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.10); background:rgba(255,255,255,.86); border-radius:12px;">
              <input id="${id}" type="checkbox" style="margin-top:2px;" ${checked ? "checked" : ""}/>
              <span style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.35;">${label}</span>
            </label>`;
        });

        html += `
          <div style="margin-top:6px; padding:10px 12px; border:1px dashed rgba(15,23,42,.18); border-radius:12px;">
            <div style="font-size:13px; color:rgba(15,23,42,.70); margin-bottom:6px;">Add your own (optional)</div>
            <input id="poi_custom_text" type="text" placeholder="e.g., Walkable to Riverwalk & Armature Works" style="width:100%; border:1px solid rgba(15,23,42,.12); border-radius:12px; padding:10px 12px; font-size:14px;" />
          </div>
        `;

        html += "</div>";
        localModalListWrap.innerHTML = html;
      }

      function readPoiSelection() {
        const picks = [];
        POI_OPTIONS.forEach((label, idx) => {
          const box = document.getElementById("poi_" + idx);
          if (box && box.checked) picks.push(label);
        });
        const custom = document.getElementById("poi_custom_text");
        const customText = custom ? String(custom.value || "").trim() : "";
        if (customText) picks.push(customText);
        return picks;
      }

      function updatePoisPill() {
        if (!selectedPois.length) {
          poisPill.style.display = "none";
          poisPill.textContent = "";
          return;
        }
        poisPill.style.display = "inline-flex";
        poisPill.textContent = selectedPois.length + " selected";
      }

      function getPrefs() {
        return { tone: toneSel.value || "Professional", length: lenSel.value || "Standard" };
      }

      function getExtraPayload(userText) {
        return {
          city: String(cityInp.value || "").trim(),
          state: String(stateSel.value || "").trim(),
          price: String(priceInp.value || "").trim(),
          beds: String(bedsSel.value || "").trim(),
          baths: String(bathsSel.value || "").trim(),
          sqft: String(sqftInp.value || "").trim(),
          propertyType: String(typeSel.value || "").trim(),
          compelling: String(compellingInp.value || "").trim(),
          poiHighlights: selectedPois.slice(0, 12),
          notes: String(userText || "").trim()
        };
      }

      function onResponse(data) {
        try {
          if (data && typeof data.reply === "string" && data.reply.trim()) {
            lastRemarks = data.reply.trim();
            copyBtn.disabled = false;
            reviseBtn.disabled = false;
          }
        } catch (e) {}
        return { skipDefault: false };
      }

      const shell = window.PAWToolShell.init({
        toolId: "listing",
        apiEndpoint: API_ENDPOINT,
        tipsText: TIPS_TEXT,
        getPrefs,
        getExtraPayload,
        onResponse,
        sendHistoryItems: 10,
        maxHistoryItems: 20
      });

      copyBtn.addEventListener("click", async function () {
        if (!lastRemarks) return;
        try {
          await navigator.clipboard.writeText(lastRemarks);
          copyBtn.textContent = "Copied!";
          setTimeout(() => (copyBtn.textContent = "Copy remarks"), 900);
        } catch (e) {
          alert("Copy failed. Please copy from the chat bubble.");
        }
      });

      reviseBtn.addEventListener("click", async function () {
        if (!lastRemarks) return;
        const choice = prompt(
          "How should I revise the remarks?\n\nExamples:\n- Make it shorter\n- Make it more luxury\n- Make it more punchy\n- Tighten and remove fluff",
          "Make it shorter and tighter"
        );
        const instruction = String(choice || "").trim();
        if (!instruction) return;

        await shell.sendExtra(
          "Revise the listing remarks. " + instruction,
          { revision: { instruction, base: lastRemarks } }
        );
      });

      openPoisBtn.addEventListener("click", function () {
        renderPoiList();
        openModal();
      });

      localModalClose.addEventListener("click", closeModal);
      localModalSkip.addEventListener("click", closeModal);
      localModal.addEventListener("click", function (e) { if (e.target === localModal) closeModal(); });

      localModalApply.addEventListener("click", async function () {
        const picks = readPoiSelection();
        selectedPois = picks;
        updatePoisPill();
        closeModal();

        if (!picks.length) return;

        if (lastRemarks) {
          await shell.sendExtra(
            "Update the listing remarks by incorporating these neighborhood highlights (only if accurate): " + picks.join("; "),
            { poiHighlights: picks, revision: { kind: "add_pois" } },
            { echoUser: false }
          );
        }
      });
    })();
  </script>
</body>
</html>
