<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PAW • MLS Description Writer</title>

  <meta property="og:title" content="PAW • MLS Description Writer" />
  <meta property="og:description" content="Write MLS-safe listing descriptions that spark emotion and drive showings." />
  <meta property="og:image" content="./OG1200x630.png" />
  <link rel="icon" type="image/png" href="./Icon32x32.png" />

  <link rel="stylesheet" href="./paw-ui.css" />
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <img src="./Logo240x60.png" alt="ProAgent Works" />
      </div>

      <div class="topbar-actions">
        <button id="tips" class="ghost" type="button" aria-label="Tips">
          Tips
        </button>

        <button id="reset" class="ghost" type="button" aria-label="Reset">
          Reset
        </button>
      </div>
    </header>

    <main class="main">
      <section class="panel">
        <div class="panel-head">
          <h1>MLS Description Writer</h1>
          <div class="sub">Fast, emotional, compliant copy that helps buyers feel the home.</div>
        </div>

        <div class="panel-body">
          <div class="grid">
            <div class="field">
              <label for="typeSel">Property Type</label>
              <select id="typeSel">
                <option value="">Pick one</option>
                <option value="single_family">Single family</option>
                <option value="condo">Condo</option>
                <option value="townhome">Townhome</option>
                <option value="multi_family">Multi-family</option>
                <option value="land">Land</option>
                <option value="luxury">Luxury</option>
              </select>
            </div>

            <div class="field">
              <label for="toneSel">Tone</label>
              <select id="toneSel">
                <option value="">Pick one</option>
                <option value="warm">Warm + inviting</option>
                <option value="modern">Modern + clean</option>
                <option value="luxury">Luxury + elevated</option>
                <option value="playful">Playful + fun</option>
                <option value="straight">Straightforward</option>
              </select>
            </div>

            <div class="field">
              <label for="lenSel">Length</label>
              <select id="lenSel">
                <option value="">Pick one</option>
                <option value="short">Short (scroll-stopper)</option>
                <option value="standard">Standard (MLS ready)</option>
                <option value="long">Long (story + detail)</option>
              </select>
            </div>

            <div class="field">
              <label for="cityInp">City</label>
              <input id="cityInp" type="text" placeholder="e.g., Tampa" />
            </div>

            <div class="field">
              <label for="stateSel">State</label>
              <select id="stateSel">
                <option value="">Select</option>
                <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
                <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
                <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
                <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
                <option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
                <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
                <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
                <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
                <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
                <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
                <option value="WI">WI</option><option value="WY">WY</option>
              </select>
            </div>

            <div class="field">
              <label for="bedsSel">Beds</label>
              <select id="bedsSel">
                <option value="">—</option>
                <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                <option value="5">5</option><option value="6+">6+</option>
              </select>
            </div>

            <div class="field">
              <label for="bathsSel">Baths</label>
              <select id="bathsSel">
                <option value="">—</option>
                <option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option><option value="2.5">2.5</option>
                <option value="3">3</option><option value="3.5">3.5</option><option value="4+">4+</option>
              </select>
            </div>

            <div class="field">
              <label for="sqftInp">Sq Ft</label>
              <input id="sqftInp" type="text" placeholder="e.g., 2050" />
            </div>

            <div class="field">
              <label for="priceInp">Price</label>
              <input id="priceInp" type="text" placeholder="e.g., 649000" />
            </div>

            <div class="field">
              <label for="poolSel">Pool</label>
              <select id="poolSel">
                <option value="">—</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>

            <div class="field">
              <label for="porchSel">Porch / Patio</label>
              <select id="porchSel">
                <option value="">—</option>
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>

            <div class="field" style="grid-column: 1 / -1;">
              <label for="compellingInp">Most Compelling Feature</label>
              <input id="compellingInp" type="text" placeholder="e.g., lake views, vaulted ceilings, walkable downtown…" />
            </div>

            <div class="field" style="grid-column: 1 / -1;">
              <label for="input">Paste your listing details</label>
              <textarea id="input" rows="7" placeholder="Paste raw listing notes, MLS fields, or whatever you have…"></textarea>
            </div>
          </div>

          <form id="toolForm" class="actions">
            <button id="send" class="btn primary" type="submit">
              Generate MLS Description
            </button>
          </form>

          <div id="messages" class="messages" aria-live="polite"></div>
        </div>
      </section>

      <section class="panel mini">
        <div class="panel-head">
          <h2>Compliance-friendly defaults</h2>
        </div>
        <div class="panel-body">
          <ul class="bullets">
            <li>No protected-class language or steering.</li>
            <li>No “guarantees” or unverifiable claims.</li>
            <li>Clear, buyer-friendly tone without legal-sounding fluff.</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <!-- Local Highlights Modal -->
  <div id="localModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="localModalTitle">
      <div class="modal-head">
        <div id="localModalTitle" class="modal-title">Neighborhood Highlights</div>
        <button class="modal-close" id="localModalClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body">
        <div style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:10px;">
          Here are some common neighborhood highlights. Choose what fits this listing, or add your own.
          <b>Nothing is added unless you choose it.</b>
        </div>

        <div id="localModalList" class="chips"></div>

        <div style="margin-top:10px;">
          <label style="display:block; font-size:12px; color:rgba(15,23,42,.7); margin-bottom:6px;">Add your own</label>
          <input id="localModalCustom" type="text" placeholder="e.g., walkable coffee shops, top-rated parks…" />
        </div>
      </div>
      <div class="modal-foot" style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="localModalSkip" class="btn" type="button">Keep as-is</button>
        <button id="localModalApply" class="btn primary" type="button">Update description</button>
      </div>
    </div>
  </div>

  <!-- Resume Draft Modal (Listing tool) -->
  <div id="resumeModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="resumeModalTitle">
      <div class="modal-head">
        <div id="resumeModalTitle" class="modal-title">Resume your draft?</div>
        <button class="modal-close" id="resumeModalClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body" id="resumeModalBody"></div>
      <div class="modal-foot" style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="resumeModalFresh" class="btn" type="button">Start fresh</button>
        <button id="resumeModalResume" class="btn primary" type="button">Resume</button>
      </div>
    </div>
  </div>

  <script src="./tool-shell.js"></script>
  <script>
    (function () {
      "use strict";

      // IMPORTANT: AI logic is in the Worker. This page only builds context/prefs and calls the shell.
      const API_ENDPOINT = "/api/ask"; // Cloudflare Worker route (your tooling likely rewrites this)
      const TIPS_TEXT =
        "Tip: Paste whatever you have. PAW will turn messy notes into a clean MLS-ready description.";

      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $len  = document.getElementById("lenSel");
      const $city = document.getElementById("cityInp");
      const $state = document.getElementById("stateSel");

      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");
      const $input = document.getElementById("input");

      // Local highlights modal wiring
      const $localModal = document.getElementById("localModal");
      const $localModalList = document.getElementById("localModalList");
      const $localModalCustom = document.getElementById("localModalCustom");
      const $localModalClose = document.getElementById("localModalClose");
      const $localModalSkip = document.getElementById("localModalSkip");
      const $localModalApply = document.getElementById("localModalApply");

      function openLocalModal() {
        if (!$localModal) return;
        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }
      function closeLocalModal() {
        if (!$localModal) return;
        $localModal.classList.remove("show");
        $localModal.setAttribute("aria-hidden", "true");
      }

      if ($localModalClose) $localModalClose.addEventListener("click", closeLocalModal);

      // POI workflow state (one-time gate)
      // These are page-local. Reset MUST re-arm the one-time POI gate so it runs again for a new listing.
      let poiGateCompleted = false;
      let poiFirstDeliverableDone = false;
      let poiPendingUserText = "";
      let poiCtx = { city: "", state: "" };
      let cachedHighlights = [];
      let poiLoading = false;

      // Shell init
      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        tipsText: TIPS_TEXT,
        deliverableTitle: "Your MLS Description",
        getPrefs: () => ({
          type: $type ? $type.value : "",
          tone: $tone ? $tone.value : "",
          length: $len ? $len.value : "",
        }),
      });

      function buildContext() {
        return {
          city: $city ? $city.value : "",
          state: $state ? $state.value : "",
          beds: $beds ? $beds.value : "",
          baths: $baths ? $baths.value : "",
          sqft: $sqft ? $sqft.value : "",
          price: $price ? $price.value : "",
          pool: $pool ? $pool.value : "",
          porch: $porch ? $porch.value : "",
          compelling_feature: $compelling ? $compelling.value : "",
          selected_highlights: cachedHighlights || [],
        };
      }

      function renderHighlightsChips(list) {
        if (!$localModalList) return;
        $localModalList.innerHTML = "";
        (list || []).forEach((txt) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = "chip";
          chip.textContent = txt;
          chip.dataset.selected = "0";
          chip.addEventListener("click", () => {
            const isSel = chip.dataset.selected === "1";
            chip.dataset.selected = isSel ? "0" : "1";
            chip.classList.toggle("selected", !isSel);
          });
          $localModalList.appendChild(chip);
        });
      }

      function getPickedHighlights() {
        const selected = [];
        if ($localModalList) {
          $localModalList.querySelectorAll(".chip.selected").forEach((chip) => {
            selected.push(chip.textContent || "");
          });
        }
        const customText = ($localModalCustom && $localModalCustom.value || "").trim();
        if (customText) selected.push(customText);
        return selected;
      }

      // ------------------------------------------------------------------
      // Local draft save/restore (Listing tool)
      // Goal: help agents recover from accidental navigation/crash WITHOUT ever
      // silently mixing two different properties. We always ask before restoring.
      //
      // Storage strategy:
      // - Use localStorage (persists across refresh/close) for resilience.
      // - Wrap every access in try/catch (some browsers/iframe privacy modes block it).
      // - Never expires (per product decision). Reset deletes the draft.
      const DRAFT_KEY = `paw:listing:draft:v1:${location.pathname}`;

      function storageGet(key) {
        try { return window.localStorage.getItem(key); } catch (_) { return null; }
      }
      function storageSet(key, val) {
        try { window.localStorage.setItem(key, val); return true; } catch (_) { return false; }
      }
      function storageRemove(key) {
        try { window.localStorage.removeItem(key); } catch (_) {}
      }

      function collectDraft() {
        const form = {
          type: $type ? $type.value : "",
          tone: $tone ? $tone.value : "",
          len: $len ? $len.value : "",
          city: $city ? $city.value : "",
          state: $state ? $state.value : "",
          beds: $beds ? $beds.value : "",
          baths: $baths ? $baths.value : "",
          sqft: $sqft ? $sqft.value : "",
          price: $price ? $price.value : "",
          pool: $pool ? $pool.value : "",
          porch: $porch ? $porch.value : "",
          compelling: $compelling ? $compelling.value : "",
          input: $input ? $input.value : "",
        };

        const shellState = (shell && shell.getState) ? shell.getState() : { history: [], input: form.input };

        return {
          v: 1,
          ts: Date.now(),
          form,
          poi: {
            poiGateCompleted,
            poiFirstDeliverableDone,
            poiPendingUserText,
            poiCtx,
            cachedHighlights
          },
          shell: shellState
        };
      }

      function applyDraft(draft) {
        if (!draft || !draft.form) return;

        const f = draft.form;

        try { if ($type && typeof f.type === "string") $type.value = f.type; } catch {}
        try { if ($tone && typeof f.tone === "string") $tone.value = f.tone; } catch {}
        try { if ($len  && typeof f.len  === "string") $len.value  = f.len; } catch {}
        try { if ($city && typeof f.city === "string") $city.value = f.city; } catch {}
        try { if ($state && typeof f.state === "string") $state.value = f.state; } catch {}
        try { if ($beds && typeof f.beds === "string") $beds.value = f.beds; } catch {}
        try { if ($baths && typeof f.baths === "string") $baths.value = f.baths; } catch {}
        try { if ($sqft && typeof f.sqft === "string") $sqft.value = f.sqft; } catch {}
        try { if ($price && typeof f.price === "string") $price.value = f.price; } catch {}
        try { if ($pool && typeof f.pool === "string") $pool.value = f.pool; } catch {}
        try { if ($porch && typeof f.porch === "string") $porch.value = f.porch; } catch {}
        try { if ($compelling && typeof f.compelling === "string") $compelling.value = f.compelling; } catch {}
        try { if ($input && typeof f.input === "string") $input.value = f.input; } catch {}

        // Restore POI workflow state so we don't unexpectedly re-run the 1-time gate.
        if (draft.poi) {
          poiGateCompleted = !!draft.poi.poiGateCompleted;
          poiFirstDeliverableDone = !!draft.poi.poiFirstDeliverableDone;
          poiPendingUserText = String(draft.poi.poiPendingUserText || "");
          poiCtx = draft.poi.poiCtx || { city: "", state: "" };
          cachedHighlights = Array.isArray(draft.poi.cachedHighlights) ? draft.poi.cachedHighlights : [];
        }

        try { if (shell && shell.setState && draft.shell) shell.setState(draft.shell); } catch {}
      }

      let saveTimer = null;
      function scheduleDraftSave() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
          const draft = collectDraft();
          const payload = JSON.stringify(draft);
          storageSet(DRAFT_KEY, payload);
        }, 350);
      }

      function clearDraft() {
        storageRemove(DRAFT_KEY);
      }

      // Resume modal (separate from POI modal to avoid workflow conflicts)
      const $resumeModal = document.getElementById("resumeModal");
      const $resumeTitle = document.getElementById("resumeModalTitle");
      const $resumeBody = document.getElementById("resumeModalBody");
      const $resumeBtn = document.getElementById("resumeModalResume");
      const $freshBtn = document.getElementById("resumeModalFresh");
      const $resumeClose = document.getElementById("resumeModalClose");

      function openResumeModal(draft) {
        if (!$resumeModal) return;

        const f = (draft && draft.form) ? draft.form : {};
        const cityState = [f.city, f.state].filter(Boolean).join(", ");
        const when = draft && draft.ts ? new Date(draft.ts).toLocaleString() : "";

        if ($resumeTitle) $resumeTitle.textContent = "Resume your draft?";
        if ($resumeBody) {
          $resumeBody.innerHTML = `
            <div style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45;">
              We found a saved draft${when ? ` from <b>${when}</b>` : ""}${cityState ? ` for <b>${cityState}</b>` : ""}.
              <div style="margin-top:10px; color:rgba(15,23,42,.72);">
                Choose <b>Resume</b> to continue, or <b>Start fresh</b> to clear everything for a new property.
              </div>
            </div>
          `;
        }

        $resumeModal.classList.add("show");
        $resumeModal.setAttribute("aria-hidden", "false");

        const close = () => {
          $resumeModal.classList.remove("show");
          $resumeModal.setAttribute("aria-hidden", "true");
        };

        const onResume = () => {
          applyDraft(draft);
          close();
        };

        const onFresh = () => {
          // Start fresh also deletes the stored draft (prevents prior listing leakage).
          clearDraft();
          fullReset(true);
          close();
        };

        // Wire once per open (lightweight + safe)
        if ($resumeClose) $resumeClose.onclick = close;
        if ($resumeBtn) $resumeBtn.onclick = onResume;
        if ($freshBtn) $freshBtn.onclick = onFresh;
      }

      // Save on any meaningful change
      const autosaveEls = [$type,$tone,$len,$city,$state,$beds,$baths,$sqft,$price,$pool,$porch,$compelling,$input].filter(Boolean);
      autosaveEls.forEach(el => {
        el.addEventListener("input", scheduleDraftSave);
        el.addEventListener("change", scheduleDraftSave);
      });

      // Also save right before unload (best-effort)
      window.addEventListener("beforeunload", () => {
        try {
          const draft = collectDraft();
          storageSet(DRAFT_KEY, JSON.stringify(draft));
        } catch (_) {}
      });

      // Full reset helper: clears UI + POI state + draft.
      function fullReset(skipDraftClear) {
        // Reset = "fresh start" for a new listing.
        poiGateCompleted = false;
        poiFirstDeliverableDone = false;
        poiPendingUserText = "";
        poiCtx = { city: "", state: "" };
        cachedHighlights = [];
        poiLoading = false;

        closeLocalModal();

        // Clear all form fields/selects (no trace of the prior property)
        try { if ($type) $type.selectedIndex = 0; } catch {}
        try { if ($tone) $tone.selectedIndex = 0; } catch {}
        try { if ($len)  $len.selectedIndex = 0; } catch {}
        try { if ($city) $city.value = ""; } catch {}
        try { if ($state) $state.selectedIndex = 0; } catch {}
        try { if ($beds) $beds.selectedIndex = 0; } catch {}
        try { if ($baths) $baths.selectedIndex = 0; } catch {}
        try { if ($sqft) $sqft.value = ""; } catch {}
        try { if ($price) $price.value = ""; } catch {}
        try { if ($pool) $pool.selectedIndex = 0; } catch {}
        try { if ($porch) $porch.selectedIndex = 0; } catch {}
        try { if ($compelling) $compelling.value = ""; } catch {}
        try { if ($input) $input.value = ""; } catch {}

        // Clear shell chat + composer
        try { if (shell && shell.reset) shell.reset(); } catch {}

        if (!skipDraftClear) clearDraft();

        // Snap back to top so it *feels* like a new session
        try { window.scrollTo({ top: 0, behavior: "smooth" }); } catch {}
      }

      // On load: if a draft exists, ASK before restoring (never silent restore).
      (function maybeOfferResume() {
        const raw = storageGet(DRAFT_KEY);
        if (!raw) return;
        let draft = null;
        try { draft = JSON.parse(raw); } catch (_) { draft = null; }
        if (!draft || !draft.form) return;

        // Only prompt if there's meaningful content.
        const hasAny =
          Object.values(draft.form || {}).some(v => String(v || "").trim().length > 0) ||
          (draft.shell && Array.isArray(draft.shell.history) && draft.shell.history.length > 0);

        if (hasAny) openResumeModal(draft);
      })();

      // Main submit
      document.getElementById("toolForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        // First deliverable triggers POI gate once
        if (!poiGateCompleted) {
          poiGateCompleted = true;
          poiCtx = { city: $city ? $city.value : "", state: $state ? $state.value : "" };
          cachedHighlights = [
            "Walkable shops + dining",
            "Minutes to parks + trails",
            "Easy commuter access",
            "Near top attractions",
            "Strong community vibe",
            "Great local amenities",
          ];
          renderHighlightsChips(cachedHighlights);
          openLocalModal();

          // Store what user intended to send; POI modal will continue flow
          poiPendingUserText = ($input && $input.value || "").trim();
          return;
        }

        // Normal send
        await shell.sendExtra(
          { message: ($input && $input.value || "").trim(), context: buildContext(), echoUser: true },
          { echoUser: true }
        );
      });

      // POI modal actions
      if ($localModalSkip) {
        $localModalSkip.addEventListener("click", async () => {
          closeLocalModal();
          poiFirstDeliverableDone = true;

          // Send now, with no added highlights
          await shell.sendExtra(
            { message: poiPendingUserText || ($input && $input.value || ""), context: buildContext(), echoUser: true },
            { echoUser: true }
          );
        });
      }

      if ($localModalApply) {
        $localModalApply.addEventListener("click", async () => {
          const picked = getPickedHighlights();
          cachedHighlights = picked;

          closeLocalModal();
          poiFirstDeliverableDone = true;

          await shell.sendExtra(
            {
              message: poiPendingUserText || ($input && $input.value || ""),
              context: {
                ...buildContext(),
                city: poiCtx.city || ($city ? $city.value : ""),
                state: poiCtx.state || ($state ? $state.value : ""),
                selected_highlights: picked || []
              },
              echoUser: true
            },
            { echoUser: true }
          );
        });
      }

      // Reset
      document.getElementById("reset").addEventListener("click", () => {
        // Hard reset: clear everything for a brand-new property.
        fullReset(false);
      });

    })();
  </script>
</body>
</html>
