<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="./paw-ui.css">
  <!--
    HEADER CONTRACT (LOCKED):
    - The panel top bar (.topbar-row0) MUST NEVER include a title.
    - It only contains: subtitle (left) + Reset/Tips buttons (right).
  -->
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">

          <div class="topbar-row0">
            <div class="tool-subtitle">MLS-ready listing remarks with built-in real estate expertise.</div>

            <div class="topbar-right">
              <div class="utility-pair" role="group" aria-label="Tool utilities">
                <button id="reset" class="util-btn" type="button">Reset</button>
                <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
              </div>
            </div>
          </div>

          <div class="controls-row">

            <div class="ctl">
              <label for="typeSel">Type</label>
              <span class="select-wrap">
                <select id="typeSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="starter">Starter</option>
                  <option value="moveup">Move-Up</option>
                  <option value="luxury">Luxury</option>
                  <option value="investor">Investor</option>
                  <option value="relocation">Relocation</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="toneSel">Tone</label>
              <span class="select-wrap">
                <select id="toneSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="professional">Professional</option>
                  <option value="warm">Warm</option>
                  <option value="elevated">Elevated</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="lenSel">Length</label>
              <span class="select-wrap">
                <select id="lenSel">
                  <option value="" selected>Choose…</option>
                  <option value="standard">Standard</option>
                  <option value="short">Short</option>
                  <option value="long">Long</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="cityInp">City</label>
              <span class="input-wrap md">
                <input id="cityInp" type="text" placeholder="City" autocomplete="address-level2" />
              </span>
            </div>

            <div class="ctl">
              <label for="stateSel">State</label>
              <span class="select-wrap sm">
                <select id="stateSel" autocomplete="address-level1">
                  <option value="" selected>ST</option>
                  <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
                  <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
                  <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
                  <option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
                  <option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
                  <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                  <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
                  <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
                  <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
                  <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
                  <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                  <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
                  <option value="WI">WI</option><option value="WY">WY</option>
                </select>
              </span>
            </div>

            <div class="lock-row">
              <div class="field">
                <label for="bedsSel">Beds</label>
                <select id="bedsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                  <option value="4">4</option><option value="5+">5+</option>
                </select>
              </div>

              <div class="field">
                <label for="bathsSel">Baths</label>
                <select id="bathsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option>
                  <option value="2.5">2.5</option><option value="3+">3+</option>
                </select>
              </div>

              <div class="field">
                <label for="sqftInp">Sqft</label>
                <input id="sqftInp" type="text" placeholder="e.g. 1800" />
              </div>

              <div class="field">
                <label for="priceInp">Price</label>
                <input id="priceInp" type="text" placeholder="for context only" />
              </div>

              <div class="field">
                <label for="poolSel">Pool</label>
                <select id="poolSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="field">
                <label for="porchSel">Porch</label>
                <select id="porchSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div class="lock-row2">
              <label class="field" style="width:100%;">
                <div class="field-label" style="font-size:12px; font-weight:700; color:rgba(15,23,42,.82); margin-bottom:8px; letter-spacing:-0.01em;">Most Compelling Feature</div>
                <input id="compellingInp" class="big-input" type="text" placeholder="Location, design, lifestyle, value, etc." />
              </label>
            </div>

          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="Add upgrades, finishes, neighborhood notes, disclosures, HOA details, or paste listing data here"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Local Highlights Modal -->
  <div id="localModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="localModalTitle">
      <div class="modal-head">
        <div id="localModalTitle" class="modal-title">Neighborhood Highlights</div>
        <button class="modal-close" id="localModalClose" aria-label="Close" type="button">✕</button>
      </div>
      <div class="modal-body">
        <div style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:10px;">
          Here are some common neighborhood highlights. Choose what fits this listing, or add your own.
          <b>Nothing is added unless you choose it.</b>
        </div>
        <div id="localModalListWrap"></div>

        <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
          <button id="localModalSkip" class="btn" type="button">Keep as-is</button>
          <button id="localModalApply" class="btn primary" type="button">Update description</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const TIPS_TEXT =
`What this tool does
• Generates MLS-ready listing remarks that are accurate, motivating, and Fair Housing–safe.

How to use it
• Add any details above and/or paste notes/MLS data — messy is fine
• Include city & state when you can (helps local context)
• If something is unknown, leave it blank (or type “unknown”) and the tool will write conservatively`;

      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $len  = document.getElementById("lenSel");
      const $city = document.getElementById("cityInp");
      const $state = document.getElementById("stateSel");

      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");
      const $input = document.getElementById("input");

      // Local highlights modal elements
      const $localModal = document.getElementById("localModal");
      const $localModalClose = document.getElementById("localModalClose");
      const $localModalSkip = document.getElementById("localModalSkip");
      const $localModalApply = document.getElementById("localModalApply");
      const $localModalListWrap = document.getElementById("localModalListWrap");

      const HIGHLIGHTS_TOKEN = "__PAW_HIGHLIGHTS__";

      let cachedHighlights = []; // {id,label}
      let awaitingPoiDecision = false;
      let pendingUserText = "";

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ const t = normText(v); return t ? t : ""; }

      function mapType(v){ return normText(v) || "general"; }
      function mapTone(v){ return normText(v) || "general"; }
      function mapLen(v){ return normText(v) || "standard"; }

      function cityVal(){ return normText($city.value); }
      function stateVal(){ return normText($state.value).toUpperCase(); }
      function locationVal(){
        const c = cityVal(), s = stateVal();
        if (c && s) return `${c}, ${s}`;
        if (s) return s;
        return c;
      }

      function escapeHtml(str){
        return String(str || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }

      function coerceHighlightLabel(item){
        if (item == null) return "";
        if (typeof item === "string") return item.trim();
        if (typeof item === "object") {
          return String(item.label || item.name || item.title || item.text || item.value || "").trim();
        }
        return String(item).trim();
      }

      function isBadHighlightLabel(label){
        const t = String(label || "").toLowerCase();
        return (!t || t.includes("minute") || t.includes("miles") || t.includes("km"));
      }

      // Keep your existing curated selection logic (unchanged)
      function pickHighlightsForModal(allHighlights){
        const c = cityVal().toLowerCase();
        const majorKeywords = [
          "downtown","airport","university","college","hospital","medical","mall","museum","stadium",
          "parkway","national","state park","lake","river","historic","convention","zoo","botanical",
          "estate","resort","ski","mountain","trail","greenway"
        ];
        const localKeywords = [
          "elementary","middle","high school","school","community","neighborhood","greenway","trail",
          "park","playground","library","rec center","recreation","shopping","grocery","farmers"
        ];

        function score(label, keywords, base){
          const t = String(label||"").toLowerCase();
          let s = base || 0;
          for (const k of keywords){
            if (t.includes(k)) s += 3;
          }
          if (t.length >= 18) s += 1;
          if (t.length >= 40) s -= 1;
          if (c && t.includes(c)) s += 1;
          return s;
        }

        const items = (Array.isArray(allHighlights) ? allHighlights : []).map((h, idx) => ({
          id: h.id || String(idx+1),
          label: h.label,
          majorScore: score(h.label, majorKeywords, 0),
          localScore: score(h.label, localKeywords, 0)
        }));

        const seen = new Set();
        const deduped = [];
        for (const it of items){
          const key = String(it.label||"").trim().toLowerCase();
          if (!key || seen.has(key)) continue;
          seen.add(key);
          deduped.push(it);
        }

        const major = deduped
          .slice()
          .sort((a,b) => (b.majorScore - a.majorScore) || a.label.localeCompare(b.label))
          .slice(0,3);

        const majorSet = new Set(major.map(x => x.label.toLowerCase()));

        const locals = deduped
          .filter(x => !majorSet.has(x.label.toLowerCase()))
          .slice()
          .sort((a,b) => (b.localScore - a.localScore) || a.label.localeCompare(b.label))
          .slice(0,2);

        const picked = [...major, ...locals];
        if (picked.length < 5){
          for (const it of deduped){
            if (picked.length >= 5) break;
            if (picked.some(p => p.label.toLowerCase() === it.label.toLowerCase())) continue;
            picked.push(it);
          }
        }
        return picked.slice(0,5).map(x => ({ id: x.id, label: x.label }));
      }

      function openLocalModal(highlights){
        cachedHighlights = pickHighlightsForModal(highlights);

        let html = '<div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">';

        if (cachedHighlights.length) {
          cachedHighlights.forEach((h, idx) => {
            const id = `lh_pick_${idx}`;
            html += `
              <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
                <input id="${id}" type="checkbox" style="margin-top:2px;" />
                <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">${escapeHtml(h.label)}</span>
              </label>
            `;
          });
        }

        // Custom highlight (always available)
        html += `
          <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
            <input id="lh_custom_check" type="checkbox" style="margin-top:2px;" />
            <span style="display:flex; flex-direction:column; gap:6px; width:100%;">
              <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">Add your own highlight</span>
              <input id="lh_custom_text" type="text" placeholder="Type your own (e.g. 'Walk to Riverside Park')" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.12); border-radius:10px; font-size:14px;" />
            </span>
          </label>
        `;

        html += '</div>';
        $localModalListWrap.innerHTML = html;

        const _ct = document.getElementById("lh_custom_text");
        const _cc = document.getElementById("lh_custom_check");
        if (_ct && _cc) {
          _ct.addEventListener("input", () => { if (normText(_ct.value)) _cc.checked = true; });
        }

        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }

      function closeLocalModal(){
        $localModal.classList.remove("show");
        $localModal.setAttribute("aria-hidden", "true");
        $localModalListWrap.innerHTML = "";
      }

      function getModalSelections(){
        const selected = [];

        cachedHighlights.forEach((h, idx) => {
          const cb = document.getElementById(`lh_pick_${idx}`);
          if (cb && cb.checked) selected.push(h.label);
        });

        const customTextEl = document.getElementById("lh_custom_text");
        const customText = customTextEl ? normText(customTextEl.value) : "";
        if (customText) selected.push(customText);

        return selected;
      }

      // Modal controls
      $localModalClose.addEventListener("click", closeLocalModal);
      $localModal.addEventListener("click", (e) => { if (e.target === $localModal) closeLocalModal(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLocalModal(); });

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        tipsText: TIPS_TEXT,
        deliverableTitle: "Your MLS Description",

        getPrefs: () => ({
          listing_type: mapType($type.value),
          output_use: "MLS",
          tone: mapTone($tone.value),
          length: mapLen($len.value),
          safe_mode: true,
          ask_followups: false,

          city: cityVal(),
          state: stateVal(),
          location: locationVal(),

          compelling_feature: normText($compelling.value),

          locked: {
            beds: normEnum($beds.value),
            baths: normEnum($baths.value),
            sqft: digitsOnly($sqft.value),
            price: normText($price.value),
            pool: normEnum($pool.value),
            porch: normEnum($porch.value)
          }
        }),

        getExtraPayload: (text) => {
          const base = { city: cityVal(), state: stateVal(), location: locationVal() };

          if (String(text).trim() === HIGHLIGHTS_TOKEN) {
            if (!base.city || !base.state) return base;
            return Object.assign({}, base, { phase: "highlights" });
          }

          return base;
        },

        // KEY CHANGE: POIs are offered BEFORE writing.
        beforeSend: async (text, helpers) => {
          const t = normText(text);
          if (!t) return null;

          if (awaitingPoiDecision) return { cancel: true };

          pendingUserText = t;
          awaitingPoiDecision = true;

          // Clear input immediately for responsiveness
          if (helpers && helpers.clearComposer) helpers.clearComposer({ keepFocus: true });

          // If city/state, fetch suggestions first; else show custom-only modal
          if (cityVal() && stateVal()) {
            await helpers.sendExtra(HIGHLIGHTS_TOKEN, {}, { echoUser: false });
          } else {
            openLocalModal([]);
          }

          return { cancel: true };
        },

        onResponse: (data) => {
          const isHighlightsResponse = !!(data && data.local && Array.isArray(data.local.highlights));
          if (isHighlightsResponse) {
            const highlightsRaw = data.local.highlights || [];
            const normalized = highlightsRaw
              .map((it, i) => ({ id: String(i+1), label: coerceHighlightLabel(it) }))
              .filter(x => x.label && !isBadHighlightLabel(x.label));

            openLocalModal(normalized);
            return { skipDefault: true };
          }
        }
      });

      // Continue with NO POIs
      $localModalSkip.addEventListener("click", async () => {
        closeLocalModal();
        const text = pendingUserText;
        pendingUserText = "";
        awaitingPoiDecision = false;
        if (!text) return;
        await shell.sendExtra(text, { phase: "write", selected_highlights: [] }, { echoUser: true });
      });

      // Continue WITH POIs (can be empty; still proceed)
      $localModalApply.addEventListener("click", async () => {
        const picked = getModalSelections();
        closeLocalModal();
        const text = pendingUserText;
        pendingUserText = "";
        awaitingPoiDecision = false;
        if (!text) return;
        await shell.sendExtra(text, { phase: "write", selected_highlights: picked }, { echoUser: true });
      });

      document.getElementById("reset").addEventListener("click", () => {
        cachedHighlights = [];
        pendingUserText = "";
        awaitingPoiDecision = false;
        closeLocalModal();
        try { if (shell && shell.reset) shell.reset(); } catch (_) {}
      });

    })();
  </script>
</body>
</html>
