<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="paw-ui.css" />
</head>

<body>
  <div class="tool-wrap">
    <div class="tool-head">
      <div class="tool-brand">
        <div class="logo-mark" aria-hidden="true"></div>
        <h1>Listing Description Writer</h1>
      </div>
      <div class="tool-actions">
        <button id="reset" class="btn">Reset</button>
        <button id="tips" class="btn btn-ghost">Tips &amp; How To</button>
      </div>
    </div>

    <div class="tool-subtitle">
      MLS-ready listing remarks with built-in real estate expertise.
    </div>

    <div class="tool-card">
      <div class="tool-form-grid">
        <div class="field">
          <label>Type</label>
          <select id="type">
            <option value="" selected>Choose…</option>
            <option value="single_family">Single Family</option>
            <option value="townhome">Townhome</option>
            <option value="condo">Condo</option>
            <option value="multi_family">Multi-Family</option>
            <option value="land">Land</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="field">
          <label>Tone</label>
          <select id="tone">
            <option value="" selected>Choose…</option>
            <option value="warm">Warm</option>
            <option value="modern">Modern</option>
            <option value="luxury">Luxury</option>
            <option value="straight">Straightforward</option>
          </select>
        </div>

        <div class="field">
          <label>Length</label>
          <select id="len">
            <option value="" selected>Choose…</option>
            <option value="short">Short</option>
            <option value="medium">Medium</option>
            <option value="long">Long</option>
          </select>
        </div>

        <div class="field">
          <label>City</label>
          <input id="city" type="text" placeholder="City" />
        </div>

        <div class="field">
          <label>State</label>
          <select id="state">
            <option value="" selected>ST</option>
            <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option><option value="CA">CA</option>
            <option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option><option value="FL">FL</option><option value="GA">GA</option>
            <option value="HI">HI</option><option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option>
            <option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
            <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option><option value="MO">MO</option>
            <option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option><option value="NJ">NJ</option>
            <option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option>
            <option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
            <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option><option value="VT">VT</option>
            <option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
          </select>
        </div>

        <div class="field">
          <label>Beds</label>
          <select id="beds">
            <option value="" selected>—</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option>
          </select>
        </div>

        <div class="field">
          <label>Baths</label>
          <select id="baths">
            <option value="" selected>—</option>
            <option>1</option><option>1.5</option><option>2</option><option>2.5</option><option>3+</option>
          </select>
        </div>

        <div class="field">
          <label>Sqft</label>
          <input id="sqft" type="text" placeholder="e.g. 1800" />
        </div>

        <div class="field">
          <label>Price</label>
          <input id="price" type="text" placeholder="for context only" />
        </div>

        <div class="field">
          <label>Pool</label>
          <select id="pool">
            <option value="" selected>—</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="field">
          <label>Porch</label>
          <select id="porch">
            <option value="" selected>—</option>
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
      </div>

      <div class="field" style="margin-top:14px;">
        <label>Most Compelling Feature</label>
        <input id="feature" type="text" placeholder="Location, design, lifestyle, value, etc." />
      </div>

      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="composer">
        <textarea id="input" rows="4" placeholder="Add upgrades, finishes, neighborhood notes, disclosures, HOA details, or paste listing data here"></textarea>
        <button id="send" class="btn btn-primary" aria-label="Generate description">
          <span class="btn-icon" aria-hidden="true">↑</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Local highlights modal (existing markup preserved) -->
  <div id="localModal" class="modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-label="Nearby highlights">
      <button id="localModalClose" class="modal-close" aria-label="Close">×</button>
      <h3 style="margin:0 0 6px 0;">Optional: Add nearby highlights</h3>
      <p style="margin:0; opacity:.8;">Pick any that are accurate, or add one you know (optional). If you pick none, we’ll still write a great description.</p>

      <div id="localModalListWrap" style="margin-top:12px;"></div>

      <div style="display:flex; gap:10px; margin-top:14px;">
        <button id="localModalSkip" class="btn btn-ghost" type="button">Skip</button>
        <button id="localModalApply" class="btn btn-primary" type="button">Continue</button>
      </div>
    </div>
  </div>

  <script src="tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const TIPS_TEXT =
`How to use Listing Description Writer
• Fill any key facts you know (optional)
• Paste whatever you have (Zillow, old MLS, broker site, notes)
• Use “Most Compelling Feature” to tell the story you want emphasized
• City/State help add local flavor + nearby highlights (optional)
• Price is for context only — not included in MLS remarks`;

      const $type = document.getElementById("type");
      const $tone = document.getElementById("tone");
      const $len = document.getElementById("len");
      const $city = document.getElementById("city");
      const $state = document.getElementById("state");
      const $beds = document.getElementById("beds");
      const $baths = document.getElementById("baths");
      const $sqft = document.getElementById("sqft");
      const $price = document.getElementById("price");
      const $pool = document.getElementById("pool");
      const $porch = document.getElementById("porch");
      const $feature = document.getElementById("feature");

      // Modal elements
      const $localModal = document.getElementById("localModal");
      const $localModalClose = document.getElementById("localModalClose");
      const $localModalSkip = document.getElementById("localModalSkip");
      const $localModalApply = document.getElementById("localModalApply");
      const $localModalListWrap = document.getElementById("localModalListWrap");

      const HIGHLIGHTS_TOKEN = "__PAW_HIGHLIGHTS__";

      let cachedHighlights = []; // {id,label}
      let highlightsOfferedKey = "";
      let highlightsAppliedKey = "";
      let suppressHighlightsOfferOnce = false;

      let pendingUserText = "";
      let awaitingPoiDecision = false;

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ return String(v || "").trim(); }

      function cityVal(){ return normText($city.value); }
      function stateVal(){ return normText($state.value); }
      function locationVal(){
        const c = cityVal(), s = stateVal();
        return (c && s) ? `${c}, ${s}` : (c || s || "");
      }
      function locKey(){
        const c = cityVal().toLowerCase();
        const s = stateVal().toLowerCase();
        const k = `${c}|${s}`.trim();
        return (c && s) ? k : "";
      }

      function escapeHtml(str) {
        return String(str || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function isBadHighlightLabel(label) {
        const t = String(label || "").toLowerCase();
        if (!t) return true;
        // filter obvious junk
        if (t.includes("minute") || t.includes("mins") || t.includes("miles") || t.includes("km")) return true;
        return false;
      }

      function coerceHighlightLabel(it) {
        if (!it) return "";
        if (typeof it === "string") return it.trim();
        if (typeof it === "object") return String(it.label || it.name || it.title || "").trim();
        return "";
      }

      function pickHighlightsForModal(highlights) {
        const list = Array.isArray(highlights) ? highlights : [];
        // cap at 5
        return list.slice(0, 5);
      }

      function openLocalModal(highlights){
        cachedHighlights = pickHighlightsForModal(highlights);

        let html = '<div style="display:flex; flex-direction:column; gap:8px; margin-top:8px;">';

        if (cachedHighlights.length) {
          cachedHighlights.forEach((h, idx) => {
            const id = `lh_pick_${idx}`;
            html += `
              <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
                <input id="${id}" type="checkbox" style="margin-top:2px;" />
                <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">${escapeHtml(h.label)}</span>
              </label>
            `;
          });
        }

        // Custom highlight the agent can type in (always available)
        html += `
          <label style="display:flex; align-items:flex-start; gap:10px; padding:10px 12px; border:1px solid rgba(15,23,42,.08); background:rgba(255,255,255,.86); border-radius:12px;">
            <input id="lh_custom_check" type="checkbox" style="margin-top:2px;" />
            <span style="display:flex; flex-direction:column; gap:6px; width:100%;">
              <span style="font-size:14px; color:rgba(15,23,42,.90); line-height:1.35;">Add your own highlight</span>
              <input id="lh_custom_text" type="text" placeholder="Example: Downtown farmers market / Greenway trail / Major employer / Landmark" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.12); border-radius:10px; font-size:14px;" />
            </span>
          </label>
        `;

        html += '</div>';

        $localModalListWrap.innerHTML = html;

        const _ct = document.getElementById("lh_custom_text");
        const _cc = document.getElementById("lh_custom_check");
        if (_ct && _cc) {
          _ct.addEventListener("input", () => { if (normText(_ct.value)) _cc.checked = true; });
        }

        $localModal.classList.add("show");
        $localModal.setAttribute("aria-hidden", "false");
      }

      function closeLocalModal(){
        $localModal.classList.remove("show");
        $localModal.setAttribute("aria-hidden", "true");
      }

      function getModalSelections(){
        const selected = [];
        // Suggested picks
        cachedHighlights.forEach((h, idx) => {
          const el = document.getElementById(`lh_pick_${idx}`);
          if (el && el.checked) selected.push(h.label);
        });

        // Custom pick
        const customCheckEl = document.getElementById("lh_custom_check");
        const customTextEl = document.getElementById("lh_custom_text");
        const customText = customTextEl ? normText(customTextEl.value) : "";
        if (customText && (!customCheckEl || customCheckEl.checked)) {
          selected.push(customText);
        }
        return selected;
      }

      // Modal controls
      $localModalClose.addEventListener("click", closeLocalModal);
      $localModal.addEventListener("click", (e) => { if (e.target === $localModal) closeLocalModal(); });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLocalModal(); });

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        tipsText: TIPS_TEXT,
        deliverableTitle: "Your MLS Description",

        getPrefs: () => ({
          listing_type: ($type.value || "").trim(),
          output_use: "MLS",
          tone: ($tone.value || "").trim(),
          length: ($len.value || "").trim(),
          safe_mode: true,
          ask_followups: false,
          city: cityVal(),
          state: stateVal(),
          most_compelling_feature: normText($feature.value),
          locked: {
            beds: normEnum($beds.value),
            baths: normEnum($baths.value),
            sqft: digitsOnly($sqft.value),
            price: normText($price.value),
            pool: normEnum($pool.value),
            porch: normEnum($porch.value)
          }
        }),

        getExtraPayload: (text) => {
          const base = { city: cityVal(), state: stateVal(), location: locationVal() };

          // Background highlights fetch token
          if (String(text).trim() === HIGHLIGHTS_TOKEN) {
            if (!base.city || !base.state) return base;
            return Object.assign({}, base, { phase: "highlights" });
          }

          // Normal user submit: no side effects here (POI modal happens pre-write via beforeSend)
          return base;
        },

        // Intercept submit so POIs are gathered BEFORE writing.
        beforeSend: async (text, helpers) => {
          const t = normText(text);
          if (!t) return null;

          // Prevent double-submits while waiting on the modal decision.
          if (awaitingPoiDecision) return { handled: true };

          pendingUserText = t;
          awaitingPoiDecision = true;
          highlightsOfferedKey = locKey();

          // Clear composer immediately so the UI feels responsive.
          try { document.getElementById("input").value = ""; } catch (_) {}

          const c = cityVal();
          const s = stateVal();

          if (c && s) {
            // Fetch suggested highlights (optional). Modal always includes custom write-in.
            try {
              await helpers.sendExtra(HIGHLIGHTS_TOKEN, {}, { echoUser: false });
            } catch (_) {
              // If highlights call fails, still allow custom-only modal.
              openLocalModal([]);
            }
          } else {
            // No location context — offer custom-only POIs, then proceed.
            openLocalModal([]);
          }

          return { handled: true };
        },

        onResponse: (data) => {
          const isHighlightsResponse = !!(data && data.local && Array.isArray(data.local.highlights));
          if (isHighlightsResponse) {
            const highlightsRaw = data.local.highlights || [];
            const normalized = highlightsRaw
              .map((it, i) => ({ id: String(i + 1), label: coerceHighlightLabel(it) }))
              .filter(x => x.label && !isBadHighlightLabel(x.label));

            const key = locKey();
            if (awaitingPoiDecision && key && key === highlightsOfferedKey) {
              openLocalModal(normalized);
            }
            return { skipDefault: true };
          }
          // Normal replies should render normally.
          return null;
        }
      });

      $localModalSkip.addEventListener("click", async () => {
        // Skip = proceed without POIs (and without custom write-in)
        const text = pendingUserText;
        pendingUserText = "";
        awaitingPoiDecision = false;
        highlightsAppliedKey = locKey();
        suppressHighlightsOfferOnce = true;
        closeLocalModal();
        if (!text) return;
        await shell.sendExtra(text, { phase: "write", selected_highlights: [] }, { echoUser: true });
      });

      $localModalApply.addEventListener("click", async () => {
        // Continue = proceed with selected POIs (may be empty; that's OK)
        const picked = getModalSelections();
        const text = pendingUserText;
        pendingUserText = "";
        awaitingPoiDecision = false;
        highlightsAppliedKey = locKey();
        suppressHighlightsOfferOnce = true;
        closeLocalModal();
        if (!text) return;
        await shell.sendExtra(text, { phase: "write", selected_highlights: picked }, { echoUser: true });
      });

      // Reset
      document.getElementById("reset").addEventListener("click", () => {
        cachedHighlights = [];
        highlightsOfferedKey = "";
        highlightsAppliedKey = "";
        suppressHighlightsOfferOnce = false;
        pendingUserText = "";
        awaitingPoiDecision = false;
        closeLocalModal();
        try { $city.value = ""; $state.value = ""; } catch (_) {}
        try { if (shell && shell.reset) shell.reset(); } catch (_) {}
      });

    })();
  </script>
</body>
</html>
