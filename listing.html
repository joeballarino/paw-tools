<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Description Writer</title>
  <link rel="stylesheet" href="/paw-ui.css">
  <!--
    HEADER CONTRACT (LOCKED):
    - The panel top bar (.topbar-row0) MUST NEVER include a title.
    - It only contains: subtitle (left) + Reset/Tips buttons (right).
  -->
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="panel">

        <div class="panel-topbar">

          <!-- Top bar: subtitle + utilities ONLY -->
          <div class="topbar-row0">
            <div class="tool-subtitle">MLS-ready listing remarks with built-in real estate expertise.</div>

            <div class="topbar-right">
              <button id="reset" class="util-btn" type="button">Reset</button>
              <button id="tips" class="util-btn" type="button">Tips &amp; How To</button>
            </div>
          </div>

          <!-- Controls row -->
          <div class="controls-row">
            <div class="ctl">
              <label for="typeSel">Type</label>
              <span class="select-wrap">
                <select id="typeSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="starter">Starter</option>
                  <option value="moveup">Move-Up</option>
                  <option value="luxury">Luxury</option>
                  <option value="investor">Investor</option>
                  <option value="relocation">Relocation</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="toneSel">Tone</label>
              <span class="select-wrap">
                <select id="toneSel">
                  <option value="" selected>Choose…</option>
                  <option value="general">General</option>
                  <option value="professional">Professional</option>
                  <option value="warm">Warm</option>
                  <option value="elevated">Elevated</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="lenSel">Length</label>
              <span class="select-wrap">
                <select id="lenSel">
                  <option value="" selected>Choose…</option>
                  <option value="standard">Standard</option>
                  <option value="short">Short</option>
                  <option value="long">Long</option>
                </select>
              </span>
            </div>

            <div class="ctl">
              <label for="cityInp">City</label>
              <span class="input-wrap md">
                <input id="cityInp" type="text" placeholder="City" autocomplete="address-level2" />
              </span>
            </div>

            <div class="ctl">
              <label for="stateSel">State</label>
              <span class="select-wrap sm">
                <select id="stateSel" autocomplete="address-level1">
                  <option value="" selected>ST</option>
                  <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option><option value="CA">CA</option>
                  <option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option><option value="DC">DC</option><option value="FL">FL</option>
                  <option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option>
                  <option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option>
                  <option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                  <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option>
                  <option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option>
                  <option value="OH">OH</option><option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
                  <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                  <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option><option value="WI">WI</option>
                  <option value="WY">WY</option>
                </select>
              </span>
            </div>
          </div>

          <!-- Key facts area (no jargon heading) -->
          <div class="topbar-row2">

            <div class="lock-grid">
              <div class="field">
                <label for="bedsSel">Beds</label>
                <select id="bedsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5+">5+</option>
                </select>
              </div>

              <div class="field">
                <label for="bathsSel">Baths</label>
                <select id="bathsSel">
                  <option value="" selected>—</option>
                  <option value="1">1</option><option value="1.5">1.5</option><option value="2">2</option><option value="2.5">2.5</option><option value="3+">3+</option>
                </select>
              </div>

              <div class="field">
                <label for="sqftInp">Sqft</label>
                <input id="sqftInp" type="text" inputmode="numeric" placeholder="e.g. 1800" />
              </div>

              <div class="field">
                <label for="priceInp">Price</label>
                <input id="priceInp" type="text" placeholder="for context only" />
              </div>

              <div class="field">
                <label for="poolSel">Pool</label>
                <select id="poolSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>

              <div class="field">
                <label for="porchSel">Porch</label>
                <select id="porchSel">
                  <option value="" selected>—</option>
                  <option value="yes">Yes</option>
                  <option value="no">No</option>
                </select>
              </div>
            </div>

            <div class="lock-row2">
              <label class="field" style="width:100%;">
                <div class="field-label" style="font-size:12px; font-weight:700; color:rgba(15,23,42,.82); margin-bottom:6px; letter-spacing:-0.01em;">Most Compelling Feature</div>
                <input id="compellingInp" class="big-input" type="text" placeholder="Location, design, lifestyle, value, etc." />
              </label>
            </div>

            <!-- Local highlights (optional) auto-suggest -->
            <div id="localPanel" class="local-panel" aria-live="polite" style="display:none;">
              <div class="local-head">
                <div>
                  <div class="local-title">Local highlights (optional)</div>
                  <div class="local-sub">Include any of these? We’ll weave them in naturally.</div>
                </div>
                <div class="local-actions">
                  <button id="localRefresh" class="btn" type="button">Refresh</button>
                  <button id="localSkip" class="btn" type="button">Skip</button>
                  <button id="localWrite" class="btn primary" type="button">Write description</button>
                </div>
              </div>
              <ul id="localList" class="local-list"></ul>
            </div>

          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="input" placeholder="Add upgrades, finishes, neighborhood notes, disclosures, HOA details, or paste listing data here"></textarea>
          <button id="send" class="send" aria-label="Send" type="button">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M12 5l7 7-1.4 1.4L13 8.8V20h-2V8.8L6.4 13.4 5 12l7-7z" fill="currentColor"/>
            </svg>
          </button>
        </div>

      </div>
    </div>
  </div>

  <script src="/tool-shell.js"></script>

  <script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const $type = document.getElementById("typeSel");
      const $tone = document.getElementById("toneSel");
      const $len  = document.getElementById("lenSel");
      const $city = document.getElementById("cityInp");
      const $state = document.getElementById("stateSel");

      const $beds = document.getElementById("bedsSel");
      const $baths = document.getElementById("bathsSel");
      const $sqft = document.getElementById("sqftInp");
      const $price = document.getElementById("priceInp");
      const $pool = document.getElementById("poolSel");
      const $porch = document.getElementById("porchSel");
      const $compelling = document.getElementById("compellingInp");

      const $localPanel = document.getElementById("localPanel");
      const $localList = document.getElementById("localList");
      const $localWrite = document.getElementById("localWrite");
      const $localSkip = document.getElementById("localSkip");
      const $localRefresh = document.getElementById("localRefresh");

      const $input = document.getElementById("input");

      let lastHighlights = []; // [{id,label}]
      const HIGHLIGHTS_TOKEN = "__PAW_HIGHLIGHTS__";

      const TIPS_TEXT =
`What this tool does
• Generates MLS-ready listing remarks that are accurate, motivating, and Fair Housing–safe.

How to use it
• Add any details above and/or paste notes/MLS data — messy is fine
• Include city & state when you can (helps local context + local highlights)
• If something is unknown, leave it blank (or type “unknown”) and the tool will write conservatively
• You can always refine the output after it generates`;

      function normText(v){ return String(v || "").trim(); }
      function digitsOnly(v){ return String(v || "").replace(/[^\d]/g, ""); }
      function normEnum(v){ const t = normText(v); return t ? t : ""; }

      function mapType(v){ return normText(v) || "general"; }
      function mapTone(v){ return normText(v) || "general"; }
      function mapLen(v){ return normText(v) || "standard"; }

      function coerceHighlightLabel(item){
        if (item == null) return "";
        if (typeof item === "string") return item;
        if (typeof item === "number") return String(item);
        if (typeof item === "object") {
          return String(item.label || item.name || item.title || item.text || item.value || "").trim() || "";
        }
        return String(item).trim();
      }

      function hideLocalPanel(){
        $localPanel.style.display = "none";
        $localList.innerHTML = "";
        lastHighlights = [];
      }

      function showLocalPanel(highlights){
        const arr = Array.isArray(highlights) ? highlights : [];
        lastHighlights = arr.map((item, i) => {
          const label = coerceHighlightLabel(item);
          const id = (item && typeof item === "object" && (item.id || item.key)) ? (item.id || item.key) : (i + 1);
          return { id: String(id), label: label };
        }).filter(x => x.label);

        if (!lastHighlights.length) { hideLocalPanel(); return; }

        $localList.innerHTML = "";
        for (const h of lastHighlights){
          const li = document.createElement("li");
          li.className = "local-item";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.id = "lh_" + String(h.id);
          cb.checked = true;

          const label = document.createElement("label");
          label.className = "txt";
          label.htmlFor = cb.id;
          label.textContent = h.label;

          li.appendChild(cb);
          li.appendChild(label);
          $localList.appendChild(li);
        }
        $localPanel.style.display = "block";
      }

      function getSelectedHighlightLabels(){
        const selected = [];
        for (const h of lastHighlights){
          const cb = document.getElementById("lh_" + String(h.id));
          if (cb && cb.checked) selected.push(String(h.label || ""));
        }
        return selected;
      }

      let hlTimer = null;
      function scheduleHighlightsFetch(){
        if (hlTimer) clearTimeout(hlTimer);
        hlTimer = setTimeout(() => {
          const c = normText($city.value);
          const s = normText($state.value);
          if (!c || !s) { hideLocalPanel(); return; }
          // background request; no user bubble
          shell.sendExtra(HIGHLIGHTS_TOKEN, {}, { echoUser: false });
        }, 450);
      }

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "listing_description_writer",
        tipsText: TIPS_TEXT,
        deliverableTitle: "Your MLS Description",

        getPrefs: () => ({
          listing_type: mapType($type.value),
          output_use: "MLS",
          tone: mapTone($tone.value),
          length: mapLen($len.value),
          safe_mode: true,

          // Goal: don't force. Ask only if truly needed.
          ask_followups: false,

          city: normText($city.value),
          state: normText($state.value),
          location: (normText($city.value) && normText($state.value)) ? `${normText($city.value)}, ${normText($state.value)}` : (normText($city.value) || normText($state.value) || ""),

          // Keep true when City/State exist so the Worker is aware local context is available
          local_highlights: (!!normText($city.value) && !!normText($state.value)),

          compelling_feature: normText($compelling.value),

          locked: {
            beds: normEnum($beds.value),
            baths: normEnum($baths.value),
            sqft: digitsOnly($sqft.value),
            price: normText($price.value),
            pool: normEnum($pool.value),
            porch: normEnum($porch.value)
          }
        }),

        getExtraPayload: (text) => {
          const c = normText($city.value);
          const s = normText($state.value);
          const loc = (c && s) ? `${c}, ${s}` : (c || s || "");

          // Background highlights fetch
          if (String(text).trim() === HIGHLIGHTS_TOKEN) {
            if (!c || !s) return { city: c, state: s, location: loc };
            return { phase: "highlights", city: c, state: s, location: loc };
          }

          const selected = getSelectedHighlightLabels();
          const base = { city: c, state: s, location: loc };

          // If user selected highlights, send them along with a write phase
          if (selected.length) {
            return Object.assign({}, base, { phase: "write", selected_highlights: selected });
          }

          return base;
        },

        onResponse: (data) => {
          const highlights = data && data.local && Array.isArray(data.local.highlights) ? data.local.highlights : null;
          if (highlights && highlights.length){
            showLocalPanel(highlights);
            return { skipDefault: true };
          }
        }
      });

      $localSkip.addEventListener("click", async () => {
        hideLocalPanel();
        const notes = normText($input.value) || "Write the MLS description.";
        await shell.sendExtra(notes, { phase: "write", selected_highlights: [] }, { echoUser: false });
      });

      $localWrite.addEventListener("click", async () => {
        hideLocalPanel();
        const notes = normText($input.value) || "Write the MLS description.";
        const selected = getSelectedHighlightLabels();
        await shell.sendExtra(notes, { phase: "write", selected_highlights: selected }, { echoUser: false });
      });

      // Auto-load local highlights when City + State are present
      if ($localRefresh) $localRefresh.addEventListener("click", () => scheduleHighlightsFetch());
      $city.addEventListener("input", () => scheduleHighlightsFetch());
      $state.addEventListener("change", () => scheduleHighlightsFetch());

      // Initial attempt (in case City/State are prefilled)
      scheduleHighlightsFetch();

      document.getElementById("reset").addEventListener("click", () => {
        hideLocalPanel();
        try { $city.value = ""; $state.value = ""; } catch {}
        try { if (shell && shell.reset) shell.reset(); } catch {}
      });

      hideLocalPanel();
    })();
  </script>
</body>
</html>
