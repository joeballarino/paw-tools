<!DOCTYPE html>

<html lang="en">
<head>
<!--
    PAW Embed Guard (required):
    These tool pages are built for Circle embedding.
    If someone opens this page directly (not in an iframe), redirect to proagentworks.com.
    Keep this lightweight; no dependencies.
  -->
<script>
    (function () {
      try {
        if (window.top === window.self) {
          window.location.replace("https://proagentworks.com");
        }
      } catch (e) {
        // If cross-origin framing prevents access to window.top, fail closed.
        window.location.replace("https://proagentworks.com");
      }
    })();
  </script><script>    // PAW Embed Mode Guard (Assistant)
    // -------------------------------
    // Circle provides the outer card. When embedded, we must render "flat"
    // using paw-ui.css rules that activate when html[data-embed="1"] is present.
    (function(){
      try{
        var params = new URLSearchParams(window.location.search);
        var isEmbedParam = params.get('embed') === '1';
        var isInIframe = (function(){ try{ return window.self !== window.top; } catch(e){ return true; } })();
        if(isEmbedParam || isInIframe){
          document.documentElement.setAttribute('data-embed','1');
        }
      }catch(e){}
    })();</script>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Assistant</title>
<!--
    NOTE: paw-ui.css is SHARED across tools.
    Keep header markup consistent:
    panel-topbar > topbar-row0 > tool-head + topbar-right (utility-pair).
    Changing shared classes affects multiple tools.
  -->
<link href="./paw-ui.css" rel="stylesheet"/>
<style>
  .guide-mode-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 0;
  }
  body.paw-ask .composer {
    padding-top: 12px;
  }
  .guide-mode-row .paw-seg {
    min-width: 0;
    width: 100%;
  }
  body.paw-ask .composer-main .messages {
    max-height: 260px;
    overflow-y: auto;
  }
  .guide-mode-row .paw-seg__btn {
    height: 32px;
    padding: 0 10px;
    font-size: 12px;
    font-weight: 700;
  }
  .guide-mode-row .paw-seg__btn.primary {
    background: rgba(5,195,249,.18);
    color: rgba(15,23,42,.92);
  }
  @media (max-width: 560px) {
    .guide-mode-row {
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }

    .guide-mode-row .paw-seg {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      width: 100%;
      background: transparent !important;
      border: 0 !important;
      padding: 0 !important;
      border-radius: 0 !important;
      overflow: visible !important;
    }

    .guide-mode-row .paw-seg__btn {
      flex: 1 1 calc(50% - 8px);
      width: auto;
      min-width: 0;
      border-radius: 999px;
    }
  }
</style>
</head>
<body class="paw-ask">
<div class="app">
<div class="frame">
<div class="panel">
<div class="panel-topbar">
<div class="topbar-row0">
<div class="tool-head">
<button aria-label="Work context" class="paw-mystuff-btn paw-works-btn" id="pawMyStuffBtn" type="button">
<img alt="" aria-hidden="true" class="works-paw" src="https://paw-tools.pages.dev/paw.png"/>
<span class="works-label">Work</span>
<span aria-hidden="true" class="works-chevron">▾</span>
</button>
</div>
<div class="topbar-right">
<div aria-label="Tool utilities" class="utility-pair paw-seg" role="group">
<button class="util-btn paw-seg__btn" id="reset" type="button">Reset</button>
<button class="util-btn paw-seg__btn" id="tips" type="button">Tips &amp; How To</button>
</div>
</div>
</div>
</div>
<div class="composer">
<div class="composer-main">
<div aria-label="Mode" class="guide-mode-row">
<div class="paw-seg" role="group" aria-label="Guide mode">
<button class="paw-seg__btn" data-mode="guide" type="button">PAW Guide</button>
<button class="paw-seg__btn" data-mode="coach" type="button">Coach</button>
<button class="paw-seg__btn" data-mode="tech_support" type="button">Tech Support</button>
<button class="paw-seg__btn" data-mode="general" type="button">General</button>
</div>
</div>
<div class="messages" id="messages"></div>
<textarea id="input" placeholder="e.g., Rewrite this to sound confident and friendly"></textarea>
</div>
<button aria-label="Send" class="send" id="send" type="button">
<img alt="" class="send-icon" src="https://paw-tools.pages.dev/paw.png"/>
</button>
</div>
</div>
</div>
</div>
<!-- Resume Draft Modal (Assistant tool) -->
<div aria-hidden="true" class="modal" id="pawResumeModal">
<div aria-labelledby="pawResumeTitle" aria-modal="true" class="modal-card" role="dialog">
<div class="modal-head">
<div class="modal-title" id="pawResumeTitle">Resume draft?</div>
<button aria-label="Close" class="modal-close" id="pawResumeClose" type="button">✕</button>
</div>
<div class="modal-body">
<div id="pawResumeMeta" style="font-size:14px; color:rgba(15,23,42,.86); line-height:1.45; margin-bottom:14px;">
          We found a saved draft on this device.
        </div>
<div style="display:flex; gap:10px; justify-content:flex-end;">
<button class="btn" id="pawResumeFresh" type="button">Start fresh</button>
<button class="btn primary" id="pawResumeGo" type="button">Resume</button>
</div>
</div>
</div>
</div>
<script src="https://paw-tools.pages.dev/tool-shell.js"></script>
<script>
    (function () {
      const API_ENDPOINT = "https://paw-api.joe-b40.workers.dev";

      const DISCLAIMER_TEXT =
        "Important: This assistant provides guidance intended to support your work. It is not brokerage policy guidance, legal advice, and compliance cannot be guaranteed.";

      const DISCLAIMER_TRIGGER =
        /(fair housing|mls|compliance|legal|law|attorney|contract|offer|addendum|inspection|lien|title|short sale|agency|disclosure)/i;

      const TIPS_TEXT =
`What to paste
• A question you want answered
• An email, text, or draft you want rewritten
• A situation + what you want to happen next

Best results when you include
• Who it’s for (lead, buyer, seller, past client)
• The goal (book a call, set a showing, handle an objection)
• Tone (shorter, warmer, more direct)

Examples
• “Rewrite this text to sound confident and friendly…”
• “Give me 3 replies to this objection: …”`;

      const MODE_PLACEHOLDERS = {
        guide: "Example: How do I do this in PAW, and what’s the next best step?",
        coach: "Example: Coach me on my real estate business—what should I focus on this week, and what’s my next best step?",
        tech_support: "Example: Help me troubleshoot what’s happening (device/app + what you tried).",
        general: "Example: Ask anything—draft a message, brainstorm, or rewrite text in my voice."
      };

      let selectedMode = "guide";

      function applyModeUI(){
        try {
          const buttons = document.querySelectorAll(".guide-mode-row .paw-seg__btn[data-mode]");
          buttons.forEach((btn) => {
            const mode = String(btn.getAttribute("data-mode") || "");
            btn.classList.toggle("primary", mode === selectedMode);
            btn.setAttribute("aria-pressed", mode === selectedMode ? "true" : "false");
          });
        } catch (_) {}
      }

      function applyModePlaceholder(){
        try {
          const $input = document.getElementById("input");
          if (!$input) return;
          const next = MODE_PLACEHOLDERS[selectedMode] || MODE_PLACEHOLDERS.general;
          $input.setAttribute("placeholder", next);
        } catch (_) {}
      }

      function setMode(nextMode){
        const next = MODE_PLACEHOLDERS[nextMode] ? nextMode : "general";
        selectedMode = next;
        applyModeUI();
        applyModePlaceholder();
      }

      const shell = window.PAWToolShell.init({
        apiEndpoint: API_ENDPOINT,
        toolId: "assistant",
        inputPlaceholder: "e.g., Rewrite this to sound confident and friendly",
        tipsText: TIPS_TEXT,

        // One-time compliance note (shown only when trigger words appear in the user message)
        complianceNoteText: DISCLAIMER_TEXT,
        complianceTrigger: DISCLAIMER_TRIGGER,

        sendHistoryItems: 10,
        maxHistoryItems: 20,
        deliverableMode: false
      });

      try {
        const modeButtons = document.querySelectorAll(".guide-mode-row .paw-seg__btn[data-mode]");
        modeButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const mode = String(btn.getAttribute("data-mode") || "general");
            setMode(mode);
            scheduleDraftSave();
          });
        });
      } catch (_) {}

      setMode("guide");

      // ==========================================================
      // Local Save + Resume (Assistant tool)
      // ----------------------------------------------------------
      // Same contract as Listing:
      // - localStorage only, never silent restore
      // - Reset / Start fresh deletes the draft and wipes UI
      // ==========================================================

      const DRAFT_KEY = "paw:assistant:draft:v1";

      // Draft safety caps (localStorage is limited; large pastes can exceed quotas)
      const MAX_DRAFT_INPUT_CHARS = 50000;
      const MAX_DRAFT_HISTORY_ITEMS = 30;
      const MAX_DRAFT_SHELL_INPUT_CHARS = 8000;

      function trunc(s, max){
        s = (s == null) ? "" : String(s);
        if (!max || max <= 0) return "";
        return s.length > max ? s.slice(0, max) : s;
      }


      const $resumeModal = document.getElementById("pawResumeModal");
      const $resumeClose = document.getElementById("pawResumeClose");
      const $resumeMeta = document.getElementById("pawResumeMeta");
      const $resumeFresh = document.getElementById("pawResumeFresh");
      const $resumeGo = document.getElementById("pawResumeGo");

      function storageGet(key){
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (_) { return null; }
      }
      function storageSet(key, val){
        try { localStorage.setItem(key, JSON.stringify(val)); return true; } catch (_) { return false; }
      }
      function storageDel(key){
        try { localStorage.removeItem(key); return true; } catch (_) { return false; }
      }

      let __draftSaveT = null;
      let __draftSaveFailWarned = false; // prevent repeated toasts

      function scheduleDraftSave(){
        try {
          if (__draftSaveT) clearTimeout(__draftSaveT);
          __draftSaveT = setTimeout(saveDraftNow, 350);
        } catch (_) {}
      }

      function saveDraftNow(){
        try {
          const rawShellState = (shell && shell.getState) ? shell.getState() : { history: [], input: "" };
          const st = {
            history: Array.isArray(rawShellState.history) ? rawShellState.history.slice(-MAX_DRAFT_HISTORY_ITEMS) : [],
            input: trunc(rawShellState.input, MAX_DRAFT_SHELL_INPUT_CHARS)
          };
          const hasAny = (st.input && st.input.trim()) || (Array.isArray(st.history) && st.history.length);
          if (!hasAny) { storageDel(DRAFT_KEY); return; }

          const ok = storageSet(DRAFT_KEY, {
            v: 1,
            updatedAt: new Date().toISOString(),
            toolId: "assistant",
            mode: selectedMode,
            shell: st
          });
          if (!ok && !__draftSaveFailWarned) {
            __draftSaveFailWarned = true;
            try { if (shell && shell.toast) shell.toast("Draft couldn’t be saved on this device/browser."); } catch (_) {}
          }

        } catch (_) {}
      }

      function openResumeModal(draft){
        try {
          if (!$resumeModal) return;
          const d = draft || {};
          const ts = d.updatedAt ? new Date(d.updatedAt) : null;
          const when = ts && !isNaN(ts.getTime()) ? ts.toLocaleString() : "";
          $resumeMeta.textContent = `We found a saved draft on this device.` + (when ? ` Last saved: ${when}.` : "");

          $resumeModal.classList.add("show");
          $resumeModal.setAttribute("aria-hidden", "false");
        } catch (_) {}
      }
      function closeResumeModal(){
        try {
          if (!$resumeModal) return;
          $resumeModal.classList.remove("show");
          $resumeModal.setAttribute("aria-hidden", "true");
        } catch (_) {}
      }

      function fullReset(){
        try { storageDel(DRAFT_KEY); } catch (_) {}
        closeResumeModal();
        try { if (shell && shell.reset) shell.reset(); } catch (_) {}
      }

      // Intercept Reset so we can guarantee draft deletion.
      try {
        const $reset = document.getElementById("reset");
        if ($reset) {
          $reset.addEventListener("click", (e) => {
            try { e.preventDefault(); e.stopImmediatePropagation(); } catch (_) {}
            try {
              const rawShellState = (shell && shell.getState) ? shell.getState() : { history: [], input: "" };
              const hasAny =
                (rawShellState && Array.isArray(rawShellState.history) && rawShellState.history.length) ||
                (rawShellState && typeof rawShellState.input === "string" && rawShellState.input.trim().length);
              if (hasAny) {
                const ok = window.confirm("Reset will clear this session and start fresh. Continue?");
                if (!ok) return;
              }
            } catch (_) {}
            fullReset();
          }, true);
        }
      } catch (_) {}

      // Autosave on composer input changes
      try {
        const $input = document.getElementById("input") || document.getElementById("prompt");
        if ($input) {
          $input.addEventListener("input", scheduleDraftSave);
          $input.addEventListener("change", scheduleDraftSave);
        }
      } catch (_) {}

      window.addEventListener("beforeunload", () => { try { saveDraftNow(); } catch (_) {} });

      // Resume controls
      try { if ($resumeClose) $resumeClose.addEventListener("click", () => closeResumeModal()); } catch (_) {}
      try {
        if ($resumeModal) $resumeModal.addEventListener("click", (e) => { if (e.target === $resumeModal) closeResumeModal(); });
      } catch (_) {}
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") { closeResumeModal(); } });

      try {
        if ($resumeFresh) $resumeFresh.addEventListener("click", () => {
          closeResumeModal();
          fullReset();
        });
      } catch (_) {}

      try {
        if ($resumeGo) $resumeGo.addEventListener("click", () => {
          const d = storageGet(DRAFT_KEY);
          closeResumeModal();
          if (d && typeof d.mode === "string") setMode(d.mode);
          if (d && d.shell && shell && shell.setState) shell.setState(d.shell);
        });
      } catch (_) {}

      // On load: show resume prompt (never silent restore)
      const existingDraft = storageGet(DRAFT_KEY);
      if (existingDraft) openResumeModal(existingDraft);

    })();
  </script>

  <!-- ==========================================================
       PAW Iframe Height Reporter (v1.1 - loop-safe, STANDARD)
       ----------------------------------------------------------
       PURPOSE:
       - Reports the tool's visible panel height to the Circle parent page.
       - Enables "grow-to-fit" embeds with no internal scrollbars.
       - STANDARDIZED across all tools so Work: Ready behaves identically everywhere.
       CONTRACT:
       - Sends: { type: "paw_iframe_height_request_v1", height: <number> }
       ========================================================== -->
  <script>
    (function () {
      if (window.__PAW_HEIGHT_REPORTER_V11__) return;
      window.__PAW_HEIGHT_REPORTER_V11__ = true;

      var lastSent = 0;
      var rafPending = false;
      var IGNORE_DELTA_PX = 8;

      function px(n){ n = Number(n); return isFinite(n) ? n : 0; }

      function measureContentHeight() {
        try {
          // Prefer the visible "panel" container (consistent across PAW tools)
          var panel = document.querySelector(".panel");
          if (panel && panel.getBoundingClientRect) {
            var r = panel.getBoundingClientRect();
            return Math.ceil(px(r.height));
          }

          // Fallback: sum key areas if present
          var topbar = document.querySelector(".panel-topbar");
          var messages = document.getElementById("messages") || document.querySelector(".messages");
          var composer = document.querySelector(".composer");

          var h = 0;
          if (topbar && topbar.getBoundingClientRect) h += px(topbar.getBoundingClientRect().height);
          if (messages && messages.getBoundingClientRect) h += px(messages.getBoundingClientRect().height);
          if (composer && composer.getBoundingClientRect) h += px(composer.getBoundingClientRect().height);

          if (h > 0) return Math.ceil(h);

          // Last-resort fallback (for simpler layouts)
          var d = document.documentElement;
          return Math.ceil(Math.max(px(d.scrollHeight), px(d.offsetHeight)));
        } catch (_) {
          return 0;
        }
      }

      function postHeight(force) {
        var h = measureContentHeight();
        if (!h) return;

        if (!force && Math.abs(h - lastSent) < IGNORE_DELTA_PX) return;
        lastSent = h;

        try {
          window.parent.postMessage(
            { type: "paw_iframe_height_request_v1", height: h },
            "*"
          );
        } catch (_) {}
      }

      function schedule(force) {
        if (rafPending) return;
        rafPending = true;
        requestAnimationFrame(function () {
          rafPending = false;
          postHeight(!!force);
        });
      }

      // Initial + settle passes (fonts/images/layout settle)
      schedule(true);
      setTimeout(function(){ schedule(true); }, 120);
      setTimeout(function(){ schedule(true); }, 400);

      // DOM changes (chat streaming, Work mode swap, modal open/close, etc.)
      try {
        var mo = new MutationObserver(function(){ schedule(false); });
        mo.observe(document.body, { childList:true, subtree:true, characterData:true });
      } catch (_) {}

      // Images loading after insertion
      document.addEventListener("load", function(e){
        try { if (e.target && e.target.tagName === "IMG") schedule(false); } catch (_) {}
      }, true);

      // Resize/orientation/keyboard changes
      window.addEventListener("resize", function(){ schedule(true); });
    })();
  </script>

</body>
</html>
